var PageJs=new Class.create;
PageJs.prototype=Object.extend(new BPCPageJs,{_htmlIds:{itemDiv:"",searchPanel:"",paymentPanel:"",supplierInfoPanel:"",partsTable:"",barcodeInput:""},_forceInvNo:!0,_purchaseOrder:null,setHTMLIDs:function(a,c,b,d,f,e){this._htmlIds.itemDiv=a;this._htmlIds.searchPanel=c;this._htmlIds.paymentPanel=b;this._htmlIds.supplierInfoPanel=d;this._htmlIds.partsTable=f;this._htmlIds.barcodeInput=e;return this},_getPOListPanel:function(){var a,c;a=this;return(new Element("div",{id:a._htmlIds.searchPanel,"class":"panel panel-warning search-panel"})).insert({bottom:(new Element("div",
{"class":"panel-heading form-inline"})).insert({bottom:(new Element("strong")).update("Searching for PO: ")}).insert({bottom:(new Element("span",{"class":"input-group col-sm-6"})).insert({bottom:(new Element("input",{required:!0,"class":"form-control search-txt init-focus",placeholder:"any of PO number, Supplier, Supplier Ref Number ..."})).observe("keydown",function(b){c=this;a.keydown(b,function(){c.hasClassName("search-finished")&&1===$(pageJs._htmlIds.searchPanel).getElementsBySelector(".item_row .btn").size()?
$(pageJs._htmlIds.searchPanel).down(".item_row .btn").click():($(a._htmlIds.searchPanel).down(".search-btn").click(),c.addClassName("search-finished"))},function(){$(c).removeClassName("search-finished")});return!1})}).insert({bottom:(new Element("span",{"class":"input-group-btn search-btn"})).insert({bottom:(new Element("span",{"class":" btn btn-primary"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-search"})})}).observe("click",function(){""!==$(a._htmlIds.searchPanel).down(".search-txt").value&&
a._searchPO($(a._htmlIds.searchPanel).down(".search-txt"))})})}).insert({bottom:(new Element("span",{"class":"btn btn-success pull-right btn-sm btn-danger"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-remove"})}).observe("click",function(){$(a._htmlIds.searchPanel).down(".search-txt").clear();a._searchPO($(a._htmlIds.searchPanel).down(".search-txt"))})})})},_searchPO:function(a){var c,b,d,f,e;c=this;b=$F(a).strip();d=$(a).up("#"+c._htmlIds.searchPanel);c.postAjax(c.getCallbackId("searchPO"),
{searchTxt:b},{onLoading:function(){$(d).down(".list-div")&&$(d).down(".list-div").remove();$(d).insert({bottom:(new Element("div",{"class":"panel-body"})).update(c.getLoadingImg())})},onSuccess:function(a,b){$(d).down(".panel-body").remove();try{(f=c.getResp(b,!1,!0))&&f.items&&($(d).insert({bottom:(new Element("small",{"class":"table-responsive list-div"})).insert({bottom:(new Element("table",{"class":"table table-hover table-condensed"})).insert({bottom:(new Element("thead")).insert({bottom:c._getPORow({purchaseOrderNo:"PO Number",
supplier:{name:"Supplier"},supplierRefNo:"Supplier Ref",orderDate:"Order Date",totalAmount:"Total Amount",totalProductCount:"Total Prodcut Count",status:"Status",active:"Active?"},!0)})}).insert({bottom:e=new Element("tbody")})})}),f.items.each(function(a){e.insert({bottom:c._getPORow(a)})}))}catch(k){$(d).insert({bottom:(new Element("div",{"class":"panel-body"})).update(c.getAlertBox("ERROR",k).addClassName("alert-danger"))})}}});return c},_getPORow:function(a,c){var b,d,f,e;b=this;d=c||!1;f=!0===
d?"th":"td";f=(new Element("tr",{"class":(!0===d?"item_top_row":"item_row")+(0==a.active?" danger":""),item_id:!0===d?"":a.id})).insert({bottom:(new Element(f)).insert({bottom:!0===d?"&nbsp;":(new Element("span",{"class":"btn btn-primary btn-xs"})).update("select").observe("click",function(){b.selectPO(a)})})}).insert({bottom:(new Element(f)).update(a.purchaseOrderNo)}).insert({bottom:(new Element(f)).update(a.supplier.name)}).insert({bottom:(new Element(f)).update(a.supplierRefNo)}).insert({bottom:(new Element(f)).update(a.orderDate)}).insert({bottom:(new Element(f)).update(a.totalAmount)}).insert({bottom:e=
(new Element(f)).update(a.totalProductCount)}).insert({bottom:(new Element(f)).update(a.status)}).insert({bottom:(new Element(f)).insert({bottom:!0===d?a.active:new Element("input",{type:"checkbox",disabled:!0,checked:a.active})})});!0!==d&&e.update((new Element("a",{href:"/serialnumbers.html?purchaseorderid="+a.id,target:"_BLANK"})).update("<abbr>"+e.innerHTML+"</abbr>"));return f},selectPO:function(a){var c,b,d,f,e,g;c=this;c._purchaseOrder=a;a=c._getViewOfPurchaseOrder();$(c._htmlIds.itemDiv).update(a).down("[new-order-item=product]").focus();
c._purchaseOrder.purchaseOrderItem.each(function(a){b=$$(".new-order-item-input").first();d={name:"",id:"",qty:0,barcode:""};f={product:d,btns:(new Element("span",{"class":"pull-right"})).insert({bottom:(new Element("span",{"class":"btn btn-danger btn-xs"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a);confirm("You are about to remove this entry.\n\nContinue?")&&(e=$(this).up(".item_row"),e.remove())})})};b.insert({after:g=c._getProductRow(f,
!1)});d=a.product;d.purchaseOrderItem=a.purchaseOrderItem;c._selectProduct(d,g)});return c},_getViewOfPurchaseOrder:function(){var a,c;a=this._purchaseOrder;c=a.totalAmount?a.totalAmount:0;return(new Element("div")).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-sm-9"})).update(this._getSupplierInfoPanel())}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).update(this._getPaymentPanel())})}).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",
{"class":"col-sm-12"})).update(this._getPartsTable())})}).insert({bottom:(new Element("div",{"class":"row"})).setStyle("padding: 0 15px").insert({bottom:(new Element("div",{"class":"col-sm-1"})).insert({bottom:(new Element("label",{"class":"control-label"})).update("Comment: ")})}).insert({bottom:(new Element("div",{"class":"col-sm-8"})).insert({bottom:(new Element("textarea",{"save-order":"comments",rows:4})).setStyle("width: 100%;")})}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("div")).insert({bottom:(new Element("div",
{"class":"row"})).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:(new Element("div",{"class":"col-xs-8 text-right"})).update("<strong>Total Ordered Value(Inc):</strong>")}).insert({bottom:(new Element("div",{"class":"col-xs-4"})).update(this.getCurrency(c))})}).insert({bottom:(new Element("div",{"class":"row"})).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:(new Element("div",{"class":"col-xs-8  text-right"})).update("<strong>Total Received Value(Ex):</strong>")}).insert({bottom:(new Element("div",
{"class":"col-xs-4",summary:"total-recieved-value-ex"})).update(this.getCurrency(a.totalReceivedValue))})}).insert({bottom:(new Element("div",{"class":"row"})).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:(new Element("div",{"class":"col-xs-8  text-right"})).update("<strong>Total Received Value(Inc):</strong>")}).insert({bottom:(new Element("div",{"class":"col-xs-4",summary:"total-recieved-value"})).update(this.getCurrency(1.1*a.totalReceivedValue))})})}).insert({bottom:this._saveBtns().setStyle("padding: 4px 0;")})})})},
_getSupplierInfoPanel:function(){var a,c;a=this._purchaseOrder;c=a.supplier;return(new Element("div",{"class":"panel panel-warning",id:this._htmlIds.supplierInfoPanel})).insert({bottom:(new Element("div",{"class":"panel-heading"})).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-8"})).insert({bottom:(new Element("span")).update("Receiving items for PO: ").insert({bottom:(new Element("strong")).update(a.purchaseOrderNo+" ")})})}).insert({bottom:(new Element("div",
{"class":"col-xs-4 text-right"})).insert({bottom:(new Element("span")).update("Status: ")}).insert({bottom:(new Element("strong")).update(this._purchaseOrder.status)})})})}).insert({bottom:(new Element("div",{"class":"panel-body",style:"padding: 0 10px"})).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Supplier Name:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(c.name?
c.name:"")})}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Contact Name:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(a.supplierContact?a.supplierContact:c.contactName)})}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Contact Number:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(a.supplierContactNumber?a.supplierContactNumber:
c.supplierContactNumber)})}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Contact Email:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(c.email)})})}).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Order Date:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(this._purchaseOrder.orderDate?
this.loadUTCTime(this._purchaseOrder.orderDate).toLocaleString():"")})}).insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("strong")).update("Supplier Ref Number:")}).insert({bottom:(new Element("div",{style:"padding: 2px 8px"})).update(a.supplierRefNo)})})})})},_getFormGroup:function(a,c){return(new Element("div",{"class":"form-group"})).insert({bottom:a?(new Element("label",{"class":"control-label"})).update(a):""}).insert({bottom:c.addClassName("form-control")})},
_getPaymentPanel:function(){var a,c,b;a=this._purchaseOrder;new Element("input",{disabled:!0,"class":"text-right",value:a.shippingCost?a.shippingCost:0});new Element("input",{disabled:!0,"class":"text-right",value:a.handlingCost?a.handlingCost:0});new Element("input",{disabled:!0,"class":"text-right",value:a.totalAmount?a.totalAmount:0});new Element("input",{disabled:!0,"class":"text-right",value:a.totalPaid?a.totalPaid:0});c=a.totalAmount?a.totalAmount:0;a=a.totalPaid?a.totalPaid:0;b=1*c-1*a;return(new Element("div",
{"class":"panel panel-warning",id:this._htmlIds.paymentPanel})).insert({bottom:(new Element("div",{"class":"panel-heading text-right"})).insert({bottom:(new Element("div")).insert({bottom:(new Element("strong")).update("Payment Due: ")}).insert({bottom:(new Element("span",{"class":"badge"})).update(this.getCurrency(b))})})}).insert({bottom:(new Element("div",{"class":"panel-body",style:"padding: 0 10px"})).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-7 text-right"})).update((new Element("strong")).update("Total Inc GST:"))}).insert({bottom:(new Element("div",
{"class":"col-xs-5"})).update(this.getCurrency(c))})}).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-7 text-right"})).update((new Element("strong")).update("Total Paid:"))}).insert({bottom:(new Element("div",{"class":"col-xs-5"})).update(this.getCurrency(a))})}).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-7 text-right"})).update((new Element("strong")).update("Total Due:"))}).insert({bottom:(new Element("div",
{"class":"col-xs-5"})).update(this.getCurrency(b))})})})},_getPartsTable:function(){var a,c,b;a=(new Element("div",{"class":"list-group",id:this._htmlIds.partsTable})).insert({bottom:c=this._getProductRow({product:{sku:"SKU",name:"Product Name",qty:"Qty",EANcode:"EAN code",UPCcode:"UPC code",wareLocation:"Warehouse Location"}},!0)});c.setStyle({cursor:"pointer"});c.observe("dblclick",function(a){b=!0;$$(".row.product-content-row").each(function(a){a.visible()&&(b=!1)});b?$$(".row.product-content-row").each(function(a){a.show()}):
$$(".row.product-content-row").each(function(a){a.hide()});return!1});a.insert({bottom:c=this._getNewProductRow()});return(new Element("div",{"class":"panel panel-warning"})).insert({bottom:a})},_openReceivedItemsListPage:function(a){jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/serialnumbers.html?blanklayout=1&productid="+a+"&purchaseorderid="+this._purchaseOrder.id});return this},_getProductRow:function(a,c){var b,d,f,e,g,
h,k,l,m;b=this;d=c||!1;f=(new Element("div",{"class":"form-group"})).insert({bottom:new Element("input",{"class":"form-control input-sm","save-item":"EANcode",placeholder:"EAN code",type:"text",value:a.product.codes?a.product.codes.EAN?a.product.codes.EAN:"":""})}).observe("keydown",function(a){e=$(this);b.keydown(a,function(){e.up(".product-head-row").down('[save-item="UPCcode"]').select()})}).observe("change",function(a){e=$(this);g=e.up(".item_row.list-group-item").retrieve("data");g.EANcode=$F(e.down("[save-item]"));
g.EANcode&&e.up(".item_row.list-group-item").store("data",g)}).observe("click",function(a){Event.stop(a);$(this).select()});h=(new Element("div",{"class":"form-group"})).insert({bottom:new Element("input",{"class":"form-control input-sm","save-item":"UPCcode",placeholder:"UPC code",type:"text",value:a.product.codes?a.product.codes.UPC?a.product.codes.UPC:"":""})}).observe("keydown",function(a){e=$(this);b.keydown(a,function(){e.up(".item_row").down('[save-item="wareLocation"]').select()})}).observe("change",
function(a){e=$(this);g=e.up(".item_row.list-group-item").retrieve("data");g.UPCcode=$F(e.down("[save-item]"));g.UPCcode&&e.up(".item_row.list-group-item").store("data",g)}).observe("click",function(a){Event.stop(a);$(this).select()});k=(new Element("div",{"class":"form-group"})).insert({bottom:new Element("input",{"class":"form-control input-sm","save-item":"wareLocation",placeholder:"Warehouse Location",type:"text",value:a.product.locations?a.product.warehouseLocation?a.product.warehouseLocation:
"":""})}).observe("keydown",function(a){e=$(this);b.keydown(a,function(){e.up(".item_row").down('[scanned-item="serialNo"]').select()})}).observe("change",function(a){e=$(this);g=e.up(".item_row.list-group-item").retrieve("data");g.warehouseLocation=$F(e.down("[save-item]"));g.UPCcode&&e.up(".item_row.list-group-item").store("data",g)}).observe("click",function(a){Event.stop(a);$(this).select()});!0!==b._canReceive()&&(f.down("input[save-item=EANcode]").disabled=!0,h.down("input[save-item=UPCcode]").disabled=
!0,k.down("input[save-item=wareLocation]").disabled=!0,a.btns="");d=(new Element(!0===d?"strong":"div",{"class":"item_row list-group-item",productId:a.product.id})).store("data",a.product).insert({bottom:f=(new Element("div",{"class":d?"row btn-hide-row":"row btn-hide-row product-head-row"})).insert({bottom:(new Element("span",{"class":" col-sm-2 productName"})).insert({bottom:a.product.name?a.product.name:a.product.barcode})}).insert({bottom:(new Element("span",{"class":"col-sm-1"})).insert({bottom:(new Element("a",
{href:"javascript: void(0);"})).insert({bottom:(new Element("span",{"class":"scannedQty"})).update(!0===d?"Qty":a.product.id?a.product.purchaseOrderItem?a.product.purchaseOrderItem.receivedQty:0:"")}).insert({bottom:(new Element("span",{"class":"orderedQty"})).update(a.product.purchaseOrderItem?"/"+a.product.purchaseOrderItem.qty:"")}).observe("click",function(){a.product.id&&b._purchaseOrder.id&&b._openReceivedItemsListPage(a.product.id)})})}).insert({bottom:(new Element("span",{"class":" col-sm-2 EANcode"})).update(a.product.id?
f:a.product.EANcode)}).insert({bottom:(new Element("span",{"class":" col-sm-2 UPCcode"})).update(a.product.id?h:a.product.UPCcode)}).insert({bottom:(new Element("span",{"class":" col-sm-2 wareLocation"})).update(a.product.id?k:a.product.wareLocation)}).insert({bottom:(new Element("span",{"class":"btns col-sm-1"})).update(a.btns?a.btns:"")})});f.insert({top:(new Element("span",{"class":"col-sm-2 productSku"})).update(a.product.sku?a.product.sku:"")});a.scanTable&&!0===b._canReceive()&&d.insert({bottom:(new Element("div",
{"class":"row product-content-row"})).insert({bottom:(new Element("div",{"class":"col-sm-2"})).insert({bottom:(new Element("span",{"class":"col-sm-12"})).insert({bottom:new Element("input",{type:"checkbox","class":"show-checkbox"})}).insert({bottom:(new Element("label")).update(" show input panel")})}).observe("click",function(){l=$(this).up(".row.product-content-row");m=l.down(".show-checkbox");m.checked=!m.checked;l.down(".scanTable").toggle()})}).insert({bottom:(new Element("div",{"class":"col-sm-10"})).update(a.scanTable.setStyle("display:none;"))})});
return d},_getNewProductRow:function(){var a;a={product:{name:this._getNewProductProductAutoComplete()},btns:""};a=this._getProductRow(a,!1).addClassName("new-order-item-input list-group-item-warning").removeClassName("order-item-row btn-hide-row");!0!==this._canReceive()&&a.hide();return a},_getNewProductProductAutoComplete:function(){var a,c,b;a=this;c=a._getFormGroup(null,(new Element("div",{"class":"input-group input-group-sm product-autocomplete"})).insert({bottom:(new Element("input",{id:a._htmlIds.barcodeInput,
"class":"form-control search-txt visible-xs visible-sm visible-md visible-lg","new-order-item":"product",required:"Required!",placeholder:"Enter BARCODE for products"})).observe("keydown",function(c){b=this;a.keydown(c,function(){$(b).up(".product-autocomplete").down(".search-btn").click()});a.keydown(c,function(){$(b).up(".product-autocomplete").down(".search-btn").click()},null,9);return!1})}).insert({bottom:(new Element("span",{"class":"input-group-btn"})).insert({bottom:(new Element("span",{"class":" btn btn-primary search-btn",
"data-loading-text":"searching..."})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-search"})}).observe("click",function(){a._searchProduct(this)})})}));c.down(".input-group").removeClassName("form-control");return c},_getScanTableROW:function(a,c){var b;b=!0===c?"th":"td";return(new Element("tr",{"class":!0===c?"":"scanned-item-row"})).store("data",a).insert({bottom:(new Element(b,{"class":"col-sm-1"})).update(a.qty?a.qty:"")}).insert({bottom:(new Element(b)).update(a.serialNo?
a.serialNo:"")}).insert({bottom:(new Element(b)).update(a.unitPrice?a.unitPrice:"")}).insert({bottom:(new Element(b)).update(a.invoiceNo?a.invoiceNo:"")}).insert({bottom:(new Element(b)).update(a.comments?a.comments:"")}).insert({bottom:(new Element(b,{"class":"btns"})).update(a.btns?a.btns:"")})},_updatetotalReceivedValue:function(){var a,c,b,d,f;a=this;c=a._purchaseOrder.totalReceivedValue;$$(".scanned-item-row").each(function(e){b=e.down('[scanned-item="qty"]');d=e.down('[scanned-item="unitPrice"]');
!e.hasClassName("new-scan-row")&&b&&d&&(c=1*c+a.getValueFromCurrency($F(d))*$F(b))});f=1.1*c;jQuery('[summary="total-recieved-value-ex"]').html(a.getCurrency(c)).val(a.getCurrency(c));jQuery('[summary="total-recieved-value"]').html(a.getCurrency(f)).val(a.getCurrency(f));return a},_getScanTable:function(a,c){var b,d,f,e,g,h,k,l,m,n,p;b=this;d=(new Element("a")).setStyle("cursor: pointer; text-decoration: underline; margin-left: 5px;").update("Bulk Import").observe("click",function(c){b.serialUploader=
new SerialBulkUploaderJs(b);b.showModalBox("Bulk Import Serial Numbers",f=b.serialUploader.getInputPanel());f.down(".confimBtn").observe("click",function(){$(this).up(".bulkSerialPanel").retrieve("data")&&null!==$(this).up(".bulkSerialPanel").retrieve("data").length&&jQuery("#"+b.modalId).modal("hide")});jQuery("#"+b.modalId).on("hide.bs.modal",function(b){(e=$(this).down(".bulkSerialPanel").retrieve("data"))&&0<e.length&&e.each(function(b){g=$$('.item_row[productid="'+a.id+'"]').first();g.down('[scanned-item="qty"]').setValue(b.qty);
g.down('[scanned-item="unitPrice"]').setValue(b.unitPrice);g.down('[scanned-item="serialNo"]').setValue(b.serialNo);g.down('[scanned-item="invoiceNo"]').setValue(b.invoiceNo);g.down('[scanned-item="comments"]').setValue(b.comments);g.down(".scanned-item-save-btn").click()})})});b.scanTableSerialNoTitle=(new Element("span",{"class":"scanTableSerialNoTitle"})).update("Serial No.").insert({bottom:d});d=(new Element("table",{"class":"table scanTable"})).insert({bottom:(new Element("thead")).update(b._getScanTableROW({qty:"Qty",
serialNo:b.scanTableSerialNoTitle,unitPrice:"Unit Price (Ex)",invoiceNo:"Inv. No.",comments:"Comments",btns:""},!0))}).insert({bottom:(new Element("tbody")).insert({bottom:b._getScanTableROW({qty:b._getFormGroup("",(new Element("input",{"class":"form-control input-sm","scanned-item":"qty",type:"text",placeholder:"How many you received.",required:!0,value:1,validate_currency:"Invalid qty"})).observe("keyup",function(){h=$(this).up(".scanned-item-row").down("[scanned-item=serialNo]");1<$F(this)?h.setValue("No S/N, as qty > 1").disabled=
!0:h.setValue("").disabled=!1}).observe("click",function(){$(this).select();h=$(this).up(".scanned-item-row").down("[scanned-item=serialNo]");1<$F(this)?h.setValue("No S/N, as qty > 1").disabled=!0:h.setValue("").disabled=!1}).observe("keydown",function(a){k=$(this);h=k.up(".scanned-item-row").down("[scanned-item=serialNo]");l=k.up(".scanned-item-row").down("[scanned-item=unitPrice]");b.keydown(a,function(){1<$F(k)?(h.setValue("No S/N, as qty > 1").disabled=!0,l.focus(),l.select()):(h.setValue("").disabled=
!1,h.focus(),h.select())})})),serialNo:b._getFormGroup("",new Element("input",{"class":"form-control input-sm","scanned-item":"serialNo",type:"text",placeholder:"Serial Number:",required:!0})),unitPrice:b._getFormGroup("",new Element("input",{"class":"form-control input-sm","scanned-item":"unitPrice",type:"value",placeholder:"Unit Price:",validate_currency:"Invalid currency",value:a.purchaseOrderItem?b.getValueFromCurrency(b.getCurrency(a.purchaseOrderItem.unitPrice)):""})),invoiceNo:b._getFormGroup("",
m=new Element("input",{"class":"form-control","scanned-item":"invoiceNo",type:"text",placeholder:"Inv. No.:"})),comments:b._getFormGroup("",new Element("input",{"class":"form-control input-sm","scanned-item":"comments",type:"text",placeholder:"Comments:"})),btns:(new Element("span",{"class":"btn-group btn-group-sm pull-right"})).insert({bottom:(new Element("span",{"class":"scanned-item-save-btn btn btn-primary"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-floppy-saved"})}).observe("click",
function(){b._saveScanTableRow($(this))})}).insert({bottom:(new Element("span",{"class":"scanned-item-delete-btn btn btn-default"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-floppy-remove"})}).observe("click",function(){confirm("You about to clear this entry. All input data for this entry will be lost.\n\nContinue?")&&(n=$(this).up(".scanned-item-row"),h=n.down("input[scanned-item=serialNo]"),l=n.down("input[scanned-item=unitPrice]"),m=n.down("input[scanned-item=invoiceNo]"),
p=n.down("input[scanned-item=comments]"),h.clear(),l.clear(),m.clear(),p.clear(),h.focus())})})}).addClassName("info")})});b._forceInvNo&&m.writeAttribute("required",!0);return d},_saveScanTableRow:function(a,c,b){var d,f,e,g,h,k;d=this;f=b||!1;e=a||!1;!1===e&&d.showModalBox('<p class="text-danger">Error</p>',"SerialBulkUploader (control), function _saveScanTableRow must have a btn as input");a=c||e.up(".item_row").retrieve("data");null!==a&&!1!==a&&!1!==jQuery.isNumeric(a.id)&&a.sku||d.showModalBox('<p class="text-danger">Error</p>',
"Invalid Product passed in");b=e.up(".scanned-item-row");f=!1!==f?f:d._collectFormData(b,"scanned-item");null!==f&&(g=b.clone(!0),h=(new Element("td")).insert({bottom:(new Element("span",{"class":"scanned-item-delte-btn btn btn-danger btn-xs pull-right"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-trash"})}).observe("click",function(a){confirm("You are about to remove this entry.\n\nContinue?")&&(e.up(".item_row").down(".product-head-row .scannedQty").innerHTML=1*e.up(".item_row").down(".product-head-row .scannedQty").innerHTML-
1*f.qty,e.up(".item_row").down(".product-head-row .scannedQty").innerHTML>c.purchaseOrderItem.qty||!e.up(".item_row").down(".product-head-row .scannedQty").innerHTML?e.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}):e.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"inherit"}),0==e.up(".item_row").down(".product-head-row .scannedQty").innerHTML&&e.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}),e.up(".scanned-item-row").remove())})}),
g.removeClassName("info").removeClassName("new-scan-row").addClassName("btn-hide-row"),g.down(".scanned-item-save-btn").remove(),g.down(".btns").replace(h),g.down("input[scanned-item=qty]").disable(),g.down("input[scanned-item=serialNo]").disable(),g.down("input[scanned-item=unitPrice]").observe("click",function(){e.focus();e.select()}).observe("keyup",function(){k=e;k.up(".scanned-item-row").hasClassName("new-scan-row")||d._updatetotalReceivedValue()}),b.insert({after:g}),b.down("input[scanned-item=comments]").clear(),
b.down("input[scanned-item=serialNo]").clear().disabled=!1,b.down("input[scanned-item=qty]").value=1,b.down("input[scanned-item=serialNo]").select(),e.up(".item_row").down(".scannedQty").innerHTML=1*e.up(".item_row").down(".scannedQty").innerHTML+1*f.qty,e.up(".item_row").down(".product-head-row .scannedQty").innerHTML>a.purchaseOrderItem.qty||!e.up(".item_row").down(".product-head-row .scannedQty").innerHTML?e.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}):e.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"inherit"}),
d._updatetotalReceivedValue());e.up(".scanTable").down('[scanned-item="serialNo"]').focus();e.up(".scanTable").down('[scanned-item="serialNo"]').select();return d},_searchProduct:function(a){var c,b,d,f,e,g,h,k,l,m;c=this;c._signRandID(a);b=$(a).up(".product-autocomplete").down(".search-txt");if(d=$F(b))return a=$(a).up(".new-order-item-input"),f={name:"",id:"",qty:0,barcode:d},e={product:f,btns:(new Element("span",{"class":"pull-right"})).insert({bottom:(new Element("span",{"class":"btn btn-danger btn-xs"})).insert({bottom:new Element("span",
{"class":"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a);confirm("You are about to remove this entry.\n\nContinue?")&&(g=$(this).up(".item_row"),g.remove())})})},a.insert({after:h=c._getProductRow(e,!1)}),k=c._getNewProductRow(),a.replace(k),k.down("[new-order-item=product]").focus(),jQuery("#"+c._htmlIds.barcodeInput),c.postAjax(c.getCallbackId("searchProduct"),{searchTxt:d},{onLoading:function(){jQuery("#"+c._htmlIds.barcodeInput).button("loading")},onSuccess:function(a,
f){l=new Element("div",{style:"overflow: auto; max-height: 400px;"});try{m=c.getResp(f,!1,!0);if(!m||!m.items||0===m.items.size())throw h.down(".productSku").insert({bottom:(new Element("strong",{"class":"text-danger"})).update("No Product Found!")}),h.down(".productName").insert({top:(new Element("span",{"class":""})).update("Barcode: ")}),"Nothing Found for: "+d;if(1<m.items.size())return b=k.down(".search-txt"),l=new Element("div",{style:"overflow: auto; max-height: 400px;","class":"selectProductPanel"}),
m.items.each(function(a){l.insert({bottom:c._getSearchPrductResultRow(a,b,h,k)})}),l.addClassName("list-group"),c.showModalBox("Products that has: "+d,l,!1),c;e.product=m.items[0];c._selectProduct(e.product,h,k)}catch(g){l.update(c.getAlertBox("Error: ",g).addClassName("alert-danger"))}},onComplete:function(a,b){jQuery("#"+c._htmlIds.barcodeInput).button("reset")}}),c},_selectProduct:function(a,c){var b={me:this,data:[]};b.product=a;b.lastRow=c;b.btn=$("barcode_input");b.me._signRandID(b.btn);b.data=
{product:b.product,btns:(new Element("span",{"class":"pull-right"})).insert({bottom:(new Element("span",{"class":"btn btn-danger btn-xs"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a);confirm("You are about to remove this entry.\n\nContinue?")&&(b.row=$(this).up(".item_row"),b.row.remove())})}),qty:0};b.data.scanTable=b.me._getScanTable(b.data.product,b.data);b.lastRow.replace(b.newRow=b.me._getProductRow(b.data,!1));b.me._checkProduct(b.product,
b.newRow.down(".product-head-row"));b.newRow.down('[save-item="EANcode"]').select();b.me._focusNext(b.newRow,"serialNo","unitPrice");b.me._focusNext(b.newRow,"unitPrice","invoiceNo");b.me._focusNext(b.newRow,"invoiceNo","comments");b.serialNoBox=b.newRow.down("input[scanned-item=serialNo]");b.serialNoBox&&(b.serialNoBox.observe("keydown",function(a){b.me.keydown(a,function(){$F(b.serialNoBox).blank()||$F(b.unitPriceBox).blank()||$F(b.invoiceNoBox).blank()||b.newRow.down(".scanned-item-save-btn span").click()});
return!1}),b.serialNoBox.up(".scanned-item-row").addClassName("new-scan-row"));b.unitPriceBox=b.newRow.down("input[scanned-item=unitPrice]");b.unitPriceBox&&b.unitPriceBox.observe("keydown",function(a){b.me.keydown(a,function(){$F(b.serialNoBox).blank()||$F(b.unitPriceBox).blank()||$F(b.invoiceNoBox).blank()||b.newRow.down(".scanned-item-save-btn span").click()});return!1});b.invoiceNoBox=b.newRow.down("input[scanned-item=invoiceNo]");b.invoiceNoBox&&b.invoiceNoBox.observe("keydown",function(a){b.me.keydown(a,
function(){$F(b.serialNoBox).blank()||$F(b.unitPriceBox).blank()||$F(b.invoiceNoBox).blank()||b.newRow.down(".scanned-item-save-btn span").click()});return!1});b.commentsBox=b.newRow.down("input[scanned-item=comments]");b.commentsBox&&b.commentsBox.observe("keydown",function(a){b.me.keydown(a,function(){$F(b.serialNoBox).blank()||$F(b.unitPriceBox).blank()||$F(b.invoiceNoBox).blank()||b.newRow.down(".scanned-item-save-btn span").click()});return!1});b.me._scanRowAutoSave(b.newRow);return b.me},_scanRowAutoSave:function(a){var c;
c=this;a.down('[scanned-item="comments"]')&&a.down('[scanned-item="comments"]').observe("keydown",function(b){c.keydown(b,function(){a.down(".scanned-item-save-btn").click()});return!1});return c},_focusNext:function(a,c,b){var d;d=this;a.down('[scanned-item="'+c+'"]')&&a.down('[scanned-item="'+c+'"]').observe("keydown",function(c){d.keydown(c,function(){a.down('[scanned-item="'+b+'"]').select()});return!1});return d},_checkProduct:function(a,c){var b,d,f;b=pageJs;d=$("barcode_input");b._signRandID(d);
b.postAjax(b.getCallbackId("checkProduct"),{product:a,purchaseOrder:b._purchaseOrder},{onLoading:function(a,b){jQuery("#"+d.id).button("loading")},onSuccess:function(a,d){try{f=b.getResp(d,!1,!0),0==f.count&&(c.down(".productSku").insert({bottom:(new Element("strong",{style:"color:red"})).update("  (Not found in PO)")}),c.up(".item_row").addClassName("not-in-po"))}catch(h){b.showModalBox("Error!",h,!1)}},onComplete:function(a,b){jQuery("#"+d.id).button("reset")}})},_canReceive:function(){return"RECEIVING"===
this._purchaseOrder.status||"ORDERED"===this._purchaseOrder.status},_saveBtns:function(){var a;a=this;return(new Element("span",{"class":"btn-group pull-right"})).insert({bottom:(new Element("span",{"class":"btn btn-primary","data-loading-text":"saving..."})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-ok-circle"})}).insert({bottom:(new Element("span")).update(" save ")}).observe("click",function(){a._submitOrder($(this))})}).insert({bottom:(new Element("span",{"class":"btn btn-default"})).insert({bottom:new Element("span",
{"class":"glyphicon glyphicon-remove-sign"})}).insert({bottom:(new Element("span")).update(" cancel ")}).observe("click",function(){a.showModalBox('<strong class="text-danger">Cancelling this PO receiving</strong>','<div>You are about to cancel this receiving process, all input data will be lost.</div><br /><div>Continue?</div><div><span class="btn btn-primary" onclick="window.location = document.URL;"><span class="glyphicon glyphicon-ok"></span> YES</span><span class="btn btn-default pull-right" data-dismiss="modal"><span aria-hidden="true"><span class="glyphicon glyphicon-remove-sign"></span> NO</span></span></div>',
!0)})})},_getOutStandingOrderPanel:function(a){var c,b,d;c=(new Element("div")).insert({bottom:(new Element("div")).update("There are outstanding orders that need these parts that you just recieved:")}).insert({bottom:(new Element("table",{"class":"table table-hover table-condensed"})).insert({bottom:(new Element("thead")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("th")).update("Product")}).insert({bottom:(new Element("th")).update("Received Qty")}).insert({bottom:(new Element("th")).update("Orders")})})}).insert({bottom:b=
new Element("tbody")})});a.each(function(a){d=new Element("div",{"class":"row"});a.outStandingOrders.each(function(a){d.insert({bottom:(new Element("div",{"class":"col-sm-3"})).insert({bottom:(new Element("a",{href:"/orderdetails/"+a.id+".html",target:"_BLANK"})).update(a.orderNo)})})});b.insert({bottom:(new Element("tr")).insert({bottom:(new Element("td")).update(a.product.sku)}).insert({bottom:(new Element("td")).update(a.recievedQty)}).insert({bottom:(new Element("td")).update(d)})})});return c},
_submitOrder:function(a){var c,b,d,f,e,g;c=this;b=c._collectFormData($(c._htmlIds.itemDiv),"save-order");b.purchaseOrder=c._purchaseOrder;b.products={};b.products.matched=[];b.products.notMatched=[];$(c._htmlIds.partsTable).getElementsBySelector("div.item_row").each(function(a){a.hasClassName("new-order-item-input")||(""!==a.retrieve("data").id?(d=[],a.getElementsBySelector(".table.scanTable .scanned-item-row").each(function(a){a.hasClassName("new-scan-row")||d.push(c._collectFormData(a,"scanned-item"))}),
b.products.matched.push({product:a.retrieve("data"),serial:d})):b.products.notMatched.push(a.retrieve("data")))});if(null===b)return c;if(0>=b.products.matched.size()+b.products.notMatched.size())return c.showModalBox('<strong class="text-danger">Error</strong>',"At least one item is needed!",!0),c;c._signRandID(a);c.postAjax(c.getCallbackId("saveOrder"),b,{onLoading:function(b,c){jQuery("#"+a.id).button("loading")},onSuccess:function(a,b){try{(f=c.getResp(b,!1,!0))&&f.item&&f.outStandingOrders&&
(e=(new Element("div")).update("<strong>All items saved successfully! Bill(s) generated as following:</strong>").insert({bottom:g=new Element("ul",{"class":"list-inline"})}),f.invoiceNos&&0<f.invoiceNos.size()&&f.invoiceNos.each(function(a){g.insert({bottom:(new Element("li")).update((new Element("a",{"class":"btn btn-success",href:"/bills/"+f.item.supplier.id+".html?invoiceNo="+a,target:"_BLANK"})).update(a))})}),0<f.outStandingOrders.size()&&e.insert({bottom:c._getOutStandingOrderPanel(f.outStandingOrders)}),
c.showModalBox('<strong class="text-success">Success!</strong>',e,!1,null,{"hide.bs.modal":function(){window.location=document.URL}}),c.refreshParentWindow(f.item))}catch(d){c.showModalBox("Error!",d,!1)}},onComplete:function(b,c){jQuery("#"+a.id).button("reset")}});return c},refreshParentWindow:function(a){var c,b;window.opener&&(c=window.opener,(b=$(c.document.body).down("#"+c.pageJs.resultDivId+" .item_row[item_id="+a.id+"]"))&&b.replace(c.pageJs._getResultRow(a)))},_getSearchPrductResultRow:function(a,
c,b,d){var f,e;f=this;e=d;return e=(new Element("a",{"class":"list-group-item",href:"javascript: void(0);"})).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-2"})).insert({bottom:(new Element("div",{"class":"thumbnail"})).insert({bottom:new Element("img",{"data-src":"holder.js/100%x64",alert:"Product Image",src:0===a.images.size()?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZWVlIi8+PHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzIiIHk9IjMyIiBzdHlsZT0iZmlsbDojYWFhO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1zaXplOjEycHg7Zm9udC1mYW1pbHk6QXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+NjR4NjQ8L3RleHQ+PC9zdmc+":
a.images[0].asset.url})})})}).insert({bottom:(new Element("div",{"class":"col-xs-10"})).insert({bottom:(new Element("div",{"class":"row"})).insert({bottom:(new Element("strong")).update(a.name).insert({bottom:(new Element("small",{"class":"",style:"padding-left: 10px;"})).update("SKU: "+a.sku)})}).insert({bottom:(new Element("div")).insert({bottom:(new Element("small")).update(a.shortDescription)})})})})}).observe("click",function(){$(c).up(".new-order-item-input").store("product",a);f._selectProduct(a,
b,e);jQuery("#"+f.modalId).modal("hide");$$('[scanned-item="serialNo"]').first().focus()})},init:function(a){a?this.selectPO(a):$(this._htmlIds.itemDiv).update(this._getPOListPanel()).down(".init-focus").focus()}});