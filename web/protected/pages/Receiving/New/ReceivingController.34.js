var PageJs=new Class.create;PageJs.prototype=Object.extend(new BPCPageJs,{_forceInvNo:!0,_purchaseOrder:null,_getPOListPanel:function(){var a={};return a.me=this,a.newDiv=new Element("div",{id:a.me.getHTMLID("searchPanel"),class:"panel panel-warning search-panel"}).insert({bottom:new Element("div",{class:"panel-heading form-inline"}).insert({bottom:new Element("strong").update("Searching for PO: ")}).insert({bottom:new Element("span",{class:"input-group col-sm-6"}).insert({bottom:new Element("input",{required:!0,class:"form-control search-txt init-focus",placeholder:"any of PO number, Supplier, Supplier Ref Number ..."}).observe("keydown",function(b){return a.txtBox=this,a.me.keydown(b,function(){a.txtBox.hasClassName("search-finished")&&1===$(pageJs._htmlIds.searchPanel).getElementsBySelector(".item_row .btn").size()?$(pageJs._htmlIds.searchPanel).down(".item_row .btn").click():($(a.me.getHTMLID("searchPanel")).down(".search-btn").click(),a.txtBox.addClassName("search-finished"))},function(){$(a.txtBox).removeClassName("search-finished")}),!1})}).insert({bottom:new Element("span",{class:"input-group-btn search-btn"}).insert({bottom:new Element("span",{class:" btn btn-primary"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-search"})})}).observe("click",function(){a.btn=this,""!==$(a.me.getHTMLID("searchPanel")).down(".search-txt").value&&a.me._searchPO($(a.me.getHTMLID("searchPanel")).down(".search-txt"))})})}).insert({bottom:new Element("span",{class:"btn btn-success pull-right btn-sm btn-danger"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-remove"})}).observe("click",function(){$(a.me.getHTMLID("searchPanel")).down(".search-txt").clear(),a.me._searchPO($(a.me.getHTMLID("searchPanel")).down(".search-txt"))})})}),a.newDiv},_searchPO:function(a){var b={};return b.me=this,b.searchTxt=$F(a).strip(),b.searchPanel=$(a).up("#"+b.me.getHTMLID("searchPanel")),b.me.postAjax(b.me.getCallbackId("searchPO"),{searchTxt:b.searchTxt},{onLoading:function(){$(b.searchPanel).down(".list-div")&&$(b.searchPanel).down(".list-div").remove(),$(b.searchPanel).insert({bottom:new Element("div",{class:"panel-body"}).update(b.me.getLoadingImg())})},onSuccess:function(a,c){$(b.searchPanel).down(".panel-body").remove();try{if(b.result=b.me.getResp(c,!1,!0),!b.result||!b.result.items)return;$(b.searchPanel).insert({bottom:new Element("small",{class:"table-responsive list-div"}).insert({bottom:new Element("table",{class:"table table-hover table-condensed"}).insert({bottom:new Element("thead").insert({bottom:b.me._getPORow({purchaseOrderNo:"PO Number",supplier:{name:"Supplier"},supplierRefNo:"Supplier Ref",orderDate:"Order Date",totalAmount:"Total Amount",totalProductCount:"Total Prodcut Count",status:"Status",active:"Active?"},!0)})}).insert({bottom:b.listDiv=new Element("tbody")})})}),b.result.items.each(function(a){b.listDiv.insert({bottom:b.me._getPORow(a)})})}catch(a){$(b.searchPanel).insert({bottom:new Element("div",{class:"panel-body"}).update(b.me.getAlertBox("ERROR",a).addClassName("alert-danger"))})}}}),b.me},_getPORow:function(a,b){var c={};return c.me=this,c.isTitle=b||!1,c.tag=c.isTitle===!0?"th":"td",c.newDiv=new Element("tr",{class:(c.isTitle===!0?"item_top_row":"item_row")+(0==a.active?" danger":""),item_id:c.isTitle===!0?"":a.id}).insert({bottom:new Element(c.tag).insert({bottom:c.isTitle===!0?"&nbsp;":new Element("span",{class:"btn btn-primary btn-xs"}).update("select").observe("click",function(){c.me.selectPO(a)})})}).insert({bottom:new Element(c.tag).update(a.purchaseOrderNo)}).insert({bottom:new Element(c.tag).update(a.supplier.name)}).insert({bottom:new Element(c.tag).update(a.supplierRefNo)}).insert({bottom:new Element(c.tag).update(a.orderDate)}).insert({bottom:new Element(c.tag).update(a.totalAmount)}).insert({bottom:c.totalProductCountEl=new Element(c.tag).update(a.totalProductCount)}).insert({bottom:new Element(c.tag).update(a.status)}).insert({bottom:new Element(c.tag).insert({bottom:c.isTitle===!0?a.active:new Element("input",{type:"checkbox",disabled:!0,checked:a.active})})}),c.isTitle!==!0&&c.totalProductCountEl.update(new Element("a",{href:"/serialnumbers.html?purchaseorderid="+a.id,target:"_BLANK"}).update("<abbr>"+c.totalProductCountEl.innerHTML+"</abbr>")),c.newDiv},selectPO:function(a){var b={};return b.me=this,b.me._purchaseOrder=a,b.newDiv=b.me._getViewOfPurchaseOrder(),$(b.me.getHTMLID("itemDiv")).update(b.newDiv).down("[new-order-item=product]").focus(),b.me._purchaseOrder.purchaseOrderItem.each(function(a){b.currentRow=$$(".new-order-item-input").first(),b.product={name:"",id:"",qty:0,barcode:""},b.data={product:b.product,btns:new Element("span",{class:"pull-right"}).insert({bottom:new Element("span",{class:"btn btn-danger btn-xs"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a),confirm("You are about to remove this entry.\n\nContinue?")&&(b.row=$(this).up(".item_row"),b.row.remove())})})},b.currentRow.insert({after:b.lastRow=b.me._getProductRow(b.data,!1)}),b.product=a.product,b.product.purchaseOrderItem=a.purchaseOrderItem,b.me._selectProduct(b.product,b.lastRow)}),b.me},_getViewOfPurchaseOrder:function(){var a={};return a.me=this,a.purchaseOrder=a.me._purchaseOrder,a.totalAmount=a.purchaseOrder.totalAmount?a.purchaseOrder.totalAmount:0,a.newDiv=new Element("div").insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-9"}).update(a.me._getSupplierInfoPanel())}).insert({bottom:new Element("div",{class:"col-sm-3"}).update(a.me._getPaymentPanel())})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-12"}).update(a.me._getPartsTable())})}).insert({bottom:new Element("div",{class:"row"}).setStyle("padding: 0 15px").insert({bottom:new Element("div",{class:"col-sm-1"}).insert({bottom:new Element("label",{class:"control-label"}).update("Comment: ")})}).insert({bottom:new Element("div",{class:"col-sm-8"}).insert({bottom:new Element("textarea",{"save-order":"comments",rows:4}).setStyle("width: 100%;")})}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("div").insert({bottom:new Element("div",{class:"row"}).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:new Element("div",{class:"col-xs-8 text-right"}).update("<strong>Total Ordered Value(Inc):</strong>")}).insert({bottom:new Element("div",{class:"col-xs-4"}).update(a.me.getCurrency(a.totalAmount))})}).insert({bottom:new Element("div",{class:"row"}).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:new Element("div",{class:"col-xs-8  text-right"}).update("<strong>Total Received Value(Ex):</strong>")}).insert({bottom:new Element("div",{class:"col-xs-4",summary:"total-recieved-value-ex"}).update(a.me.getCurrency(a.purchaseOrder.totalReceivedValue))})}).insert({bottom:new Element("div",{class:"row"}).setStyle("border-bottom: 1px #ccc solid; padding: 4px 0;").insert({bottom:new Element("div",{class:"col-xs-8  text-right"}).update("<strong>Total Received Value(Inc):</strong>")}).insert({bottom:new Element("div",{class:"col-xs-4",summary:"total-recieved-value"}).update(a.me.getCurrency(1.1*a.purchaseOrder.totalReceivedValue))})})}).insert({bottom:a.me._saveBtns().setStyle("padding: 4px 0;")})})}),a.newDiv},_getSupplierInfoPanel:function(){var a={};return a.me=this,a.purchaseOrder=a.me._purchaseOrder,a.supplier=a.purchaseOrder.supplier,a.newDiv=new Element("div",{class:"panel panel-warning",id:a.me.getHTMLID("supplierInfoPanel")}).insert({bottom:new Element("div",{class:"panel-heading"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-8"}).insert({bottom:new Element("span").update("Receiving items for PO: ").insert({bottom:new Element("strong").update(a.purchaseOrder.purchaseOrderNo+" ")})})}).insert({bottom:new Element("div",{class:"col-xs-4 text-right"}).insert({bottom:new Element("span").update("Status: ")}).insert({bottom:new Element("strong").update(a.me._purchaseOrder.status)})})})}).insert({bottom:new Element("div",{class:"panel-body",style:"padding: 0 10px"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Supplier Name:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.supplier.name?a.supplier.name:"")})}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Contact Name:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.purchaseOrder.supplierContact?a.purchaseOrder.supplierContact:a.supplier.contactName)})}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Contact Number:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.purchaseOrder.supplierContactNumber?a.purchaseOrder.supplierContactNumber:a.supplier.supplierContactNumber)})}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Contact Email:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.supplier.email)})})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Order Date:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.me._purchaseOrder.orderDate?a.me.loadUTCTime(a.me._purchaseOrder.orderDate).toLocaleString():"")})}).insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("strong").update("Supplier Ref Number:")}).insert({bottom:new Element("div",{style:"padding: 2px 8px"}).update(a.purchaseOrder.supplierRefNo)})})})}),a.newDiv},_getFormGroup:function(a,b){return new Element("div",{class:"form-group"}).insert({bottom:a?new Element("label",{class:"control-label"}).update(a):""}).insert({bottom:b.addClassName("form-control")})},_getPaymentPanel:function(){var a={};return a.me=this,a.purchaseOrder=a.me._purchaseOrder,a.supplier=a.purchaseOrder.supplier,a.shippingCostEl=new Element("input",{disabled:!0,class:"text-right",value:a.purchaseOrder.shippingCost?a.purchaseOrder.shippingCost:0}),a.handlingCostEl=new Element("input",{disabled:!0,class:"text-right",value:a.purchaseOrder.handlingCost?a.purchaseOrder.handlingCost:0}),a.totalAmountExGstEl=new Element("input",{disabled:!0,class:"text-right",value:a.purchaseOrder.totalAmount?a.purchaseOrder.totalAmount:0}),a.totalPaidEl=new Element("input",{disabled:!0,class:"text-right",value:a.purchaseOrder.totalPaid?a.purchaseOrder.totalPaid:0}),a.totalAmount=a.purchaseOrder.totalAmount?a.purchaseOrder.totalAmount:0,a.totalPaid=a.purchaseOrder.totalPaid?a.purchaseOrder.totalPaid:0,a.totalDue=1*a.totalAmount-1*a.totalPaid,a.newDiv=new Element("div",{class:"panel panel-warning",id:a.me.getHTMLID("paymentPanel")}).insert({bottom:new Element("div",{class:"panel-heading text-right"}).insert({bottom:new Element("div").insert({bottom:new Element("strong").update("Payment Due: ")}).insert({bottom:new Element("span",{class:"badge"}).update(a.me.getCurrency(a.totalDue))})})}).insert({bottom:new Element("div",{class:"panel-body",style:"padding: 0 10px"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-7 text-right"}).update(new Element("strong").update("Total Inc GST:"))}).insert({bottom:new Element("div",{class:"col-xs-5"}).update(a.me.getCurrency(a.totalAmount))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-7 text-right"}).update(new Element("strong").update("Total Paid:"))}).insert({bottom:new Element("div",{class:"col-xs-5"}).update(a.me.getCurrency(a.totalPaid))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-7 text-right"}).update(new Element("strong").update("Total Due:"))}).insert({bottom:new Element("div",{class:"col-xs-5"}).update(a.me.getCurrency(a.totalDue))})})}),a.newDiv},_getPartsTable:function(){var a={};return a.me=this,a.productListDiv=new Element("div",{class:"list-group",id:a.me.getHTMLID("partsTable")}).insert({bottom:a.newDiv=a.me._getProductRow({product:{sku:"SKU",name:"Product Name",qty:"Qty",EANcode:"EAN code",UPCcode:"UPC code",wareLocation:"Warehouse Location"}},!0)}),a.newDiv.setStyle({cursor:"pointer"}),a.newDiv.observe("dblclick",function(b){return a.allClosed=!0,$$(".row.product-content-row").each(function(b){b.visible()&&(a.allClosed=!1)}),a.allClosed?$$(".row.product-content-row").each(function(a){a.show()}):$$(".row.product-content-row").each(function(a){a.hide()}),!1}),a.productListDiv.insert({bottom:a.newDiv=a.me._getNewProductRow()}),new Element("div",{class:"panel panel-warning"}).insert({bottom:a.productListDiv})},_openReceivedItemsListPage:function(a){var b={};return b.me=this,jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/serialnumbers.html?blanklayout=1&productid="+a.id+"&purchaseorderid="+b.me._purchaseOrder.id+"&purchaseorderitemid="+a.purchaseOrderItem.id}),b.me},_getProductRow:function(a,b){var c={};return c.me=this,c.isTitle=b||!1,c.EANcodeEl=new Element("div",{class:"form-group"}).insert({bottom:new Element("input",{class:"form-control input-sm","save-item":"EANcode",placeholder:"EAN code",type:"text",value:a.product.codes&&a.product.codes.EAN?a.product.codes.EAN:""})}).observe("keydown",function(a){c.txtBox=$(this),c.me.keydown(a,function(){c.txtBox.up(".product-head-row").down('[save-item="UPCcode"]').select()})}).observe("change",function(a){c.txtBox=$(this),c.rowData=c.txtBox.up(".item_row.list-group-item").retrieve("data"),c.rowData.EANcode=$F(c.txtBox.down("[save-item]")),c.rowData.EANcode&&c.txtBox.up(".item_row.list-group-item").store("data",c.rowData)}).observe("click",function(a){Event.stop(a),$(this).select()}),c.UPCcodeEl=new Element("div",{class:"form-group"}).insert({bottom:new Element("input",{class:"form-control input-sm","save-item":"UPCcode",placeholder:"UPC code",type:"text",value:a.product.codes&&a.product.codes.UPC?a.product.codes.UPC:""})}).observe("keydown",function(a){c.txtBox=$(this),c.me.keydown(a,function(){c.txtBox.up(".item_row").down('[save-item="wareLocation"]').select()})}).observe("change",function(a){c.txtBox=$(this),c.rowData=c.txtBox.up(".item_row.list-group-item").retrieve("data"),c.rowData.UPCcode=$F(c.txtBox.down("[save-item]")),c.rowData.UPCcode&&c.txtBox.up(".item_row.list-group-item").store("data",c.rowData)}).observe("click",function(a){Event.stop(a),$(this).select()}),c.wareLocationEL=new Element("div",{class:"form-group"}).insert({bottom:new Element("input",{class:"form-control input-sm","save-item":"wareLocation",placeholder:"Warehouse Location",type:"text",value:a.product.locations&&a.product.warehouseLocation?a.product.warehouseLocation:""})}).observe("keydown",function(a){c.txtBox=$(this),c.me.keydown(a,function(){c.txtBox.up(".item_row").down('[scanned-item="serialNo"]').select()})}).observe("change",function(a){c.txtBox=$(this),c.rowData=c.txtBox.up(".item_row.list-group-item").retrieve("data"),c.rowData.warehouseLocation=$F(c.txtBox.down("[save-item]")),c.rowData.UPCcode&&c.txtBox.up(".item_row.list-group-item").store("data",c.rowData)}).observe("click",function(a){Event.stop(a),$(this).select()}),c.me._canReceive()!==!0&&(c.EANcodeEl.down("input[save-item=EANcode]").disabled=!0,c.UPCcodeEl.down("input[save-item=UPCcode]").disabled=!0,c.wareLocationEL.down("input[save-item=wareLocation]").disabled=!0,a.btns=""),c.row=new Element(c.isTitle===!0?"strong":"div",{class:"item_row list-group-item",productId:a.product.id,poItemId:a.product.hasOwnProperty("purchaseOrderItem")===!0?a.product.purchaseOrderItem.id:""}).store("data",a.product).insert({bottom:c.infoRow=new Element("div",{class:c.isTitle?"row btn-hide-row":"row btn-hide-row product-head-row"}).insert({bottom:new Element("span",{class:" col-sm-2 productName"}).insert({bottom:a.product.name?a.product.name:a.product.barcode})}).insert({bottom:new Element("span",{class:"col-sm-1"}).insert({bottom:new Element("a",{href:"javascript: void(0);"}).insert({bottom:new Element("span",{class:"scannedQty"}).update(c.isTitle===!0?"Qty":a.product.id?a.product.purchaseOrderItem?a.product.purchaseOrderItem.receivedQty:0:"")}).insert({bottom:new Element("span",{class:"orderedQty"}).update(a.product.purchaseOrderItem?"/"+a.product.purchaseOrderItem.qty:"")}).observe("click",function(){a.product.id&&c.me._purchaseOrder.id&&c.me._openReceivedItemsListPage(a.product)})})}).insert({bottom:new Element("span",{class:" col-sm-2 EANcode"}).update(a.product.id?c.EANcodeEl:a.product.EANcode)}).insert({bottom:new Element("span",{class:" col-sm-2 UPCcode"}).update(a.product.id?c.UPCcodeEl:a.product.UPCcode)}).insert({bottom:new Element("span",{class:" col-sm-2 wareLocation"}).update(a.product.id?c.wareLocationEL:a.product.wareLocation)}).insert({bottom:c.btns=new Element("span",{class:"btns col-sm-1"}).update(a.btns?a.btns:"")})}),c.infoRow.insert({top:new Element("span",{class:"col-sm-2 productSku"}).update(a.product.sku?a.product.sku:"")}),a.scanTable&&c.me._canReceive()===!0&&c.row.insert({bottom:new Element("div",{class:"row product-content-row"}).insert({bottom:new Element("div",{class:"col-sm-2"}).insert({bottom:new Element("span",{class:"col-sm-12"}).insert({bottom:new Element("input",{type:"checkbox",class:"show-checkbox"})}).insert({bottom:new Element("label").update(" show input panel")})}).observe("click",function(){c.productRow=$(this).up(".row.product-content-row"),c.checkBox=c.productRow.down(".show-checkbox"),c.checkBox.checked=!c.checkBox.checked,c.productRow.down(".scanTable").toggle()})}).insert({bottom:new Element("div",{class:"col-sm-10"}).update(a.scanTable.setStyle("display:none;"))})}),c.row},_getNewProductRow:function(){var a={};return a.me=this,a.skuAutoComplete=a.me._getNewProductProductAutoComplete(),a.data={product:{name:a.skuAutoComplete},btns:""},a.newRow=a.me._getProductRow(a.data,!1).addClassName("new-order-item-input list-group-item-warning").removeClassName("order-item-row btn-hide-row"),a.me._canReceive()!==!0&&a.newRow.hide(),a.newRow},_getNewProductProductAutoComplete:function(){var a={};return a.me=this,a.skuAutoComplete=a.me._getFormGroup(null,new Element("div",{class:"input-group input-group-sm product-autocomplete"}).insert({bottom:new Element("input",{id:a.me.getHTMLID("barcodeInput"),class:"form-control search-txt visible-xs visible-sm visible-md visible-lg","new-order-item":"product",required:"Required!",placeholder:"Enter BARCODE for products"}).observe("keydown",function(b){return a.txtBox=this,a.me.keydown(b,function(){$(a.txtBox).up(".product-autocomplete").down(".search-btn").click()}),a.me.keydown(b,function(){$(a.txtBox).up(".product-autocomplete").down(".search-btn").click()},null,9),!1})}).insert({bottom:new Element("span",{class:"input-group-btn"}).insert({bottom:new Element("span",{class:" btn btn-primary search-btn","data-loading-text":"searching..."}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-search"})}).observe("click",function(){a.me._searchProduct(this)})})})),a.skuAutoComplete.down(".input-group").removeClassName("form-control"),a.skuAutoComplete},_getScanTableROW:function(a,b){var c={};return c.me=this,c.tag=b===!0?"th":"td",c.newDiv=new Element("tr",{class:b===!0?"":"scanned-item-row"}).store("data",a).insert({bottom:new Element(c.tag,{class:"col-sm-1"}).update(a.qty?a.qty:"")}).insert({bottom:new Element(c.tag).update(a.serialNo?a.serialNo:"")}).insert({bottom:new Element(c.tag).update(a.unitPrice?a.unitPrice:"")}).insert({bottom:new Element(c.tag).update(a.invoiceNo?a.invoiceNo:"")}).insert({bottom:new Element(c.tag).update(a.comments?a.comments:"")}).insert({bottom:new Element(c.tag,{class:"btns"}).update(a.btns?a.btns:"")}),c.newDiv},_updatetotalReceivedValue:function(){var a={};return a.me=this,a.totalScanedValue=a.me._purchaseOrder.totalReceivedValue,$$(".scanned-item-row").each(function(b){a.qtyBox=b.down('[scanned-item="qty"]'),a.unitPriceBox=b.down('[scanned-item="unitPrice"]'),!b.hasClassName("new-scan-row")&&a.qtyBox&&a.unitPriceBox&&(a.totalScanedValue=1*a.totalScanedValue+a.me.getValueFromCurrency($F(a.unitPriceBox))*$F(a.qtyBox))}),a.totalValueInc=1.1*a.totalScanedValue,jQuery('[summary="total-recieved-value-ex"]').html(a.me.getCurrency(a.totalScanedValue)).val(a.me.getCurrency(a.totalScanedValue)),jQuery('[summary="total-recieved-value"]').html(a.me.getCurrency(a.totalValueInc)).val(a.me.getCurrency(a.totalValueInc)),a.me},_getScanTable:function(a,b){var c={};return c.me=this,c.bulkSerialInputBtn=new Element("a").setStyle("cursor: pointer; text-decoration: underline; margin-left: 5px;").update("Bulk Import").observe("click",function(b){c.me.serialUploader=new SerialBulkUploaderJs(c.me,a),c.me.showModalBox("Bulk Import Serial Numbers",c.serialUploaderPanel=c.me.serialUploader.getInputPanel()),c.serialUploaderPanel.down(".confimBtn").observe("click",function(){$(this).up(".bulkSerialPanel").retrieve("data")&&null!==$(this).up(".bulkSerialPanel").retrieve("data").length&&jQuery("#"+c.me.modalId).modal("hide")}),jQuery("#"+c.me.modalId).on("hide.bs.modal",function(a){return c.serials=$(this).down(".bulkSerialPanel").retrieve("data"),null===c.serials||0===c.serials.length?(jQuery('[role="tooltip"]').tooltip("hide"),void jQuery("#"+c.me.modalId).remove()):(c.existingSerials=[],$$('.item_row[productid="'+c.serials.product.id+'"]').first().getElementsBySelector('[scanned-item="serialNo"]').each(function(a){""!==a.value&&c.existingSerials.push(a.value)}),c.serials&&c.serials.length>0&&c.serials.each(function(a){parseInt(c.existingSerials.indexOf(a.serialNo))<0&&(c.scanTableRow=$$('.item_row[productid="'+c.serials.product.id+'"]').first(),c.scanTableRow.down('[scanned-item="qty"]').setValue(a.qty),c.scanTableRow.down('[scanned-item="unitPrice"]').setValue(a.unitPrice),c.scanTableRow.down('[scanned-item="serialNo"]').setValue(a.serialNo),c.scanTableRow.down('[scanned-item="invoiceNo"]').setValue(a.invoiceNo),c.scanTableRow.down('[scanned-item="comments"]').setValue(a.comments),c.scanTableRow.down(".scanned-item-save-btn").click())}),jQuery('[role="tooltip"]').tooltip("hide"),void jQuery("#"+c.me.modalId).remove())}),c.me.product=null}),c.me.scanTableSerialNoTitle=new Element("span",{class:"scanTableSerialNoTitle"}).update("Serial No.").insert({bottom:c.bulkSerialInputBtn}),c.table=new Element("table",{class:"table scanTable"}).insert({bottom:new Element("thead").update(c.me._getScanTableROW({qty:"Qty",serialNo:c.me.scanTableSerialNoTitle,unitPrice:"Unit Price (Ex)",invoiceNo:"Inv. No.",comments:"Comments",btns:""},!0))}).insert({bottom:new Element("tbody").insert({bottom:c.me._getScanTableROW({qty:c.me._getFormGroup("",new Element("input",{class:"form-control input-sm","scanned-item":"qty",type:"text",placeholder:"How many you received.",required:!0,value:1,validate_currency:"Invalid qty"}).observe("keyup",function(){c.serialNoBox=$(this).up(".scanned-item-row").down("[scanned-item=serialNo]"),$F(this)>1?c.serialNoBox.setValue("No S/N, as qty > 1").disabled=!0:c.serialNoBox.setValue("").disabled=!1}).observe("click",function(){$(this).select(),c.serialNoBox=$(this).up(".scanned-item-row").down("[scanned-item=serialNo]"),$F(this)>1?c.serialNoBox.setValue("No S/N, as qty > 1").disabled=!0:c.serialNoBox.setValue("").disabled=!1}).observe("keydown",function(a){c.qtyBox=$(this),c.serialNoBox=c.qtyBox.up(".scanned-item-row").down("[scanned-item=serialNo]"),c.unitPriceBox=c.qtyBox.up(".scanned-item-row").down("[scanned-item=unitPrice]"),c.me.keydown(a,function(){$F(c.qtyBox)>1?(c.serialNoBox.setValue("No S/N, as qty > 1").disabled=!0,c.unitPriceBox.focus(),c.unitPriceBox.select()):(c.serialNoBox.setValue("").disabled=!1,c.serialNoBox.focus(),c.serialNoBox.select())})})),serialNo:c.me._getFormGroup("",new Element("input",{class:"form-control input-sm","scanned-item":"serialNo",type:"text",placeholder:"Serial Number:",required:!0})),unitPrice:c.me._getFormGroup("",new Element("input",{class:"form-control input-sm","scanned-item":"unitPrice",type:"value",placeholder:"Unit Price:",validate_currency:"Invalid currency",value:a.purchaseOrderItem?c.me.getValueFromCurrency(c.me.getCurrency(a.purchaseOrderItem.unitPrice)):""})),invoiceNo:c.me._getFormGroup("",c.invoiceNoBox=new Element("input",{class:"form-control","scanned-item":"invoiceNo",type:"text",placeholder:"Inv. No.:"})),comments:c.me._getFormGroup("",new Element("input",{class:"form-control input-sm","scanned-item":"comments",type:"text",placeholder:"Comments:"})),btns:new Element("span",{class:"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{class:"scanned-item-save-btn btn btn-primary"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-floppy-saved"})}).observe("click",function(){c.me._saveScanTableRow($(this))})}).insert({bottom:new Element("span",{class:"scanned-item-delete-btn btn btn-default"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-floppy-remove"})}).observe("click",function(){confirm("You about to clear this entry. All input data for this entry will be lost.\n\nContinue?")&&(c.row=$(this).up(".scanned-item-row"),c.serialNoBox=c.row.down("input[scanned-item=serialNo]"),c.unitPriceBox=c.row.down("input[scanned-item=unitPrice]"),c.invoiceNoBox=c.row.down("input[scanned-item=invoiceNo]"),c.commentsBox=c.row.down("input[scanned-item=comments]"),c.serialNoBox.clear(),c.unitPriceBox.clear(),c.invoiceNoBox.clear(),c.commentsBox.clear(),c.serialNoBox.focus())})})}).addClassName("info")})}),c.me._forceInvNo&&c.invoiceNoBox.writeAttribute("required",!0),c.table},_saveScanTableRow:function(a,b,c){var d={};return d.me=this,d.data=c||!1,d.btn=a||!1,d.btn===!1&&d.me.showModalBox('<p class="text-danger">Error</p>',"SerialBulkUploader (control), function _saveScanTableRow must have a btn as input"),d.product=b||d.btn.up(".item_row").retrieve("data"),null!==d.product&&d.product!==!1&&jQuery.isNumeric(d.product.id)!==!1&&d.product.sku||d.me.showModalBox('<p class="text-danger">Error</p>',"Invalid Product passed in"),d.currentRow=d.btn.up(".scanned-item-row"),d.data=d.data!==!1?d.data:d.me._collectFormData(d.currentRow,"scanned-item"),null!==d.data&&(d.newRow=d.currentRow.clone(!0),d.newDeleteBtn=new Element("td").insert({bottom:new Element("span",{class:"scanned-item-delte-btn btn btn-danger btn-xs pull-right"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(a){confirm("You are about to remove this entry.\n\nContinue?")&&(b=d.product,d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML=1*d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML-1*d.data.qty,d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML>b.purchaseOrderItem.qty||!d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML?d.btn.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}):d.btn.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"inherit"}),0==d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML&&d.btn.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}),delRow=this,delRow.up(".scanned-item-row").remove())})}),d.newRow.removeClassName("info").removeClassName("new-scan-row").addClassName("btn-hide-row"),d.newRow.down(".scanned-item-save-btn").remove(),d.newRow.down(".btns").replace(d.newDeleteBtn),d.newRow.down("input[scanned-item=qty]").disable(),d.newRow.down("input[scanned-item=serialNo]").disable(),d.newRow.down("input[scanned-item=unitPrice]").observe("click",function(){d.btn.focus(),d.btn.select()}).observe("keyup",function(){d.unitPriceBox=d.btn,d.unitPriceBox.up(".scanned-item-row").hasClassName("new-scan-row")||d.me._updatetotalReceivedValue()}),d.currentRow.insert({after:d.newRow}),d.currentRow.down("input[scanned-item=comments]").clear(),d.currentRow.down("input[scanned-item=serialNo]").clear().disabled=!1,d.currentRow.down("input[scanned-item=qty]").value=1,d.currentRow.down("input[scanned-item=serialNo]").select(),d.btn.up(".item_row").down(".scannedQty").innerHTML=1*d.btn.up(".item_row").down(".scannedQty").innerHTML+1*d.data.qty,d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML>d.product.purchaseOrderItem.qty||!d.btn.up(".item_row").down(".product-head-row .scannedQty").innerHTML?d.btn.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"red"}):d.btn.up(".item_row").down(".product-head-row .scannedQty").setStyle({color:"inherit"}),d.me._updatetotalReceivedValue()),d.btn.up(".scanTable").down('[scanned-item="serialNo"]').focus(),d.btn.up(".scanTable").down('[scanned-item="serialNo"]').select(),d.me},_searchProduct:function(a){var b={};if(b.me=this,b.btn=a,b.me._signRandID(b.btn),b.searchTxtBox=$(b.btn).up(".product-autocomplete").down(".search-txt"),b.searchTxt=$F(b.searchTxtBox),b.searchTxt)return b.currentRow=$(a).up(".new-order-item-input"),b.product={name:"",id:"",qty:0,barcode:b.searchTxt},b.data={product:b.product,btns:new Element("span",{class:"pull-right"}).insert({bottom:new Element("span",{class:"btn btn-danger btn-xs"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a),confirm("You are about to remove this entry.\n\nContinue?")&&(b.row=$(this).up(".item_row"),b.row.remove())})})},b.currentRow.insert({after:b.lastRow=b.me._getProductRow(b.data,!1)}),b.newRow=b.me._getNewProductRow(),b.currentRow.replace(b.newRow),b.newRow.down("[new-order-item=product]").focus(),b.inputBox=jQuery("#"+b.me.getHTMLID("barcodeInput")),b.me.postAjax(b.me.getCallbackId("searchProduct"),{searchTxt:b.searchTxt},{onLoading:function(){jQuery("#"+b.me.getHTMLID("barcodeInput")).button("loading")},onSuccess:function(a,c){b.resultList=new Element("div",{style:"overflow: auto; max-height: 400px;"});try{if(b.result=b.me.getResp(c,!1,!0),!b.result||!b.result.items||0===b.result.items.size())throw b.lastRow.down(".productSku").insert({bottom:new Element("strong",{class:"text-danger"}).update("No Product Found!")}),b.lastRow.down(".productName").insert({top:new Element("span",{class:""}).update("Barcode: ")}),"Nothing Found for: "+b.searchTxt;if(b.result.items.size()>1)return b.searchTxtBox=b.newRow.down(".search-txt"),b.resultList=new Element("div",{style:"overflow: auto; max-height: 400px;",class:"selectProductPanel"}),b.result.items.each(function(a){b.resultList.insert({bottom:b.me._getSearchPrductResultRow(a,b.searchTxtBox,b.lastRow,b.newRow)})}),b.resultList.addClassName("list-group"),b.me.showModalBox("Products that has: "+b.searchTxt,b.resultList,!1),b.me;b.data.product=b.result.items[0],b.me._selectProduct(b.data.product,b.lastRow,b.newRow)}catch(a){b.resultList.update(b.me.getAlertBox("Error: ",a).addClassName("alert-danger"))}},onComplete:function(a,c){jQuery("#"+b.me.getHTMLID("barcodeInput")).button("reset")}}),b.me},_selectProduct:function(a,b){var c={};return c.me=this,c.data=[],c.product=a,c.lastRow=b,c.btn=$("barcode_input"),c.me._signRandID(c.btn),c.data={product:c.product,btns:new Element("span",{class:"pull-right"}).insert({bottom:new Element("span",{class:"btn btn-danger btn-xs"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(a){Event.stop(a),confirm("You are about to remove this entry.\n\nContinue?")&&(c.row=$(this).up(".item_row"),c.row.remove())})}),qty:0},c.data.scanTable=c.me._getScanTable(c.data.product,c.data),c.lastRow.replace(c.newRow=c.me._getProductRow(c.data,!1)),c.me._checkProduct(c.product,c.newRow.down(".product-head-row")),c.newRow.down('[save-item="EANcode"]').select(),c.me._focusNext(c.newRow,"serialNo","unitPrice"),c.me._focusNext(c.newRow,"unitPrice","invoiceNo"),c.me._focusNext(c.newRow,"invoiceNo","comments"),
c.serialNoBox=c.newRow.down("input[scanned-item=serialNo]"),c.serialNoBox&&(c.serialNoBox.observe("keydown",function(a){return c.me.keydown(a,function(){$F(c.serialNoBox).blank()||$F(c.unitPriceBox).blank()||$F(c.invoiceNoBox).blank()||c.newRow.down(".scanned-item-save-btn span").click()}),!1}),c.serialNoBox.up(".scanned-item-row").addClassName("new-scan-row")),c.unitPriceBox=c.newRow.down("input[scanned-item=unitPrice]"),c.unitPriceBox&&c.unitPriceBox.observe("keydown",function(a){return c.me.keydown(a,function(){$F(c.serialNoBox).blank()||$F(c.unitPriceBox).blank()||$F(c.invoiceNoBox).blank()||c.newRow.down(".scanned-item-save-btn span").click()}),!1}),c.invoiceNoBox=c.newRow.down("input[scanned-item=invoiceNo]"),c.invoiceNoBox&&c.invoiceNoBox.observe("keydown",function(a){return c.me.keydown(a,function(){$F(c.serialNoBox).blank()||$F(c.unitPriceBox).blank()||$F(c.invoiceNoBox).blank()||c.newRow.down(".scanned-item-save-btn span").click()}),!1}),c.commentsBox=c.newRow.down("input[scanned-item=comments]"),c.commentsBox&&c.commentsBox.observe("keydown",function(a){return c.me.keydown(a,function(){$F(c.serialNoBox).blank()||$F(c.unitPriceBox).blank()||$F(c.invoiceNoBox).blank()||c.newRow.down(".scanned-item-save-btn span").click()}),!1}),c.me._scanRowAutoSave(c.newRow),c.me},_scanRowAutoSave:function(a){var b={};return b.me=this,b.row=a,b.row.down('[scanned-item="comments"]')&&b.row.down('[scanned-item="comments"]').observe("keydown",function(a){return b.me.keydown(a,function(){b.row.down(".scanned-item-save-btn").click()}),!1}),b.me},_focusNext:function(a,b,c){var d={};return d.me=this,d.row=a,d.from=b,d.to=c,d.row.down('[scanned-item="'+d.from+'"]')&&d.row.down('[scanned-item="'+d.from+'"]').observe("keydown",function(a){return d.me.keydown(a,function(){d.row.down('[scanned-item="'+d.to+'"]').select()}),!1}),d.me},_checkProduct:function(a,b){var c={};c.me=pageJs,c.newRow=b,c.product=a,c.btn=$("barcode_input"),c.me._signRandID(c.btn),c.me.postAjax(c.me.getCallbackId("checkProduct"),{product:{id:c.product.id},purchaseOrder:{id:c.me._purchaseOrder.id}},{onLoading:function(a,b){jQuery("#"+c.btn.id).button("loading")},onSuccess:function(a,b){try{c.result=c.me.getResp(b,!1,!0),0==c.result.count&&(c.newRow.down(".productSku").insert({bottom:new Element("strong",{style:"color:red"}).update("  (Not found in PO)")}),c.newRow.up(".item_row").addClassName("not-in-po"))}catch(a){c.me.showModalBox("Error!",a,!1)}},onComplete:function(a,b){jQuery("#"+c.btn.id).button("reset")}})},_canReceive:function(){var a={};return a.me=this,"RECEIVING"===a.me._purchaseOrder.status||"ORDERED"===a.me._purchaseOrder.status},_saveBtns:function(){var a={};return a.me=this,a.me.clicked=!1,a.newDiv=new Element("span",{class:"btn-group pull-right"}).insert({bottom:new Element("span",{class:"btn btn-primary","data-loading-text":"saving..."}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-ok-circle"})}).insert({bottom:new Element("span").update(" save ")}).observe("click",function(){a.me.clicked!==!0&&(a.me.clicked=!0,a.me._submitOrder($(this)))})}).insert({bottom:new Element("span",{class:"btn btn-default"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-remove-sign"})}).insert({bottom:new Element("span").update(" cancel ")}).observe("click",function(){a.me.showModalBox('<strong class="text-danger">Cancelling this PO receiving</strong>','<div>You are about to cancel this receiving process, all input data will be lost.</div><br /><div>Continue?</div><div><span class="btn btn-primary" onclick="window.location = document.URL;"><span class="glyphicon glyphicon-ok"></span> YES</span><span class="btn btn-default pull-right" data-dismiss="modal"><span aria-hidden="true"><span class="glyphicon glyphicon-remove-sign"></span> NO</span></span></div>',!0)})}),a.newDiv},_getOutStandingOrderPanel:function(a){var b={};return b.me=this,b.newDiv=new Element("div").insert({bottom:new Element("div").update("There are outstanding orders that need these parts that you just recieved:")}).insert({bottom:new Element("table",{class:"table table-hover table-condensed"}).insert({bottom:new Element("thead").insert({bottom:new Element("tr").insert({bottom:new Element("th").update("Product")}).insert({bottom:new Element("th").update("Received Qty")}).insert({bottom:new Element("th").update("Orders")})})}).insert({bottom:b.tbody=new Element("tbody")})}),a.each(function(a){b.orderRow=new Element("div",{class:"row"}),a.outStandingOrders.each(function(a){b.orderRow.insert({bottom:new Element("div",{class:"col-sm-3"}).insert({bottom:new Element("a",{href:"/orderdetails/"+a.id+".html",target:"_BLANK"}).update(a.orderNo)})})}),b.tbody.insert({bottom:new Element("tr").insert({bottom:new Element("td").update(a.product.sku)}).insert({bottom:new Element("td").update(a.recievedQty)}).insert({bottom:new Element("td").update(b.orderRow)})})}),b.newDiv},_submitOrder:function(a){var b={};return b.me=this,b.btn=a,b.data=b.me._collectFormData($(b.me.getHTMLID("itemDiv")),"save-order"),b.data.purchaseOrder={id:b.me._purchaseOrder.id},b.data.products={},b.data.products.matched=[],b.data.products.notMatched=[],$(b.me.getHTMLID("partsTable")).getElementsBySelector("div.item_row").each(function(a){a.hasClassName("new-order-item-input")||(""!==a.retrieve("data").id?(b.scanData=[],a.getElementsBySelector(".table.scanTable .scanned-item-row").each(function(a){a.hasClassName("new-scan-row")||b.scanData.push(b.me._collectFormData(a,"scanned-item"))}),b.data.products.matched.push({product:{id:a.retrieve("data").id,poItemId:a.retrieve("data").purchaseOrderItem.id,EANcode:a.retrieve("data").EANcode,UPCcode:a.retrieve("data").UPCcode,warehouseLocation:a.retrieve("data").warehouseLocation},serial:b.scanData})):b.data.products.notMatched.push({id:a.retrieve("data").id,poItemId:a.retrieve("data").purchaseOrderItem.id,EANcode:a.retrieve("data").EANcode,UPCcode:a.retrieve("data").UPCcode,warehouseLocation:a.retrieve("data").warehouseLocation}))}),null===b.data?b.me:b.data.products.matched.size()+b.data.products.notMatched.size()<=0?(b.me.showModalBox('<strong class="text-danger">Error</strong>',"At least one item is needed!",!0),b.me):(b.me._signRandID(b.btn),b.me.postAjax(b.me.getCallbackId("saveOrder"),b.data,{onLoading:function(a,c){jQuery("#"+b.btn.id).button("loading")},onSuccess:function(a,c){try{if(b.result=b.me.getResp(c,!1,!0),!b.result||!b.result.item||!b.result.outStandingOrders)return;b.newDiv=new Element("div").update("<strong>All items saved successfully! Bill(s) generated as following:</strong>").insert({bottom:b.billList=new Element("ul",{class:"list-inline"})}),b.result.invoiceNos&&b.result.invoiceNos.length>0&&b.result.invoiceNos.each(function(a){b.billList.insert({bottom:new Element("li").update(new Element("a",{class:"btn btn-success",href:"/bills/"+b.result.item.supplier.id+".html?invoiceNo="+a,target:"_BLANK"}).update(a))})}),b.result.outStandingOrders.size()>0&&b.newDiv.insert({bottom:b.me._getOutStandingOrderPanel(b.result.outStandingOrders)}),b.me.showModalBox('<strong class="text-success">Success!</strong>',b.newDiv,!1,null,{"hide.bs.modal":function(){window.location=document.URL}}),b.me.refreshParentWindow(b.result.item)}catch(a){b.me.showModalBox("Error!",a,!1)}},onComplete:function(a,c){jQuery("#"+b.btn.id).button("reset")}}),b.me)},refreshParentWindow:function(a){var b={};b.me=this,window.opener&&(b.parentWindow=window.opener,b.row=$(b.parentWindow.document.body).down("#"+b.parentWindow.pageJs.resultDivId+" .item_row[item_id="+a.id+"]"),b.row&&b.row.replace(b.parentWindow.pageJs._getResultRow(a)))},_getSearchPrductResultRow:function(a,b,c,d){var e={};return e.me=this,e.lastRow=c,e.newRow=d,e.defaultImgSrc="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZWVlIi8+PHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzIiIHk9IjMyIiBzdHlsZT0iZmlsbDojYWFhO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1zaXplOjEycHg7Zm9udC1mYW1pbHk6QXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+NjR4NjQ8L3RleHQ+PC9zdmc+",e.newRow=new Element("a",{class:"list-group-item",href:"javascript: void(0);"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-2"}).insert({bottom:new Element("div",{class:"thumbnail"}).insert({bottom:new Element("img",{"data-src":"holder.js/100%x64",alert:"Product Image",src:0===a.images.size()?e.defaultImgSrc:a.images[0].asset.url})})})}).insert({bottom:new Element("div",{class:"col-xs-10"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("strong").update(a.name).insert({bottom:new Element("small",{class:"",style:"padding-left: 10px;"}).update("SKU: "+a.sku)})}).insert({bottom:new Element("div").insert({bottom:new Element("small").update(a.shortDescription)})})})})}).observe("click",function(){e.inputRow=$(b).up(".new-order-item-input").store("product",a),e.me._selectProduct(a,e.lastRow,e.newRow),jQuery("#"+e.me.modalId).modal("hide"),$$('[scanned-item="serialNo"]').first().focus()}),e.newRow},init:function(a){var b={};b.me=this,a?b.me.selectPO(a):$(b.me.getHTMLID("itemDiv")).update(b.me._getPOListPanel()).down(".init-focus").focus()}});