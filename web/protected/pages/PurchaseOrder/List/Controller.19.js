var PageJs=new Class.create;PageJs.prototype=Object.extend(new CRUDPageJs,{_pre_num:0,_getTitleRowData:function(){return{totalAmount:"PO Amount Inc. GST",totalReceivedValue:"Bill Amount Inc. GST",totalPaid:"Total Paid",purchaseOrderNo:"PO Number",supplier:{name:"Supplier"},arrangePickup:"Pickup",status:"Status",supplierRefNo:"PO Ref.",orderDate:"Order Date",active:"Active"}},_loadChosen:function(){return jQuery(".chosen").chosen({disable_search_threshold:10,no_results_text:"Oops, nothing found!",width:"95%"}),jQuery('.chosen-container input[type="text"]').keydown(function(a){13!=a.which&&13!=a.keyCode||(a.preventDefault(),$("searchPanel").down("#searchBtn").click())}),this},_bindSearchKey:function(){var a={};return a.me=this,$$("#searchBtn").first().observe("click",function(b){$$("#showSearch").first().checked?(a.me._pre_num=0,a.me.getSearchCriteria().getResults(!0,a.me._pagination.pageSize)):$$("#showSearch").first().click()}),a.selectEl=new Element("input",{class:"select2 form-control","data-placeholder":"the Name of Supplier",search_field:"po.supplierIds"}).insert({bottom:new Element("option").update("")}),$(a.me.searchDivId).down('[search_field="po.supplierIds"]').replace(a.selectEl),jQuery('.select2[search_field="po.supplierIds"]').select2({allowClear:!0,hidden:!0,multiple:!0,ajax:{url:"/ajax/getSuppliers",dataType:"json",delay:10,data:function(a){return{searchTxt:a}},results:function(b){return a.result=[],b.resultData.items.each(function(b){a.result.push({id:b.id,text:b.name,data:b})}),{results:a.result}},cache:!0},formatResult:function(a){return a?"<div value="+a.data.id+">"+a.data.name+"</div >":""},escapeMarkup:function(a){return a},minimumInputLength:1}),a.selectEl=new Element("select",{class:"select2 form-control",multiple:!0,"data-placeholder":"the Status of PO",search_field:"po.status"}),a.me._status.each(function(b){a.selectEl.insert({bottom:a.option=new Element("option",{value:b}).update(b)}),"NEW"!==b&&"ORDERED"!==b&&"RECEIVING"!==b||a.option.writeAttribute("selected",!0)}),$(a.me.searchDivId).down('[search_field="po.status"]').replace(a.selectEl),jQuery('.select2[search_field="po.status"]').select2({allowClear:!0,hidden:!0}),a.selectEl=new Element("input",{class:"select2 form-control","data-placeholder":"search for a Products",search_field:"pro.ids"}).insert({bottom:new Element("option").update("")}),$("searchDiv").down('[search_field="pro.ids"]').replace(a.selectEl),jQuery('.select2[search_field="pro.ids"]').select2({allowClear:!0,hidden:!0,multiple:!0,ajax:{url:"/ajax/getProducts",dataType:"json",delay:10,data:function(a){return{searchTxt:a,pageNo:1,pageSize:10,userId:jQuery("#userId").attr("value")}},results:function(b){return a.result=[],b.resultData.items.each(function(b){a.result.push({id:b.id,text:b.name,data:b})}),{results:a.result}},cache:!0},formatResult:function(a){return a?"<div value="+a.data.id+">"+a.data.name+"</div >":""},escapeMarkup:function(a){return a},minimumInputLength:3}),$("searchDiv").getElementsBySelector("[search_field]").each(function(b){b.observe("keydown",function(b){a.me.keydown(b,function(){$(a.me.searchDivId).down("#searchBtn").click()})})}),this},_loadDataPicker:function(){var a={};return a.me=this,$$(".datepicker").each(function(b){b.hasClassName("datepicked")||(a.me._signRandID(b),a.picker=new Prado.WebUI.TDatePicker({ID:b.id,InputMode:"TextBox",Format:"yyyy-MM-dd 00:00:00",FirstDayOfWeek:1,CalendarStyle:"default",FromYear:2009,UpToYear:2024,PositionMode:"Bottom",ClassName:"datepicker-layer-fixer"}),b.store("picker",a.picker))}),a.me},getResults:function(a,b){var c={};c.num=0,c.me=this,c.reset=a||!1,c.resultDiv=$(c.me.resultDivId),!0===c.reset&&(c.me._pagination.pageNo=1),c.me._pagination.pageSize=b||c.me._pagination.pageSize,c.me.postAjax(c.me.getCallbackId("getItems"),{pagination:c.me._pagination,searchCriteria:c.me._searchCriteria},{onLoading:function(){jQuery("#"+c.me.searchDivId+" #searchBtn").button("loading"),!0===c.reset&&c.resultDiv.update(new Element("tr").update(new Element("td").update(c.me.getLoadingImg())))},onSuccess:function(a,b){try{if(c.result=c.me.getResp(b,!1,!0),!c.result)return;$(c.me.totalNoOfItemsId).update(c.result.pageStats.totalRows),!0===c.reset&&c.resultDiv.update(c.me._getResultRow(c.me._getTitleRowData(),!0).wrap(new Element("thead"))),c.resultDiv.getElementsBySelector(".paginWrapper").each(function(a){a.remove()}),c.tbody=$(c.resultDiv).down("tbody"),c.tbody||$(c.resultDiv).insert({bottom:c.tbody=new Element("tbody")}),$("pre-selected-count").update(c.me._pre_num),c.result.items.each(function(a){a.item.totalProdcutCount=a.totalProdcutCount,a=a.item,c.tbody.insert({bottom:c.me._getResultRow(a).addClassName("item_row").writeAttribute("item_id",a.id)}),1==a.pickupDelivery&&(c.num+=1)}),c.me._pre_num=parseInt($("pre-selected-count").innerHTML)+c.num,$("pre-selected-count").update(c.me._pre_num),c.result.pageStats.pageNumber<c.result.pageStats.totalPages&&c.resultDiv.insert({bottom:c.me._getNextPageBtn().addClassName("paginWrapper")})}catch(a){c.resultDiv.insert({bottom:c.me.getAlertBox("Error",a).addClassName("alert-danger")})}},onComplete:function(){jQuery("#"+c.me.searchDivId+" #searchBtn").button("reset")}})},_deactivateItem:function(a){var b={};b.me=this,b.row=$$('[item_id="'+a.id+'"]').first(),b.me.postAjax(b.me.getCallbackId("deactivateItems"),{item_id:a.id},{onLoading:function(){b.row&&b.row.hide(),b.me.hideModalBox()},onSuccess:function(a,c){try{if(b.row.toggleClassName("danger"),b.result=b.me.getResp(c,!1,!0),!b.result.item)throw"errror";b.row.replace(b.me._getResultRow(b.result.item,!1))}catch(a){b.me.showModalBox('<span class="text-danger">ERROR</span>',a,!0)}},onComplete:function(){b.row&&b.row.show()}})},_shoConfirmDel:function(a){var b={};return b.me=this,b.confirmDiv=new Element("div").insert({bottom:new Element("strong").update("You are about to delete a Purchase Order: "+a.purchaseOrderNo)}).insert({bottom:new Element("strong").update("After confirming deletion:")}).insert({bottom:new Element("ul").insert({bottom:new Element("li").update(" - All received item will be deleted, and stock will be reverted from StockOnHand to StockOnPO.")}).insert({bottom:new Element("li").update(" - This PO will be dactivated.")})}).insert({bottom:new Element("div").update(new Element("strong").update("Are you sure you want to continue?"))}).insert({bottom:new Element("div").insert({bottom:new Element("span",{class:"btn btn-danger"}).update("YES, deactivate it").observe("click",function(){b.me._deactivateItem(a)})}).insert({bottom:new Element("span",{class:"btn btn-default pull-right"}).update("NO, cancel this").observe("click",function(){b.me.hideModalBox()})})}),b.me.showModalBox('<strong class="text-warning">Confirm</strong>',b.confirmDiv),b.me},_getResultRow:function(a,b){var c={};return c.me=this,c.tag=!0===c.isTitle?"th":"td",c.isTitle=b||!1,c.invoiceNoDiv=new Element("div"),b||a.supplierInvoices.each(function(a){c.invoiceNoDiv.insert({bottom:new Element("div").update(a)})}),c.row=new Element("tr",{class:(!0===c.isTitle?"item_top_row":"btn-hide-row item_row po_item")+(0==a.active?" danger":""),item_id:!0===c.isTitle?"":a.id}).store("data",a).insert({bottom:new Element(c.tag,{class:"purchaseOrderNo col-xs-1"}).update(c.isTitle?a.purchaseOrderNo:new Element("a",{href:"/purchase/"+a.id+".html",target:"_BLANK"}).update(a.purchaseOrderNo))}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.me.loadUTCTime(a.orderDate).toLocaleString())}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(a.supplier.name?a.supplier.name:"")}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?"Invoice No(s)":a.totalPaid?c.invoiceNoDiv:"")}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(a.supplierRefNo?a.supplierRefNo:"")}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?"Products Count":new Element("a",{href:"/serialnumbers.html?purchaseorderid="+a.id,target:"_BLANK"}).insert({bottom:new Element("abbr",{title:"Received Product Count on this PO"}).update(a.totalReceivedCount)}).insert({bottom:new Element("span").update(" / ")}).insert({bottom:new Element("abbr",{title:"Total Product Count on this PO"}).update(a.totalProductCount)}))}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?a.totalAmount:c.me.getCurrency(a.totalAmount))}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?a.totalReceivedValue:c.me.getCurrency(1.1*a.totalReceivedValue))}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?"Total Paid":a.totalPaid?c.me.getCurrency(a.totalPaid):"")}).insert({bottom:new Element(c.tag,{class:" col-xs-1"}).update(c.isTitle?a.arrangePickup:new Element("input",{class:"arrangePickup",type:"checkbox",checked:a.pickupDelivery}))}).insert({bottom:new Element(c.tag,{class:" col-xs-1",order_status:a.status}).update(a.status)}).insert({bottom:c.btns=new Element(c.tag,{class:"col-xs-1 text-right"})}),!0!==c.isTitle&&c.btns.insert({bottom:new Element("div",{class:"btn-group"}).insert({bottom:!a.id||"ORDERED"!==a.status&&"RECEIVING"!==a.status||!0!==a.active?"":new Element("a",{class:"btn btn-success btn-xs",href:"/receiving/"+a.id+".html",target:"_BLANK",title:"Receiving Items"}).update("Receiving")}).insert({bottom:new Element("a",{class:"btn btn-default btn-xs",title:"Edit",href:"/purchase/"+a.id+".html",target:"_BLANK"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-pencil"})})}).insert({bottom:new Element("span",{class:"btn btn-danger btn-xs",title:"Delete"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(){c.me._shoConfirmDel(a)})})}),c.row},genReport:function(a){var b={};return b.me=this,b.data={},$$("[search_field]").each(function(a){b.data[a.readAttribute("search_field")]=$F(a)}),b.me.postAjax(b.me.getCallbackId("genReportmBtn"),b.data,{onLoading:function(){jQuery(a).button("loading")},onSuccess:function(a,c){try{if(b.result=b.me.getResp(c,!1,!0),!b.result||!b.result.url)return;if(b.newWind=window.open(b.result.url),!b.newWind)throw'You browser is blocking the popup window, please click <a class="btn btn-xs btn-primary" href="'+b.result.url+'" target="__BLANK">here</a> to open it manually.'}catch(a){b.me.showModalBox("<b>Error:</b>",'<b class="text-danger">'+a+"</b>")}},onComplete:function(){jQuery(a).button("reset")}}),b.me},_getSelection:function(){var a={};return a.me=this,a.pos=[],a.itemList=$("item-list"),a.itemList.getElementsBySelector(".item_row.po_item").each(function(b){a.checked=b.down('input.arrangePickup[type="checkbox"]').checked,a.poId=b.readAttribute("item_id"),!0===a.checked&&!0===jQuery.isNumeric(a.poId)&&a.pos.push(b.retrieve("data"))}),$("total-selected-count").update(a.pos.length),a.pos},pickupSave:function(a){var b={};return b.me=this,b.data=b.me._getSelection(),b.totalQty=$("total-selected-count").innerHTML,b.preQty=$("pre-selected-count").innerHTML,b.num=b.totalQty-b.preQty,b.num<=0?void b.me.showModalBox("Warning","No new pickup arranged!",!1):(confirm(" Totally "+b.num+" POs are arranged to pickup. \n Continue?")&&b.me.postAjax(b.me.getCallbackId("pickupSaveBtn"),b.data,{onLoading:function(){jQuery(a).button("loading")},onSuccess:function(a,c){try{if(b.result=b.me.getResp(c,!1,!0),!b.result)return;b.me.showModalBox("Success","Pickup arranged!",!1),b.result.items.each(function(a){$$(".po_item[item_id="+a.id+"]").size()>0&&$$(".po_item[item_id="+a.id+"]").first().replace(b.me._getResultRow(a,!1))}),b.me._pre_num=parseInt(b.num)+parseInt(b.preQty),$("pre-selected-count").update(b.me._pre_num)}catch(a){b.me.showModalBox("<b>Error:</b>",'<b class="text-danger">'+a+"</b>")}},onComplete:function(){jQuery(a).button("reset")}}),b.me)}});