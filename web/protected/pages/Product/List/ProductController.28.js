var PageJs=new Class.create();PageJs.prototype=Object.extend(new CRUDPageJs(),{manufactures:[],suppliers:[],productCategories:[],productStatuses:[],_showRightPanel:false,_getTitleRowData:function(){return{sku:"SKU",name:"Product Name",locations:"Locations",invenAccNo:"AccNo.",manufacturer:{name:"Brand"},supplierCodes:[{supplier:{name:"Supplier"},code:""}],active:"act?",stockOnOrder:"OnOrder",stockOnHand:"OnHand",stockOnPO:"OnPO"}},toggleSearchPanel:function(a){var b={};b.me=this;$(a).toggle();b.me.deSelectProduct();return b.me},_loadManufactures:function(b){this.manufactures=b;var a={};a.me=this;a.selectionBox=$(a.me.searchDivId).down('[search_field="pro.manufacturerIds"]');a.me.manufactures.each(function(c){a.selectionBox.insert({bottom:new Element("option",{value:c.id}).update(c.name)})});return this},_loadProductStatuses:function(a){this.productStatuses=a;var b={};b.me=this;b.selectionBox=$(b.me.searchDivId).down('[search_field="pro.productStatusIds"]');b.me.productStatuses.each(function(c){b.selectionBox.insert({bottom:new Element("option",{value:c.id}).update(c.name)})});return this},_loadSuppliers:function(a){this.suppliers=a;var b={};b.me=this;b.selectionBox=$(b.me.searchDivId).down('[search_field="pro.supplierIds"]');b.me.suppliers.each(function(c){b.selectionBox.insert({bottom:new Element("option",{value:c.id}).update(c.name)})});return this},_loadCategories:function(a){this.categories=a;var b={};b.me=this;b.selectionBox=$(b.me.searchDivId).down('[search_field="pro.productCategoryIds"]');b.me.categories.sort(function(d,c){return d.namePath>c.namePath}).each(function(c){b.selectionBox.insert({bottom:new Element("option",{value:c.id}).update(c.namePath)})});return this},_loadChosen:function(){jQuery(".chosen").chosen({search_contains:true,inherit_select_classes:true,no_results_text:"Oops, nothing found!",width:"95%"});return this},_bindSearchKey:function(){var a={};a.me=this;$$("#searchBtn").first().observe("click",function(b){if(!$$("#showSearch").first().checked){$$("#showSearch").first().click()}else{a.me.deSelectProduct();a.me.getSearchCriteria().getResults(true,a.me._pagination.pageSize)}});$("searchDiv").getElementsBySelector("[search_field]").each(function(b){b.observe("keydown",function(c){a.me.keydown(c,function(){$(a.me.searchDivId).down("#searchBtn").click()})})});return this},_getSupplierCodes:function(c,a){var b={};b.me=this;b.supplierCodeString=[];c.each(function(d){b.supplierCodeString.push(a===true?"Supplier":'<abbr title="Code: '+d.code+'">'+d.supplier.name+"</abbr>")});return b.supplierCodeString.join(", ")},_getLocations:function(b,a){var c={};c.me=this;if(a===true){return"Locations"}c.locationStrings=[];b.each(function(d){c.locationStrings.push('<div><small><strong class="hidden-xs hide-when-info hidden-sm">'+d.type.name+': </strong><abbr title="Type: '+d.type.name+'">'+d.value+"</abbr></small></div>")});return c.locationStrings.join("")},_displayPriceMatchResult:function(b){var a={};a.me=this;a.minPrice=0;a.tbody=new Element("tbody");$H(b.companyPrices).each(function(c){if(parseInt(c.value.price)!==0){if((parseInt(a.minPrice)===0&&parseFloat(c.value.price)>0)||parseFloat(c.value.price)<parseFloat(a.minPrice)){a.minPrice=c.value.price}}a.tbody.insert({bottom:new Element("tr").insert({bottom:new Element("td",{colspan:3}).update(c.key)}).insert({bottom:new Element("td").update(c.value.priceURL&&!c.value.priceURL.blank()?new Element("a",{href:c.value.priceURL,target:"__blank"}).update(a.me.getCurrency(c.value.price)):a.me.getCurrency(c.value.price))})})});a.priceDiff=parseFloat(b.myPrice)-parseFloat(a.minPrice);a.priceDiffClass="";if(parseInt(a.minPrice)!==0){if(parseInt(a.priceDiff)>0){a.priceDiffClass="label label-danger"}else{if(parseInt(a.priceDiff)<0){a.priceDiffClass="label label-success"}}}a.newDiv=new Element("table",{"class":"table table-striped table-hover price-match-listing"}).insert({bottom:new Element("thead").insert({bottom:new Element("tr").insert({bottom:new Element("th").update("SKU")}).insert({bottom:new Element("th").update("My Price")}).insert({bottom:new Element("th",{"class":"price_diff"}).update("Price Diff.")}).insert({bottom:new Element("th").update("Min Price")})})}).insert({bottom:new Element("tbody").insert({bottom:new Element("tr").insert({bottom:new Element("td").update(b.sku)}).insert({bottom:new Element("td").update(a.me.getCurrency(b.myPrice))}).insert({bottom:new Element("td",{"class":"price_diff"}).update(new Element("span",{"class":""+a.priceDiffClass}).update(a.me.getCurrency(a.priceDiff)))}).insert({bottom:new Element("td",{"class":"price_min"}).update(a.me.getCurrency(a.minPrice))})})}).insert({bottom:new Element("thead").insert({bottom:new Element("tr").insert({bottom:new Element("th",{colspan:3}).update("Company")}).insert({bottom:new Element("th").update("Price")})})}).insert({bottom:a.tbody});return a.newDiv},_getInfoPanel:function(b){var a={};a.me=this;return new Element("div",{id:"info_panel_"+b.id}).insert({bottom:new Element("div",{"class":"col-md-6"}).insert({bottom:new Element("div",{"class":"panel panel-default price-match-div"}).insert({bottom:new Element("div",{"class":"panel-heading"}).update("<strong>Price Match</strong>")}).insert({bottom:new Element("div",{"class":"panel-body price-match-listing"}).update(a.me.getLoadingImg())})})}).insert({bottom:new Element("div",{"class":"col-md-6"}).insert({bottom:new Element("div",{"class":"panel panel-default price-trend-div"}).insert({bottom:new Element("div",{"class":"panel-body"}).insert({bottom:new Element("iframe",{frameborder:"0",scrolling:"auto",width:"100%",height:"400px"})})})})}).insert({bottom:new Element("div",{"class":"col-md-6"}).insert({bottom:new Element("div",{"class":"panel panel-default"}).insert({bottom:new Element("div",{"class":"panel-body"}).update("<h4>Reserved for Next Phase of Developing</h4>")})})}).insert({bottom:new Element("div",{"class":"col-md-6"}).insert({bottom:new Element("div",{"class":"panel panel-default"}).insert({bottom:new Element("div",{"class":"panel-body"}).update("<h4>Reserved for Next Phase of Developing</h4>")})})})},_showProductInfoOnRightPanel:function(b){var a={};a.me=this;a.infoPanel=a.me._getInfoPanel(b);a.infoPanel.down(".price-trend-div iframe").writeAttribute("src","/statics/product/pricetrend.html?productid="+b.id);a.me.postAjax(a.me.getCallbackId("priceMatching"),{id:b.id},{onLoading:function(){a.infoPanel.down(".price-match-div .price-match-listing").replace(new Element("div",{"class":"panel-body price-match-listing"}).update(a.me.getLoadingImg()))},onSuccess:function(c,f){try{a.result=a.me.getResp(f,false,true);if(!a.result){return}if($("info_panel_"+b.id)){$("info_panel_"+b.id).down(".price-match-div .price-match-listing").replace(a.me._displayPriceMatchResult(a.result))}}catch(d){a.me.showModalBox("Error",d,true)}}});return a.infoPanel},deSelectProduct:function(){var a={};a.me=this;jQuery(".product_item.success",jQuery("#"+a.me.resultDivId)).removeClass("success").popover("hide");$(a.me.resultDivId).up(".list-panel").removeClassName("col-xs-4").addClassName("col-xs-12");jQuery(".hide-when-info",jQuery("#"+a.me.resultDivId)).show();a.me._showRightPanel=false;return a.me},getResults:function(c,a){var b={};b.me=this;b.reset=(c||false);b.resultDiv=$(b.me.resultDivId);if(b.reset===true){b.me._pagination.pageNo=1}b.me._pagination.pageSize=(a||b.me._pagination.pageSize);b.me.postAjax(b.me.getCallbackId("getItems"),{pagination:b.me._pagination,searchCriteria:b.me._searchCriteria},{onLoading:function(){jQuery("#"+b.me.searchDivId+" #searchBtn").button("loading");if(b.reset===true){b.resultDiv.update(new Element("tr").update(new Element("td").update(b.me.getLoadingImg())))}},onSuccess:function(d,g){try{b.result=b.me.getResp(g,false,true);if(!b.result){return}$(b.me.totalNoOfItemsId).update(b.result.pageStats.totalRows);if(b.reset===true){b.resultDiv.update(b.me._getResultRow(b.me._getTitleRowData(),true).wrap(new Element("thead")))}b.resultDiv.getElementsBySelector(".paginWrapper").each(function(e){e.remove()});b.tbody=$(b.resultDiv).down("tbody");if(!b.tbody){$(b.resultDiv).insert({bottom:b.tbody=new Element("tbody")})}b.result.items.each(function(e){b.tbody.insert({bottom:b.me._getResultRow(e).addClassName("item_row").writeAttribute("item_id",e.id)})});if(b.me._singleProduct!==true){if(b.result.pageStats.pageNumber<b.result.pageStats.totalPages){b.resultDiv.insert({bottom:b.me._getNextPageBtn().addClassName("paginWrapper")})}}else{if(b.result.items.size()>0){b.me._displaySelectedProduct(b.result.items[0])}}}catch(f){b.resultDiv.insert({bottom:b.me.getAlertBox("Error",f).addClassName("alert-danger")})}},onComplete:function(){jQuery("#"+b.me.searchDivId+" #searchBtn").button("reset")}})},_displaySelectedProduct:function(b){var a={};a.me=this;$(a.me.resultDivId).up(".list-panel").removeClassName("col-xs-12").addClassName("col-xs-4");jQuery(".hide-when-info",jQuery("#"+a.me.resultDivId)).hide();a.me._showRightPanel=true;jQuery(".product_item.success",jQuery("#"+a.me.resultDivId)).removeClass("success").popover("hide");a.selectedRow=jQuery('[product_id="'+b.id+'"]',jQuery("#"+a.me.resultDivId)).addClass("success");if(!a.selectedRow.hasClass("popover-loaded")){a.selectedRow.popover({title:'<div class="row"><div class="col-xs-10">Details for: '+b.sku+'</div><div class="col-xs-2"><span class="btn btn-danger pull-right btn-sm" onclick="pageJs.deSelectProduct();"><span class="glyphicon glyphicon-remove"></span></span></div></div>',html:true,placement:"right",container:"body",trigger:"manual",viewport:{selector:".list-panel",padding:0},content:function(){return a.me._showProductInfoOnRightPanel(b).wrap(new Element("div")).innerHTML},template:'<div class="popover" role="tooltip" style="max-width: none; z-index: 0;"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}).addClass("popover-loaded")}a.selectedRow.popover("toggle");return a.me},_openProductDetails:function(b){var a={};console.debug(b);a.newWindow=window.open("/product/"+(b=="new"?b:b.id)+".html","Product Details for: "+b.sku,"scrollbars=yes, location=no, menubar=no, status=no, titlebar=no, fullscreen=no, toolbar=no, width=1024");a.newWindow.focus()},toggleActive:function(c,b){var a={};a.me=this;a.me.postAjax(a.me.getCallbackId("toggleActive"),{productId:b.id,active:c},{onSuccess:function(d,g){try{a.result=a.me.getResp(g,false,true);if(!a.result||!a.result.item){return}if($$(".product_item[product_id="+b.id+"]").size()>0){$$(".product_item[product_id="+b.id+"]").first().replace(a.me._getResultRow(a.result.item,false))}}catch(f){a.me.showModalBox("ERROR",f,true)}}});return a.me},_getResultRow:function(c,a){var b={};b.me=this;b.tag=(b.isTitle===true?"th":"td");b.isTitle=(a||false);b.price="";if(c.prices){c.prices.each(function(d){if(d.type&&parseInt(d.type.id)===1){b.price=d.price}})}b.row=new Element("tr",{"class":"visible-xs visible-md visible-lg visible-sm "+(b.isTitle===true?"":"product_item"),product_id:c.id}).store("data",c).insert({bottom:new Element(b.tag,{"class":"sku",title:c.name}).insert({bottom:new Element("span",{style:"margin: 0 5px 0 0;"}).insert({bottom:new Element("input",{type:"checkbox","class":"product-selected"}).observe("click",function(){b.checked=this.checked;if(b.isTitle===true){$(b.me.resultDivId).getElementsBySelector(".product_item .product-selected").each(function(d){d.checked=b.checked})}})})}).insert({bottom:b.isTitle===true?c.sku:new Element("a",{href:"javascript: void(0);","class":"sku-link"}).update(c.sku)})}).insert({bottom:new Element(b.tag,{"class":"product_name hidden-xs hide-when-info hidden-sm",style:(b.me._showRightPanel?"display: none":"")}).update(c.name)}).insert({bottom:new Element(b.tag,{"class":"product_price hidden-xs hide-when-info hidden-sm",style:(b.me._showRightPanel?"display: none":"")}).update(b.isTitle===true?"Price":(b.price.blank()?"":b.me.getCurrency(b.price)))}).insert({bottom:new Element(b.tag,{"class":"locations col-xs-1 hidden-sm"}).update(c.locations?b.me._getLocations(c.locations,a):"")}).insert({bottom:new Element(b.tag,{"class":"inventeryCode col-xs-1 hide-when-info"}).update(c.invenAccNo?c.invenAccNo:"")}).insert({bottom:new Element(b.tag,{"class":"manufacturer col-xs-1 hide-when-info"}).update(c.manufacturer?c.manufacturer.name:"")}).insert({bottom:new Element(b.tag,{"class":"supplier col-xs-1 hide-when-info hidden-sm"}).update(c.supplierCodes?b.me._getSupplierCodes(c.supplierCodes,a):"")}).insert({bottom:new Element(b.tag,{"class":"qty col-xs-1 hidden-sm"}).update(b.isTitle===true?new Element("div",{"class":"row"}).insert({bottom:new Element(b.tag,{"class":"stockOnPO col-xs-4",title:"Stock on PurchaseOrder"}).update("P")}).insert({bottom:new Element(b.tag,{"class":"stockOnHand col-xs-4",title:"Stock on hand"}).update("H")}).insert({bottom:new Element(b.tag,{"class":"stockOnOrder col-xs-4",title:"Stock on Order"}).update("O")}):new Element("div",{"class":"row"}).insert({bottom:new Element(b.tag,{"class":"stockOnPO col-xs-4",title:"Stock on PurchaseOrder"}).update(c.stockOnPO)}).insert({bottom:new Element(b.tag,{"class":"stockOnHand col-xs-4",title:"Stock on hand"}).update(c.stockOnHand)}).insert({bottom:new Element(b.tag,{"class":"stockOnOrder col-xs-4",title:"Stock on Order"}).update(c.stockOnOrder)}))}).insert({bottom:new Element(b.tag,{"class":"product_active col-xs-1 hide-when-info hidden-sm"}).insert({bottom:(b.isTitle===true?c.active:new Element("div",{"class":"row"}).insert({bottom:new Element("div",{"class":"col-xs-4"}).insert({bottom:new Element("input",{type:"checkbox",disabled:true,checked:c.active})})}).insert({bottom:new Element("div",{"class":"col-xs-8"}).insert({bottom:new Element("div",{"class":"btn-group"}).insert({bottom:new Element("span",{"class":"btn btn-primary btn-xs"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-pencil"})})}).observe("click",function(d){Event.stop(d);b.me._openProductDetails(c)}).insert({bottom:(c.active===true?new Element("span",{"class":"btn btn-danger btn-xs"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-trash"})}).observe("click",function(d){Event.stop(d);b.btn=this;if(confirm("You are about to deactivate this product.\n Continue?")){b.me.toggleActive(false,c)}}):new Element("span",{"class":"btn btn-success btn-xs"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-repeat"})}).observe("click",function(d){Event.stop(d);b.btn=this;if(confirm("You are about to ReACTIVATE this product.\n Continue?")){b.me.toggleActive(true,c)}}))})})}))})});if(b.isTitle===false){b.me.observeClickNDbClick(b.row,function(){b.me._displaySelectedProduct(c)},function(){if(b.me._singleProduct!==true){b.me._openProductDetails(c)}})}return b.row}});