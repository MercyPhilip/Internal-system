var PageJs=new Class.create;PageJs.prototype=Object.extend(new BPCPageJs,{_customer:null,_warningShowed:!1,_order:null,setOrder:function(a){return this._order=a,this},setPaymentMethods:function(a){return this._paymentMethods=a,this},setShippingMethods:function(a){return this._shippingMethods=a,this},setOrderTypes:function(a){return this._orderTypes=a,this},_getFormGroup:function(a,b){return new Element("div",{class:"form-group"}).insert({bottom:a?new Element("label",{class:"control-label"}).update(a):""}).insert({bottom:b.addClassName("form-control")})},_redirectOrder:function(a){var b={};return b.me=this,b.redirectURL=a&&a.target?jQuery(b.eventTarget).find('[window="redirec-url"]').val():jQuery('[window="redirec-url"]').val(),b.redirectURL&&!b.redirectURL.blank()&&(window.location=b.redirectURL),b.me},_preConfirmSubmit:function(a){var b={};return b.me=this,b.paidAmountBox=$$('[save-order="totalPaidAmount"]').first(),b.selectedType=jQuery('[save-order-type="type"]').val(),b.paidAmountBox&&"INVOICE"!==b.selectedType?(b.data=b.me._collectFormData($(b.me.getHTMLID("itemDiv")),"save-order"),null===b.data?b.me:b.data.totalPaidAmount&&b.data.totalPaidAmount>0?(b.newDiv=new Element("div",{class:"confirm-div"}).insert({bottom:new Element("h4",{class:"text-danger"}).update("You are recording a payment with "+b.me.getCurrency(b.data.totalPaidAmount)+" against this "+b.selectedType+", it will be push to an INVOICE.")}).insert({bottom:new Element("div",{class:"text-right"}).insert({bottom:new Element("span",{class:"btn btn-danger","data-loading-text":"Pushing..."}).update("OK").observe("click",function(){b.me._confirmSubmit(a,b.newDiv)})})}),b.me.showModalBox('<strong class="text-danger">Warning! Payments Provided:</strong>',b.newDiv,!1,null,{"hide.bs.modal":function(a){b.me._redirectOrder(a)}}),b.me):b.me._confirmSubmit(a)):b.me._confirmSubmit(a)},_confirmSubmit:function(a,b){var c={};if(c.me=this,c.printIt=!0===a,c.confirmDiv=b||null,c.data=c.me._collectFormData($(c.me.getHTMLID("itemDiv")),"save-order"),null===c.data)return c.me;if(c.data.printIt=c.printIt,c.data.type=c.data.totalPaidAmount&&c.data.totalPaidAmount>0?"INVOICE":jQuery('[save-order-type="type"]').val(),c.data.customer={},c.data.customer.id=c.me._customer.id,c.shippAddrPanel=$$(".shipping-address.address-div").first(),c.shippAddrPanel){if(c.shippAddr=c.me._collectFormData(c.shippAddrPanel,"address-editable-field"),null===c.shippAddr)return c.me;c.data.shippingAddr=c.shippAddr}return c.data.items=[],c.hasItems=!1,c.inactProductSkus=[],$$(".order-item-row").each(function(a){c.itemData=a.retrieve("data"),a.hasClassName("deactivated")||(c.hasItems=!0),c.itemData.product&&c.itemData.product.active&&!0!==c.itemData.product.active&&c.inactProductSkus.push(c.itemData.product.sku),c.data.items.push({id:c.itemData.id?c.itemData.id:"",active:!a.hasClassName("deactivated"),product:{id:c.itemData.product.id},itemDescription:c.itemData.itemDescription,unitPrice:c.itemData.unitPrice,qtyOrdered:c.itemData.qtyOrdered,totalPrice:c.itemData.totalPrice,serials:a.retrieve("serials")})}),!1===c.hasItems?(c.me.showModalBox('<strong class="text-danger">Error</strong>',"At least one order item is needed!",!0),c.me):"INVOICE"===c.data.type&&c.inactProductSkus.size()>0?(c.me.showModalBox('<strong class="text-danger">Error</strong>',"Products (SKUs:"+c.inactProductSkus.join(", ")+") are DEACTIVATED, please change them to the proper product firste before convert this to an INVOICE"),c.me):(c.data.items.each(function(a){a.totalPrice=c.me.getValueFromCurrency(a.totalPrice),""==a.totalPrice&&(a.totalPrice=0),a.unitPrice=c.me.getValueFromCurrency(a.unitPrice)}),c.newDiv=new Element("div").insert({bottom:new Element("h4").update("Have all the GOODs deliver / given to the customer?")}).insert({bottom:new Element("ul").insert({bottom:new Element("li").update(" - YES: This "+c.data.type+" will push this order to be an INVOICE and status SHIPPED")}).insert({bottom:new Element("li").update(" - NO: This "+c.data.type+" will be saved as status NEW")})}).insert({bottom:new Element("div").insert({bottom:new Element("span",{class:"btn btn-danger",title:"This will push this order to be an INVOICE and status SHIPPED"}).update("YES").observe("click",function(){c.data.type="INVOICE",c.data.shipped=!0,c.me._submitOrder(this,c.data)})}).insert({bottom:new Element("span",{class:"btn btn-primary pull-right",title:"This will push this order to be an INVOICE and status SHIPPED"}).update("NO").observe("click",function(){c.me._submitOrder(this,c.data)})})}),null===c.confirmDiv?c.me.showModalBox('<strong class="text-info">Confirmation Needed</strong>',c.newDiv,!1,null,{"hide.bs.modal":function(a){c.me._redirectOrder(a)}}):(c.confirmDiv.up(".modal-content").down(".modal-title").update('<strong class="text-info">Confirmation Needed</strong>'),c.confirmDiv.replace(c.newDiv)),c.me)},_submitOrder:function(a,b){var c={};return c.me=this,c.modalBoxPanel=$(a).up(".modal-content"),c.modalBoxTitlePanel=c.modalBoxPanel.down(".modal-title"),c.modalBoxBodyPanel=c.modalBoxPanel.down(".modal-body"),c.me._order&&c.me._order.id?b.orderId=c.me._order.id:c.me._originalOrder&&c.me._originalOrder.id&&(b.orderCloneFromId=c.me._originalOrder.id),c.me._order&&c.me._order.id||(c.newMemoDivBox=$(c.me.getHTMLID("itemDiv")).down('.memo-panel .new-memo-div [new-memo="comments"]'),c.newMemoDivBox&&(c.newMemo=$F(c.newMemoDivBox),c.newMemo.blank()||(b.newMemo=c.newMemo.strip()))),c.me._order&&c.me._order.updated&&(b.updated=c.me._order.updated),c.me.postAjax(c.me.getCallbackId("saveOrder"),b,{onLoading:function(a,b){c.modalBoxTitlePanel.update("Please wait..."),c.modalBoxBodyPanel.update('<h4>Submitting the data, please be patient.</h4><div><h3 class="fa fa-spinner fa-spin"></h3></div>')},onSuccess:function(a,d){try{if(c.result=c.me.getResp(d,!1,!0),!c.result||!c.result.item)return;c.me._order=c.me._item=c.result.item,c.redirectURL=c.result.redirectURL,c.modalBoxPanel.insert({bottom:new Element("input",{window:"redirec-url",type:"hidden",value:c.redirectURL})}),$extraMsg="",c.result.printURL&&(c.printWindow=window.open(c.result.printURL,"Printing Order","width=1300, location=no, scrollbars=yes, menubar=no, status=no, titlebar=no, fullscreen=no, toolbar=no"),c.printWindow||($extraMsg='<h4>Your browser has block the popup window, please enable it for further operations.</h4><a href="'+c.result.printURL+'" target="_BLANK"> click here for now</a>')),c.modalBoxTitlePanel.update('<strong class="text-success">Success!</strong>'),c.modalBoxBodyPanel.update('<h4 class="text-success">Saved Successfully for '+c.result.item.type+": "+c.result.item.orderNo+'</h4><div><a class="btn btn-primary" href="javascript: void(0)" onclick="pageJs.hideModalBox();"> click here to view it</a></div>'),(c.redirectURL||!b.orderId&&c.me._order.id)&&c.me._redirectOrder()}catch(a){c.modalBoxTitlePanel.update('<h4 class="text-danger">Error:</h4>'),c.modalBoxBodyPanel.update(a)}},onComplete:function(a,b){}}),c.me},_saveBtns:function(){var a={};return a.me=this,a.newDiv=new Element("div").insert({bottom:new Element("div",{class:"btn-group pull-right"}).insert({bottom:new Element("span",{class:"btn btn-primary save-btn"}).insert({bottom:new Element("span").update(" Save ")}).observe("click",function(){a.me._preConfirmSubmit(!1)})}).insert({bottom:new Element("span",{class:"btn btn-info save-btn"}).insert({bottom:new Element("span").update(" Save & Print ")}).observe("click",function(){a.me._preConfirmSubmit(!0)})})}),a.newDiv},_getAddressDiv:function(a,b,c){var d={};return d.me=this,d.address=b||null,d.editable=c||!1,d.newDiv=new Element("div",{class:"address-div"}).insert({bottom:new Element("strong").update(a)}).insert({bottom:new Element("dl",{class:"dl-horizontal dl-condensed"}).insert({bottom:new Element("dt").update(new Element("span",{class:"glyphicon glyphicon-user",title:"Customer Name"}))}).insert({bottom:new Element("dd").insert({bottom:new Element("div").insert({bottom:new Element("div",{class:"col-sm-6"}).update(!0!==d.editable?b.contactName:new Element("input",{"address-editable-field":"contactName",class:"form-control input-sm",placeholder:"The name of contact person",value:d.address.contactName?d.address.contactName:""}))}).insert({bottom:new Element("div",{class:"col-sm-6"}).update(!0!==d.editable?b.contactNo:new Element("input",{"address-editable-field":"contactNo",class:"form-control input-sm",placeholder:"The contact number of contact person",value:d.address.contactNo?d.address.contactNo:""}))}).insert({bottom:new Element("div",{class:"col-sm-6"}).update(!0!==d.editable?b.companyName:new Element("input",{"address-editable-field":"companyName",class:"form-control input-sm",placeholder:"The company name of contact person",value:d.address.companyName?d.address.companyName:""}))})})}).insert({bottom:new Element("dt").update(new Element("span",{class:"glyphicon glyphicon-map-marker",title:"Address"}))}).insert({bottom:new Element("dd").insert({bottom:new Element("div").insert({bottom:!0!==d.editable?b.street:new Element("div",{class:"street col-sm-12"}).update(new Element("input",{"address-editable-field":"street",class:"form-control input-sm",placeholder:"Street Number and Street name",value:d.address.street?d.address.street:""}))})}).insert({bottom:new Element("div").insert({bottom:!0!==d.editable?b.city+" ":new Element("div",{class:"city col-sm-6"}).update(new Element("input",{"address-editable-field":"city",class:"form-control input-sm",placeholder:"City / Suburb",value:d.address.city?d.address.city:""}))}).insert({bottom:!0!==d.editable?b.region+" ":new Element("div",{class:"region col-sm-3"}).update(new Element("input",{"address-editable-field":"region",class:"form-control input-sm",placeholder:"State / Province",value:d.address.region?d.address.region:""}))}).insert({bottom:!0!==d.editable?b.postCode:new Element("div",{class:"postcode col-sm-3"}).update(new Element("input",{"address-editable-field":"postCode",class:"form-control input-sm",placeholder:"PostCode",value:d.address.postCode?d.address.postCode:""}))})}).insert({bottom:new Element("div").insert({bottom:!0!==d.editable?b.country:new Element("div",{class:"postcode col-sm-4"}).update(new Element("input",{"address-editable-field":"country",class:"form-control input-sm",placeholder:"Country",value:d.address.country?d.address.country:""}))})})})}),!0===d.editable&&d.newDiv.writeAttribute("address-editable",!0),d.newDiv},_openCustomerDetailsPage:function(a){var b={};return b.me=this,jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/customer/"+a.id+".html?blanklayout=1",beforeClose:function(){b.customer=$$("iframe.fancybox-iframe").first().contentWindow.pageJs._item,b.customer&&b.customer.id&&b.me.selectCustomer(b.customer)}}),b.me},_checkPoNo:function(a,b){var c={};c.me=this;var d=jQuery('[save-order="poNo"]').val(),e="";if(b&&b.id&&(e=b.id),c.data={searchTxt:d,orderId:e},d)return c.me.postAjax(c.me.getCallbackId("checkPoNo"),c.data,{onLoading:function(){c.me._signRandID(a)},onSuccess:function(a,b){try{if(c.result=c.me.getResp(b,!1,!0),!c.result||!c.result.items||!c.result.items.length)return;return void alert("This PO No. has already been applied to other orders.\n Do you want to apply it again?")}catch(a){return}},onComplete:function(){}}),c.me},_deactiveOrder:function(a){var b={};if(b.me=this,b.confirmDiv=$(a).up(".confirm-div"),b.confirmDiv.getElementsBySelector(".msg").each(function(a){a.remove()}),b.data=b.me._collectFormData(b.confirmDiv,"confirm-panel"),null!==b.data)return b.data.orderId=b.me._order.id,b.me.postAjax(b.me.getCallbackId("cancelOrder"),b.data,{onLoading:function(){b.me._signRandID(a),jQuery("#"+a.id).button("loading")},onSuccess:function(a,c){try{if(b.result=b.me.getResp(c,!1,!0),!b.result||!b.result.item||!b.result.item.id)return;b.me._order=b.result.item,b.confirmDiv.update('<h4 class="text-success">This '+b.me._order.type+" has been CANCELLED successfully.</h4>"),b.me.disableEverything()}catch(a){b.confirmDiv.insert({top:new Element("h4",{class:"msg"}).update(new Element("span",{class:"label label-danger"}).update(a))})}},onComplete:function(){jQuery("#"+a.id).button("reset")}}),b.me},_showConfirmCancelOrderPanel:function(a){var b={};return b.me=this,b.newDiv=new Element("div",{class:"confirm-div"}).insert({bottom:new Element("div").insert({bottom:b.me._getFormGroup("You are about CANCEL this "+b.me._order.type+", please provide some reason:",new Element("input",{value:"","confirm-panel":"reason",required:!0,placeholder:"The Reason For CANCELLATION"}))})}).insert({bottom:new Element("div",{class:"text-right"}).insert({bottom:new Element("span",{class:"btn btn-default pull-left"}).update("CANCEL").observe("click",function(){b.me.hideModalBox()})}).insert({bottom:new Element("span",{class:"btn btn-danger","data-loading-text":"Sending ..."}).update("Yes, Cancel this "+b.me._order.type).observe("click",function(){b.me._deactiveOrder(this)})})}),b.me.showModalBox("<strong>Confirm Cancellation:</strong>",b.newDiv),b.me},_getCustomerInfoPanel:function(a){var b={};return b.me=this,b.customer=a,b.typeSelBox=new Element("select",{"save-order-type":"type"}),b.me._orderTypes.each(function(a){b.typeSelBox.insert({bottom:b.option=new Element("option",{value:a,selected:b.me._order&&b.me._order.type===a}).update(a)}).observe("change",function(){b.panels=jQuery(".panel").removeClass("panel-success").removeClass("panel-warning").removeClass("panel-default"),b.inputs=jQuery(".item_row_header").removeClass("list-group-item-success").removeClass("list-group-item-warning"),"QUOTE"===$F(this)?(b.panels.addClass("panel-warning"),b.inputs.addClass("list-group-item-warning")):"ORDER"===$F(this)?(b.panels.addClass("panel-success"),b.inputs.addClass("list-group-item-success")):b.panels.addClass("panel-default")})}),b.operationBtnsDiv=new Element("div"),b.me._order&&b.me._order.id&&b.operationBtnsDiv.update(new OrderBtnsJs(b.me,b.me._order).getBtnsDiv()).insert({bottom:new Element("btn",{class:"btn btn-danger btn-xs pull-right"}).update("CANCEL THIS "+b.me._order.type).observe("click",function(){b.me._showConfirmCancelOrderPanel(this)})}),b.address=b.me._order&&b.me._order.address?b.me._order.address:b.customer.address,b.newDiv=new Element("div",{class:"panel customer-info-div"}).insert({bottom:new Element("div",{class:"panel-heading"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-8"}).insert({bottom:new Element("strong").update((b.me._order&&b.me._order.id?"Editing":"CREATING")+" A ")}).insert({bottom:b.typeSelBox}).insert({bottom:b.me._order&&b.me._order.id?new Element("strong").update(" "+b.me._order.orderNo).setStyle("margin-left: 5px; margin-right: 25px;"):""}).insert({bottom:new Element("strong").update(" FOR:  ")}).insert({bottom:new Element("a",{href:"javascript: void(0);",class:"customer-edit-link"}).update(b.customer.name).observe("click",function(){b.me._openCustomerDetailsPage(b.customer)})}).insert({bottom:" <"}).insert({bottom:new Element("a",{href:"mailto:"+b.customer.email}).update(b.customer.email)}).insert({bottom:">"}).insert({bottom:new Element("strong").update(" with PO No.:")}).insert({bottom:new Element("input",{type:"text","save-order":"poNo",placeholder:"Optional - PO No. From Customer",value:b.me._order&&b.me._order.pONo?b.me._order.pONo:""}).setStyle("width: 200px;").observe("blur",function(){b.me._checkPoNo(this,b.me._order)})}).insert({bottom:b.me._originalOrder?new Element("span").setStyle("margin-left: 8px;").insert({bottom:new Element("strong",{class:"text-danger"}).update("CLONING FROM: ")}).insert({bottom:new Element("a",{href:"/orderdetails/"+b.me._originalOrder.id+".html",target:"_BLANK"}).update(b.me._originalOrder.orderNo)}):""}).insert({bottom:new Element("strong").update("   Terms: ")}).insert({bottom:b.customer.terms}).insert({bottom:new Element("strong").update("     Total Credit Available: ")}).insert({bottom:b.customer.creditpool?b.me.getCurrency(b.customer.creditpool.totalCreditLeft):b.me.getCurrency(0)})}).insert({bottom:new Element("div",{class:"col-sm-4"}).update(b.operationBtnsDiv)})})}).insert({bottom:new Element("div",{class:"panel-body"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("small").update(new Element("em").update(b.customer.description))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:b.me._getAddressDiv("Billing Address: ",b.address&&b.address.billing?b.address.billing:null).addClassName("col-xs-6")}).insert({bottom:b.me._getAddressDiv("Shipping Address: ",b.address&&b.address.shipping?b.address.shipping:null,!0).addClassName("col-xs-6").addClassName("shipping-address")})})}),b.newDiv},_getProductRow:function(a,b){var c={};if(c.me=this,c.isTitle=b||!1,c.tag=!0===c.isTitle?"strong":"div",c.btns=a.btns?a.btns:new Element("span",{class:"pull-right"}).insert({bottom:new Element("span",{class:"btn btn-danger btn-xs"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-trash"})}).observe("click",function(){confirm("You remove this entry.\n\nContinue?")&&(c.row=$(this).up(".item_row"),c.row&&(c.orderItem=c.row.retrieve("data"),c.orderItem.id?(c.orderItem.active=!1,c.row.store("data",c.orderItem),c.row.hide(),c.row.addClassName("deactivated")):c.row.remove()),c.me._recalculateSummary())})}),c.isTitle){var d=c.btns.down("#hide-margin-checkbox");c.me.isChecked=jQuery(d).is(":checked")}return c.row=new Element("div",{class:"list-group-item "+(!0===c.isTitle?"item_row_header":"item_row order-item-row")}).store("data",a).insert({bottom:new Element("div",{class:"row"}).store("data",a).insert({bottom:new Element(c.tag,{class:"productName col-xs-4"}).insert({bottom:a.itemDescription?a.itemDescription:a.product.shortDescription&&!a.product.shortDescription.blank()?a.product.shortDescription:a.product.name})}).insert({bottom:new Element(c.tag,{class:"uprice col-xs-1"}).insert({bottom:!0===c.isTitle||"object"==typeof a.unitPrice?a.unitPrice:c.me._getFormGroup(null,c.me._getOrderItemInputBox("order-item",c.me.getCurrency(c.me.getValueFromCurrency(a.unitPrice)),{"order-item":"unitPrice",required:!0}))})}).insert({bottom:new Element(c.tag,{class:"trprice col-xs-1"}).insert({bottom:!0===c.isTitle||"object"==typeof a.tierPrice?a.tierPrice:a.product&&47511==a.product.id?c.me._getSurchargeBtns(a.product):c.me._getTierPrices(a.product)})}).insert({bottom:new Element(c.tag,{class:"rprice col-xs-1"}).insert({bottom:!0===c.isTitle||"object"==typeof a.retailPrice?a.retailPrice:c.me._getFormGroup(null,c.me._getOrderItemInputBox("order-item",c.me.getCurrency(c.me.getValueFromCurrency(a.retailPrice)),{"order-item":"retailPrice",disabled:!0,required:!0}))})}).insert({bottom:new Element(c.tag,{class:"col-xs-2"}).insert({bottom:new Element("div").insert({bottom:new Element("div",{class:"qty col-xs-6"}).update(!0===c.isTitle||"object"==typeof a.qtyOrdered?a.qtyOrdered:c.me._getFormGroup(null,c.qtyBox=c.me._getOrderItemInputBox("order-item",a.qtyOrdered,{"order-item":"qtyOrdered",required:!0})))}).insert({bottom:new Element("div",{class:"discount col-xs-6"}).update(!0===c.isTitle||"object"==typeof a.discount?a.discount:c.me._getFormGroup(null,c.me._getOrderItemInputBox("order-item",a.discount,{"order-item":"discount"})))})})}).insert({bottom:new Element(c.tag,{class:"tprice col-xs-1"}).insert({bottom:!0===c.isTitle||"object"==typeof a.totalPrice?a.totalPrice:c.me._getFormGroup(null,c.me._getOrderItemInputBox("order-item",a.totalPrice,{"order-item":"totalPrice",disabled:!0,required:!0}))})}).insert({bottom:new Element(c.tag,{class:"btns col-xs-1 text-right"}).update(c.btns)}).insert({bottom:new Element(c.tag,{class:"margin col-xs-1 text-right",style:c.me.isChecked?"display : block":"display : none"}).update(a.margin)})}),c.qtyBox&&c.qtyBox.observe("change",function(a){if(c.qtyBox=this,c.qty=$F(this),c.serialBoxes=this.up(".order-item-row").down(".scanTable").getElementsBySelector('input[scanned-item="serialNo"]'),c.qty>c.serialBoxes.length)for(c.i=0;c.i<c.qty-c.serialBoxes.length;c.i++)c.emptySerialInputEl=c.me._getScanTableRow({}).wrap(new Element("div",{class:"col-sm-3"})),c.qtyBox.up(".order-item-row").down(".scanTable").insert({bottom:c.emptySerialInputEl});else if(c.qty<c.serialBoxes.length)for(c.i=0;c.i<c.serialBoxes.length-c.qty;c.i++)c.serialBoxes[c.serialBoxes.length-c.i-1].remove();c.emptyIput=null,c.serials=[],$(this).up(".order-item-row").down(".scanTable").getElementsBySelector('input[scanned-item="serialNo"]').each(function(a){$F(a).blank()||c.serials.push($F(a)),null===c.emptyIput&&$F(a).blank()&&(c.emptyIput=a)}),$(this).up(".order-item-row").store("serials",c.serials),null!==c.emptyIput&&c.emptyIput.select()}),a.id&&c.row.writeAttribute("item-id",a.id),a.product.sku&&c.row.down(".productName").removeClassName("col-xs-4").addClassName("col-xs-3").insert({before:new Element(c.tag,{class:"productSku col-xs-1"}).insert({bottom:a.product&&a.product.isKit&&!0===a.product.isKit?new Element("abbr",{class:"text-danger initialism",title:"This product a kit"}).setStyle("margin-right: 4px;").update(new Element("i",{class:"glyphicon glyphicon-wrench"})):""}).insert({bottom:new Element(a.product.id?"a":"span",{href:"javascript: void(0);"}).update(a.product.sku).observe("click",function(b){Event.stop(b),c.productId=a.product&&a.product.id?a.product.id:void 0,c.productId&&c.me._openProductDetailPage(c.productId)})})}),a.scanTable&&(c.row.insert({bottom:new Element("div",{class:"row product-content-row"}).insert({bottom:new Element("span",{class:"col-sm-2 show-tools"}).insert({bottom:new Element("input",{type:"checkbox",checked:!1,class:"show-panel-check"}).observe("click",function(){c.btn=this,c.panel=$(c.btn).up(".product-content-row").down(".serial-no-scan-panel"),c.btn.checked?c.panel.show():c.panel.hide()})}).insert({bottom:new Element("a",{href:"javascript: void(0);"}).update(" show serial scan panel?").observe("click",function(){$(this).up(".show-tools").down(".show-panel-check").click()})})}).insert({bottom:new Element("span",{class:"col-sm-10 serial-no-scan-panel"}).setStyle("padding-top: 5px; display: none;").update(a.scanTable)})}),a.orderItem&&a.orderItem.sellingitems&&a.orderItem.sellingitems.length>0&&(c.serials=[],a.orderItem.sellingitems.each(function(a){c.serials.push(a.serialNo)}),c.row.store("serials",c.serials))),c.row},_getSearchPrductResultRow:function(a,b){var c={};return c.me=this,c.defaultImgSrc="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZWVlIi8+PHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzIiIHk9IjMyIiBzdHlsZT0iZmlsbDojYWFhO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1zaXplOjEycHg7Zm9udC1mYW1pbHk6QXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+NjR4NjQ8L3RleHQ+PC9zdmc+",c.newRow=new Element("a",{class:"list-group-item search-product-result-row",href:"javascript: void(0);"}).store("data",a).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-2"}).insert({bottom:new Element("div",{class:"thumbnail"}).insert({bottom:new Element("img",{"data-src":"holder.js/100%x64",alert:"Product Image",src:0===a.images.size()?c.defaultImgSrc:a.images[0].asset.url})})})}).insert({bottom:new Element("div",{class:"col-xs-10"}).insert({bottom:new Element("a",{href:"javascript: void(0);"}).update(a.name.blank()?a.shortDescription:a.name).observe("click",function(a){Event.stop(a),$productId=$(this).up(".search-product-result-row").retrieve("data").id,$productId&&c.me._openProductDetailPage($productId)}).insert({bottom:new Element("small",{class:"pull-right"}).update("SKU: "+a.sku)})}).insert({bottom:new Element("div").insert({bottom:new Element("small").update(a.shortDescription)})}).insert({bottom:new Element("div").insert({bottom:new Element("small",{class:"col-xs-4"}).insert({bottom:new Element("div",{class:"input-group input-group-sm",title:"stock on HAND"}).insert({bottom:new Element("span",{class:"input-group-addon"}).update("SOH:")}).insert({bottom:new Element("strong",{class:"form-control"}).update(a.stockOnHand)})})}).insert({bottom:new Element("small",{class:"col-xs-4"}).insert({bottom:new Element("div",{class:"input-group input-group-sm",title:"stock on ORDER"}).insert({bottom:new Element("span",{class:"input-group-addon"}).update("SOO:")}).insert({bottom:new Element("strong",{class:"form-control"}).update(a.stockOnOrder)})})}).insert({bottom:new Element("small",{class:"col-xs-4"}).insert({bottom:new Element("div",{class:"input-group input-group-sm",title:"stock on PO"}).insert({bottom:new Element("span",{class:"input-group-addon"}).update("SOP:")}).insert({bottom:new Element("strong",{class:"form-control"}).update(a.stockOnPO)})})})}).insert({bottom:new Element("div").insert({bottom:new Element("div",{class:"col-xs-6"}).insert({bottom:new Element("span").update("Last UnitPrice from this customer:")}).insert({bottom:a.lastOrderItemFromCustomer&&a.lastOrderItemFromCustomer.order&&a.lastOrderItemFromCustomer.order.id?new Element("a",{href:"javascript: void(0);",title:"Last purchased unit price for this customer:"+a.lastOrderItemFromCustomer.order.orderNo}).update(c.me.getCurrency(a.lastOrderItemFromCustomer.unitPrice)).observe("click",function(b){Event.stop(b),c.win=window.open("/orderdetails/"+a.lastOrderItemFromCustomer.order.id+".html","_blank"),c.win.focus()}):"NA"})})})})}).observe("click",function(){c.inputRow=$(b).up(".new-order-item-input").store("product",a),b.up(".productName").writeAttribute("colspan",!1).update(new Element("a",{href:"javascript: void(0);"}).insert({bottom:a.isKit&&!0===a.isKit?new Element("abbr",{class:"text-danger initialism",title:"This product a kit"}).setStyle("margin-right: 4px;").update(new Element("i",{class:"glyphicon glyphicon-wrench"})):""}).insert({bottom:new Element("span").update(a.sku)}).observe("click",function(b){Event.stop(b),$productId=a.id,$productId&&c.me._openProductDetailPage($productId)})).removeClassName("col-xs-4").addClassName("col-xs-1").insert({bottom:new Element("a",{href:"javascript: void(0);",class:"text-danger pull-right",title:"click to change the product"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-remove"})}).observe("click",function(){c.newRow=c.me._getNewProductRow(),$(this).up(".new-order-item-input").replace(c.newRow),c.newRow.down("[new-order-item=product]").select()})}).insert({after:new Element("div",{class:"col-xs-3"}).update(new Element("textarea",{"new-order-item":"itemDescription"}).setStyle("width: 100%").update(a.name.blank()?a.shortDescription:a.name))}),jQuery("#"+c.me.modalId).modal("hide"),qty=$F(c.inputRow.down("[new-order-item=qtyOrdered]")).strip(),c.retailPrice=c.me._getRetailPrice(a),c.tierPrice=c.me._getTierPrice(a,qty),0==c.tierPrice&&(c.tierPrice=c.retailPrice),c.inputRow.down("[new-order-item=unitPrice]").writeAttribute("value",c.me.getCurrency(c.tierPrice)).select(),c.inputRow.down("[new-order-item=retailPrice]").writeAttribute("value",c.me.getCurrency(c.retailPrice)),$(c.inputRow.down(".trprice")).update(c.me._getTierPrices(a)),c.me._calculateNewProductPrice(c.inputRow,"new-order-item")}),c.newRow},_getLocalTime:function(){var a=new Date,b=a,c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c<10&&(c="0"+c),d<10&&(d="0"+d),e+"-"+d+"-"+c+" "+f+":"+g+":"+h},_getRetailPrice:function(a){var b={};return b.me=this,a?(b.price="",b.specilaPrice="",b.srp="",a.prices&&a.prices.each(function(a){a.type&&1===parseInt(a.type.id)?b.price=Number(a.price):a.type&&2===parseInt(a.type.id)?(now=b.me._getLocalTime(),now>=a.start&&now<=a.end&&(b.specilaPrice=Number(a.price))):a.type&&7===parseInt(a.type.id)&&(b.srp=Number(a.price))}),b.srp?b.srp:b.specilaPrice?b.specilaPrice:b.price?b.price:0):0},_getSurchargeBtns:function(a){var b={};return b.me=this,b.newDiv=new Element("div",{class:"surcharge-btns-div"}).insert({bottom:new Element("div",{class:"btn-group btn-group-xs visible-xs visible-md visible-sm visible-lg"}).setStyle("margin-left: 3px;").insert({bottom:new Element("span",{class:"btn btn-success"}).insert({bottom:new Element("span",{class:"hidden-xs hidden-sm"}).update("2%")}).observe("click",function(){b.subTotal=b.me.getValueFromCurrency(jQuery('[order-price-summary="subTotal"]').val()),b.unitInputBox=this.up(".order-item-row").down('input[order-item="unitPrice"]'),b.unitQtyInputBox=this.up(".order-item-row").down('input[order-item="qtyOrdered"]'),b.surcharge=b.me.getValueFromCurrency(jQuery(b.unitInputBox).val()),b.surchargeQty=jQuery(b.unitQtyInputBox).val(),b.subTotal=b.subTotal-b.surcharge*b.surchargeQty,b.surcharge=.02*b.subTotal,jQuery(b.unitInputBox).val(b.me.getCurrency(b.surcharge)).html(b.me.getCurrency(b.surcharge)),b.me._calculateNewProductPrice($(this).up(".item_row"),"order-item"),b.me._recalculateSummary()})})}).insert({bottom:new Element("div",{class:"btn-group btn-group-xs visible-xs visible-md visible-sm visible-lg"}).setStyle("margin-left: 3px;").insert({bottom:new Element("span",{class:"btn btn-primary"}).insert({bottom:new Element("span",{class:"hidden-xs hidden-sm"}).update("3%")}).observe("click",function(){b.subTotal=b.me.getValueFromCurrency(jQuery('[order-price-summary="subTotal"]').val()),b.unitInputBox=this.up(".order-item-row").down('input[order-item="unitPrice"]'),b.unitQtyInputBox=this.up(".order-item-row").down('input[order-item="qtyOrdered"]'),b.surcharge=b.me.getValueFromCurrency(jQuery(b.unitInputBox).val()),b.surchargeQty=jQuery(b.unitQtyInputBox).val(),b.subTotal=b.subTotal-b.surcharge*b.surchargeQty,b.surcharge=.03*b.subTotal,jQuery(b.unitInputBox).val(b.me.getCurrency(b.surcharge)).html(b.me.getCurrency(b.surcharge)),b.me._calculateNewProductPrice($(this).up(".item_row"),"order-item"),b.me._recalculateSummary()})})}),b.newDiv},_getTierPrices:function(a){var b={};return b.me=this,tiers=a.tierPrice,unitCost=0!=a.totalOnHandValue&&0!=a.stockOnHand?a.totalOnHandValue/a.stockOnHand:Number(a.buyinprice),b.price="",b.specilaPrice="",b.srp="",warning=!1,a.prices&&a.prices.each(function(a){a.type&&1===parseInt(a.type.id)?b.price=Number(a.price):a.type&&2===parseInt(a.type.id)?(now=b.me._getLocalTime(),now>=a.start&&now<=a.end&&(b.specilaPrice=Number(a.price))):a.type&&7===parseInt(a.type.id)&&(b.srp=Number(a.price))}),tiers&&unitCost?(b.tierStrings=[],tiers.each(function(a){warning=!1,1==a.tierPriceType.id?tierPrice=Number(1.1*(unitCost*(a.value/100)+unitCost)).toFixed(2):tierPrice=Number(a.value).toFixed(2),b.srp&&tierPrice>b.srp&&(warning=!0),b.specilaPrice&&tierPrice>b.specilaPrice&&(warning=!0),b.price&&tierPrice>b.price&&(warning=!0),b.tierStrings.push("<div "+(warning?'style="color : red;"':"")+'><small><strong class="hidden-xs hide-when-info hidden-sm">'+a.tierLevel.name+": </strong>"+b.me.getCurrency(tierPrice)+': <abbr title="Quantity" >'+(a.quantity>0?a.quantity:"")+" </abbr></small></div>")}),tierResult=b.tierStrings.join(""),""==tierResult&&(tierResult="&nbsp;"),tierResult):"&nbsp;"},_getTierPrice:function(a,b){if(!a)return 0;var c={};return c.me=this,tiers=a.tierPrice,unitCost=0!=a.totalOnHandValue&&0!=a.stockOnHand?a.totalOnHandValue/a.stockOnHand:0,c.price="",c.specilaPrice="",c.srp="",a.prices&&a.prices.each(function(a){a.type&&1===parseInt(a.type.id)?c.price=Number(a.price):a.type&&2===parseInt(a.type.id)?(now=c.me._getLocalTime(),now>=a.start&&now<=a.end&&(c.specilaPrice=Number(a.price))):a.type&&7===parseInt(a.type.id)&&(c.srp=Number(a.price))}),tiers&&unitCost?(tierPriceSeleted=0,tiers.each(function(a){if(1==a.tierPriceType.id?tierPrice=Number(1.1*(unitCost*(a.value/100)+unitCost)).toFixed(2):tierPrice=Number(a.value).toFixed(2),quantity=Number(a.quantity),quantity>b)return c.srp&&tierPriceSeleted>c.srp?tierPriceSeleted=c.srp:c.specilaPrice&&tierPriceSeleted>c.specilaPrice?tierPriceSeleted=c.specilaPrice:c.price&&tierPriceSeleted>c.price&&(tierPriceSeleted=c.price),tierPriceSeleted;tierPriceSeleted=tierPrice}),c.srp&&tierPriceSeleted>c.srp?tierPriceSeleted=c.srp:c.specilaPrice&&tierPriceSeleted>c.specilaPrice?tierPriceSeleted=c.specilaPrice:c.price&&tierPriceSeleted>c.price&&(tierPriceSeleted=c.price),tierPriceSeleted):0},_searchProduct:function(a,b,c){var d={};return d.me=this,d.btn=a,d.showMore=!0===$(a).retrieve("showMore"),d.pageNo=b||1,d.me._signRandID(d.btn),d.searchTxtBox=$(d.btn).up(".product-autocomplete")&&$(d.btn).up(".product-autocomplete").down(".search-txt")?$(d.btn).up(".product-autocomplete").down(".search-txt"):$($(d.btn).retrieve("searchBoxId")),d.me._signRandID(d.searchTxtBox),d.searchTxt=$F(d.searchTxtBox),d.me.postAjax(d.me.getCallbackId("searchProduct"),{searchTxt:d.searchTxt,pageNo:d.pageNo,customerId:d.me._customer?d.me._customer.id:""},{onLoading:function(){jQuery("#"+d.btn.id).button("loading")},onSuccess:function(b,e){!1===d.showMore?d.resultList=new Element("div",{class:"search-product-list"}):d.resultList=$(a).up(".search-product-list");try{if(d.result=d.me.getResp(e,!1,!0),!d.result||!d.result.items||0===d.result.items.length)throw"Nothing Found for: "+d.searchTxt;d.me._signRandID(d.searchTxtBox),d.result.items.each(function(a){d.resultList.insert({bottom:d.me._getSearchPrductResultRow(a,d.searchTxtBox)})}),d.resultList.addClassName("list-group")}catch(a){d.resultList.update(d.me.getAlertBox("Error: ",a).addClassName("alert-danger"))}"function"==typeof c&&c(),d.result.pagination.pageNumber<d.result.pagination.totalPages&&d.resultList.insert({bottom:new Element("a",{class:"item-group-item"}).insert({bottom:new Element("span",{class:"btn btn-primary","data-loading-text":"Getting more ..."}).update("Show Me More")}).observe("click",function(){d.newBtn=$(this),$(d.newBtn).store("searchBoxId",d.searchTxtBox.id),$(d.newBtn).store("showMore",!0),d.me._searchProduct(this,1*d.pageNo+1,function(){$(d.newBtn).remove()})})}),!1===d.showMore&&d.me.showModalBox("Products that has: "+d.searchTxt,d.resultList,!1)},onComplete:function(a,b){jQuery("#"+d.btn.id).button("reset")}}),d.me},_getNewProductProductAutoComplete:function(){var a={};return a.me=this,a.skuAutoComplete=a.me._getFormGroup(null,new Element("div",{class:"input-group input-group-sm product-autocomplete"}).insert({bottom:new Element("input",{class:"form-control search-txt visible-xs visible-sm visible-md visible-lg","new-order-item":"product",required:!0,placeholder:"search SKU, NAME and any BARCODE for this product"}).observe("keyup",function(b){a.txtBox=this,a.me.keydown(b,function(){$(a.txtBox).up(".product-autocomplete").down(".search-btn").click()})}).observe("keydown",function(b){a.txtBox=this,a.me.keydown(b,function(){$(a.txtBox).up(".product-autocomplete").down(".search-btn").click()},function(){},Event.KEY_TAB)})}).insert({bottom:new Element("span",{class:"input-group-btn"}).insert({bottom:new Element("span",{class:" btn btn-primary search-btn","data-loading-text":"searching..."}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-search"})}).observe("click",function(){$F($(this).up(".product-autocomplete").down(".search-txt")).blank()?$(this).up(".product-autocomplete").down(".search-txt").focus():a.me._searchProduct(this)})})})),a.skuAutoComplete.down(".input-group").removeClassName("form-control"),a.skuAutoComplete},_recalculateSummary:function(){var a={};return a.me=this,a.totalPriceIncGSTNoDicount=0,a.totalPriceIncGSTWithDiscount=0,a.totalMargin=0,$$(".item_row.order-item-row").each(function(b){a.rowData=b.retrieve("data"),!1!==a.rowData.active&&(a.totalPriceIncGSTWithDiscount=1*a.totalPriceIncGSTWithDiscount+1*a.me.getValueFromCurrency(a.rowData.totalPrice),a.totalPriceIncGSTNoDicount=1*a.totalPriceIncGSTNoDicount+a.me.getValueFromCurrency(a.rowData.unitPrice)*a.rowData.qtyOrdered,a.rowData.margin&&(a.totalMargin=1*a.totalMargin+1*a.me.getValueFromCurrency(a.rowData.margin)))}),a.totalPriceExcGST=1*a.totalPriceIncGSTWithDiscount/1.1,jQuery('[order-price-summary="totalPriceExcludeGST"]').val(a.me.getCurrency(a.totalPriceExcGST)).html(a.me.getCurrency(a.totalPriceExcGST)),a.totalGST=1*a.totalPriceIncGSTWithDiscount-1*a.totalPriceExcGST,jQuery('[order-price-summary="totalPriceGST"]').val(a.me.getCurrency(a.totalGST)).html(a.me.getCurrency(a.totalGST)),a.totalDiscount=1*a.totalPriceIncGSTNoDicount-1*a.totalPriceIncGSTWithDiscount,jQuery('[order-price-summary="totalDiscount"]').val(a.me.getCurrency(a.totalDiscount)).html(a.me.getCurrency(a.totalDiscount)),jQuery('[order-price-summary="totalPriceIncludeGST"]').val(a.me.getCurrency(a.totalPriceIncGSTWithDiscount)).html(a.me.getCurrency(a.totalPriceIncGSTWithDiscount)),a.totalShipping=jQuery('[order-price-summary="totalShippingCost"]').length>0?jQuery('[order-price-summary="totalShippingCost"]').val():0,a.subTotal=1*a.totalShipping+1*a.totalPriceIncGSTWithDiscount,jQuery('[order-price-summary="subTotal"]').val(a.me.getCurrency(a.subTotal)).html(a.me.getCurrency(a.subTotal)),a.totalPaid=jQuery('[order-price-summary="totalPaidAmount"]').length>0?jQuery('[order-price-summary="totalPaidAmount"]').val():0,a.totalDue=1*a.subTotal-1*a.totalPaid,a.totalDue<0&&!a.me._warningShowed&&(a.me._warningShowed=!0,a.me.showModalBox('<h4 class="text-danger">Attention!</h4>','<div><strong>The customer has paid more than the due amount?</strong></div><div><span class="btn btn-primary" onclick="pageJs.hideModalBox();">OK</span>',!0)),jQuery('[order-price-summary="total-payment-due"]').val(a.me.getCurrency(a.totalDue)).html(a.me.getCurrency(a.totalDue)),jQuery('[order-price-summary="total-margin"]').val(a.me.getCurrency(a.totalMargin)).html(a.me.getCurrency(a.totalMargin)),a.me},_addNewProductRow:function(a){var b={};return b.me=this,b.currentRow=$(a).up(".new-order-item-input"),b.product=b.currentRow.retrieve("product"),b.product?(b.unitPriceBox=b.currentRow.down("[new-order-item=unitPrice]"),b.unitPrice=b.me.getValueFromCurrency($F(b.unitPriceBox)),null===b.unitPrice.match(/^\d+(\.\d{1,2})?$/)?void b.me._markFormGroupError(b.unitPriceBox,"Invalid value provided!"):(b.retailPriceBox=b.currentRow.down("[new-order-item=retailPrice]"),b.retailPrice=b.me.getValueFromCurrency($F(b.retailPriceBox)),null===b.retailPrice.match(/^\d+(\.\d{1,2})?$/)?void b.me._markFormGroupError(b.retailPriceBox,"Invalid value provided!"):(b.qtyOrderedBox=b.currentRow.down("[new-order-item=qtyOrdered]"),b.qtyOrdered=b.me.getValueFromCurrency($F(b.qtyOrderedBox)),null===b.qtyOrdered.match(/^\d+(\.\d{1,2})?$/)||0==b.qtyOrdered?void b.me._markFormGroupError(b.qtyOrderedBox,"Invalid value provided!"):(b.discountBox=b.currentRow.down("[new-order-item=discount]"),b.discount=b.me.getValueFromCurrency($F(b.discountBox)),null===b.discount.match(/^\d+(\.\d{1,2})?$/)?void b.me._markFormGroupError(b.discountBox,"Invalid value provided!"):(b.totalPriceBox=b.currentRow.down("[new-order-item=totalPrice]"),b.totalPrice=b.me.getValueFromCurrency($F(b.totalPriceBox)),null===b.totalPrice.match(/^\d+(\.\d{1,2})?$/)?void b.me._markFormGroupError(b.totalPriceBox,"Invalid value provided!"):(b.currentRow.getElementsBySelector(".form-group.has-error .form-control").each(function(a){$(a).retrieve("clearErrFunc")()}),b.itemDescription=$F(b.currentRow.down("[new-order-item=itemDescription]")).replace(/\n/g,"<br />"),b.data={product:b.product,itemDescription:b.itemDescription,unitPrice:b.me.getCurrency(b.unitPrice),tierPrice:b.me.getCurrency(b.unitPrice),retailPrice:b.me.getCurrency(b.retailPrice),qtyOrdered:b.qtyOrdered,discount:b.discount,margin:b.me.getCurrency(parseFloat(b.totalPrice)-parseFloat(1.1*b.product.unitCost*b.qtyOrdered)),totalPrice:b.me.getCurrency(b.totalPrice)},b.data.scanTable=b.me._getScanTable(b.data),b.currentRow.up(".list-group").insert({bottom:b.itemRow=b.me._getProductRow(b.data)}),b.newRow=b.me._getNewProductRow(),b.currentRow.replace(b.newRow).addClassName(),b.newRow.down("[new-order-item=product]").focus(),b.me._recalculateSummary(),b.me)))))):(b.productBox=b.currentRow.down("[new-order-item=product]"),void(b.currentRow.down("[new-order-item=product]")?b.me._markFormGroupError(b.productBox,"Select a product first!"):b.me.showModalBox("Product Needed","Select a product first!",!0)))},_getScanTable:function(a){var b={};for(b.me=this,b.item=a,b.newDiv=new Element("div",{class:"scanTable"}),b.i=0;b.i<a.qtyOrdered;b.i++)b.sellingitem=b.item.sellingitems&&b.item.sellingitems[b.i]&&jQuery.isNumeric(b.item.sellingitems[b.i].id)?b.item.sellingitems[b.i]:{},b.newDiv.insert({bottom:b.me._getScanTableRow(b.sellingitem).wrap(new Element("div",{class:"col-sm-3"}))});return b.newDiv},_getScanTableRow:function(a){var b={};return b.me=this,b.newDiv=new Element("div").update(new Element("input",{class:"form-control","scanned-item":"serialNo",type:"text",placeholder:"Serial Number:",value:a.serialNo&&""!==a.serialNo?a.serialNo:""}).observe("change",function(){b.emptyIput=null,b.serials=[],$(this).up(".scanTable").getElementsBySelector('input[scanned-item="serialNo"]').each(function(a){$F(a).blank()||b.serials.push($F(a)),null===b.emptyIput&&$F(a).blank()&&(b.emptyIput=a)}),$(this).up(".order-item-row").store("serials",b.serials),null!==b.emptyIput&&b.emptyIput.select()})),a&&a.kit&&a.kit.id&&b.newDiv.addClassName("input-group input-group-sm").insert({bottom:new Element("a",{class:"input-group-addon btn btn-primary",href:"/kit/"+a.kit.id+".html",target:"_BLANK"}).insert({bottom:new Element("i",{class:"glyphicon glyphicon-link"})})}),b.newDiv},_calculateNewProductPrice:function(a,b){var c={};return c.me=this,c.row=a,c.unitPrice=c.me.getValueFromCurrency($F(c.row.down("["+b+"=unitPrice]"))),c.discount=$F(c.row.down("["+b+"=discount]")).strip().replace("%",""),c.qty=$F(c.row.down("["+b+"=qtyOrdered]")).strip(),c.totalPrice=c.unitPrice*(1-c.discount/100)*c.qty,$(c.row.down("["+b+"=totalPrice]")).value=c.me.getCurrency(c.totalPrice),c.product=a.retrieve("product")?a.retrieve("product"):a.retrieve("data")&&a.retrieve("data").product?a.retrieve("data").product:{},c.product.id&&(c.unitCost=c.product.unitCost,c.margin=c.me.getCurrency(1*c.totalPrice-1.1*c.unitCost*c.qty),c.row.down(".margin")&&$(c.row.down(".margin")).update(c.margin+(0===parseInt(c.unitCost)?'<div><small class="label label-danger">No Cost Yet</small</div>':""))),c.rowData=c.row.retrieve("data"),c.rowData.unitPrice=c.unitPrice,c.rowData.discount=c.discount,c.rowData.qtyOrdered=c.qty,c.rowData.totalPrice=c.totalPrice,c.margin&&(c.rowData.margin=c.margin),c.row.store("data",c.rowData),c.me},_bindSubmitNewProductRow:function(a,b){var c={};return c.me=this,c.txtBox=b,c.me.keydown(a,function(){$(c.txtBox)&&$(c.txtBox).up(".item_row")&&$(c.txtBox).up(".item_row").down(".save-new-product-btn")&&$(c.txtBox).up(".item_row").down(".save-new-product-btn").click()}),c.me},_getOrderItemInputBox:function(a,b,c,d,e,f){var g={};return g.me=this,g.newInput=Element("input",{class:"input-sm",value:b}).observe("click",function(a){"function"==typeof d&&d(a)}).observe("keydown",function(a){"function"==typeof e?e(a):g.me._bindSubmitNewProductRow(a,this)}).observe("keyup",function(b){if("function"==typeof f)f(b);else try{g.me._calculateNewProductPrice($(this).up(".item_row"),a),g.me._recalculateSummary()}catch(a){g.me.showModalBox("Error",a)}}),$H(c).each(function(a){g.newInput.writeAttribute(a.key,a.value)}),g.newInput},_getNewProductRow:function(){var a={};return a.me=this,a.skuAutoComplete=a.me._getNewProductProductAutoComplete(),a.data={product:{name:a.skuAutoComplete},unitPrice:a.me._getFormGroup(null,a.me._getOrderItemInputBox("new-order-item",a.me.getCurrency(0),{"new-order-item":"unitPrice",required:!0})),tierPrice:"",retailPrice:a.me._getFormGroup(null,a.me._getOrderItemInputBox("new-order-item",a.me.getCurrency(0),{"new-order-item":"retailPrice",required:!0,disabled:!0})),qtyOrdered:a.me._getFormGroup(null,a.me._getOrderItemInputBox("new-order-item",1,{"new-order-item":"qtyOrdered",required:!0})),discount:a.me._getFormGroup(null,a.me._getOrderItemInputBox("new-order-item",0,{"new-order-item":"discount"})),totalPrice:a.me._getFormGroup(null,a.me._getOrderItemInputBox("new-order-item",a.me.getCurrency(0),{"new-order-item":"totalPrice",required:!0,disabled:!0})),margin:a.me.getCurrency(0),btns:new Element("span",{class:"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{class:"btn btn-primary"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-floppy-saved save-new-product-btn"})}).observe("click",function(){a.me._addNewProductRow(this)})}).insert({bottom:new Element("span",{class:"btn btn-default"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-floppy-remove"})}).observe("click",function(){confirm("You about to clear this entry. All input data for this entry will be lost.\n\nContinue?")&&(a.newRow=a.me._getNewProductRow(),a.currentRow=$(this).up(".new-order-item-input"),a.currentRow.getElementsBySelector(".form-group.has-error .form-control").each(function(a){$(a).retrieve("clearErrFunc")()}),a.currentRow.replace(a.newRow),a.newRow.down("[new-order-item=product]").focus())})})},a.me._getProductRow(a.data,!1).addClassName("new-order-item-input list-group-item-info").removeClassName("order-item-row")},_getPartsTable:function(){var a={};return a.me=this,a.productListDiv=new Element("div",{class:"list-group order_item_list_table"}).insert({bottom:a.me._getProductRow({product:{sku:"SKU",name:"Description",shortDescription:"Description"},unitPrice:"Unit Price<div><small>(inc GST)</small><div>",tierPrice:"Tier Price<div><small>(inc GST)</small><div>",retailPrice:"Retail Price<div><small>(inc GST)</small><div>",qtyOrdered:"Qty",margin:"Margin",discount:"Disc. %",totalPrice:"Total Price<div><small>(inc GST)</small><div>",btns:new Element("div").insert({bottom:new Element("label",{for:"hide-margin-checkbox"}).update("Show Margin ")}).insert({bottom:new Element("input",{id:"hide-margin-checkbox",type:"checkbox",checked:!1}).observe("click",function(){a.me.isChecked=jQuery("#hide-margin-checkbox").is(":checked"),jQuery(".margin").toggle()})})},!0)}),a.productListDiv.insert({bottom:a.me._getNewProductRow().addClassName("list-group-item-info")}),a.productListDiv},_getShippingCostBox:function(a){var b={};return b.me=this,b.shippingCostBox=new Element("input",{"order-price-summary":"totalShippingCost",class:"form-control input-sm","save-order":"totalShippingCost",placeholder:b.me.getCurrency(0),required:!0,validate_currency:"Invalid number provided!",value:a||0}).observe("keyup",function(){b.me._recalculateSummary()}),b.shippingCostBox.wrap(new Element("div",{class:"form-group"}))},_getSummaryFooter:function(){var a={};return a.me=this,a.shippingMethodSel=new Element("select",{class:"form-control input-sm","save-order":"courierId",required:!0}).insert({bottom:new Element("option",{value:""}).update("Shipping Via:")}),a.shippingMethod=a.me._order&&a.me._order.infos[9]?a.me._order.infos[9][0].value:"",a.shippingCost=a.me._order&&a.me._order.infos[14]?a.me.getValueFromCurrency(a.me._order.infos[14][0].value):"",a.foundMatchedShippingMethod=!1,a.me._shippingMethods.each(function(b){a.sameShippingMethod=b.name.strip()===a.shippingMethod.strip(),a.shippingMethodSel.insert({bottom:new Element("option",{value:b.id,selected:a.sameShippingMethod}).update(b.name)}),!1===a.foundMatchedShippingMethod&&!0===a.sameShippingMethod&&(a.foundMatchedShippingMethod=a.sameShippingMethod)}),a.shippingMethod.blank()||!1!==a.foundMatchedShippingMethod||a.shippingMethodSel.insert({bottom:new Element("option",{value:a.shippingMethod,selected:!0}).update(a.shippingMethod.stripTags())}),a.paymentMethodSel=new Element("select",{class:"form-control input-sm","save-order":"paymentMethodId"}).insert({bottom:new Element("option",{value:""}).update("Paid Via:")}),a.me._paymentMethods.each(function(b){a.paymentMethodSel.insert({bottom:new Element("option",{value:b.id}).update(b.name)})}),a.newDiv=new Element("div",{class:"panel-footer"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-8"}).insert({bottom:a.me._order&&a.me._order.id?new Element("div",{class:"comments-div-wrapper"}).store("CommentsDivJs",new CommentsDivJs(a.me,"Order",a.me._order.id)):a.me._getFormGroup("Comments:",new Element("textarea",{"save-order":"comments",rows:"8"}))})}).insert({bottom:new Element("div",{class:"col-sm-4"}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Total Excl. GST: "))}).insert({bottom:new Element("div",{class:"col-xs-6","order-price-summary":"totalPriceExcludeGST"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Total GST: "))}).insert({bottom:new Element("div",{"order-price-summary":"totalPriceGST",class:"col-xs-6"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row",style:"border-bottom: 1px solid brown"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Total Discount:"))}).insert({bottom:new Element("div",{"order-price-summary":"totalDiscount",class:"col-xs-6"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Sub Total Incl. GST: "))}).insert({bottom:new Element("div",{"order-price-summary":"totalPriceIncludeGST",class:"col-xs-6"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row",style:"border-bottom: 1px solid brown"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(a.me._getFormGroup("",a.shippingMethodSel.observe("change",function(){a.btn=this,$(a.btn).up(".row").down(".input-field").update($F(a.btn).blank()?a.me.getCurrency(0):a.shippingCostBox=a.me._getShippingCostBox()),a.me._recalculateSummary(),a.shippingCostBox&&a.shippingCostBox.select()})))}).insert({bottom:new Element("div",{class:"col-xs-6 input-field"}).update(""===a.shippingCost?a.me.getCurrency(0):a.me._getShippingCostBox(a.shippingCost))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Total Incl. GST:"))}).insert({bottom:new Element("strong",{"order-price-summary":"subTotal",class:"col-xs-6"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row",style:"border-bottom: 1px solid brown"}).insert({bottom:new Element("div",{class:"col-xs-6 text-right"}).update(new Element("strong").update(a.paymentMethodSel.observe("change",function(){a.btn=this,$(a.btn).up(".row").down(".input-field").update($F(a.btn).blank()?a.me.getCurrency(0):new Element("span",{class:"form-group"}).update(a.paidAmountBox=new Element("input",{value:"5"===$F(a.btn).strip()?"0":"","order-price-summary":"totalPaidAmount",class:"form-control input-sm","save-order":"totalPaidAmount",placeholder:a.me.getCurrency(0),required:!0,validate_currency:"Invalid number provided!"}).observe("keyup",function(){a.me._recalculateSummary()}))),a.me._recalculateSummary(),a.paidAmountBox&&a.paidAmountBox.select()})))}).insert({bottom:new Element("div",{class:"col-xs-6 input-field"}).update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("h4",{class:"col-xs-6 text-right"}).setStyle("color: #d30014 !important").update(new Element("strong").update("DUE:"))}).insert({bottom:new Element("h4",{class:"col-xs-6","order-price-summary":"total-payment-due"}).setStyle("color: #d30014 !important").update(a.me.getCurrency(0))})}).insert({bottom:new Element("div",{class:"row margin",style:a.me.isChecked?"display : block":"display : none"}).insert({bottom:new Element("strong",{class:"col-xs-6 text-right"}).update(new Element("strong").update("Margin Total Incl. GST:"))}).insert({bottom:new Element("strong",{class:"col-xs-6","order-price-summary":"total-margin"}).update(a.me.getCurrency(0))})})})}),a.newDiv},_getViewOfOrder:function(){var a={};return a.me=this,a.newDiv=new Element("div").insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-12"}).update(a.me._getCustomerInfoPanel(a.me._customer))})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-8 memo-panel"}).store("lastMemoJs",a.lastMemoJs=new LastMemoPanelJs(a.me,"Order",a.me._order&&a.me._order.id?a.me._order.id:"",!0)).update(a.lastMemoJs?a.lastMemoJs._getPanel():"")}).insert({bottom:new Element("div",{class:"col-sm-4 taskListPanel"})})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-12"}).insert({bottom:new Element("div",{class:"panel"}).update(a.me._getPartsTable()).insert({bottom:a.me._getSummaryFooter()})})})}).insert({bottom:new Element("div",{class:"row"}).insert({bottom:new Element("div",{class:"col-sm-12"}).update(a.me._saveBtns())})}),a.newDiv},selectCustomer:function(a){var b={};return b.me=this,b.resultDiv=$(b.me.getHTMLID("itemDiv")),b.me._customer=a,b.resultListDiv=b.resultDiv.down(".order_item_list_table"),b.resultListDiv&&b.resultListDiv.getElementsBySelector(".item_row.order-item-row").size()>0?b.resultDiv.down(".customer-info-div").replace(b.me._getCustomerInfoPanel(a)):(b.resultListDiv=b.me._getViewOfOrder(),b.commentsDiv=b.resultDiv.update(b.resultListDiv).down(".comments-div-wrapper"),b.commentsDiv&&b.commentsDiv.retrieve("CommentsDivJs")._setDisplayDivId(b.commentsDiv).render()),b.resultDiv.down(".memo-panel").retrieve("lastMemoJs").load(),b.resultListDiv.down('.new-order-item-input [new-order-item="product"]').focus(),b.me},_getCustomerRow:function(a,b){var c={};return c.me=this,c.isTitle=b||!1,c.tag=!0===c.isTitle?"th":"td",c.newDiv=new Element("tr").store("data",a).insert({bottom:new Element(c.tag).insert({bottom:!0===c.isTitle?"&nbsp;":new Element("span",{class:"btn btn-primary btn-xs"}).update("select").observe("click",function(){c.me.selectCustomer(a),c.panels=jQuery(".panel").removeClass("panel-success").removeClass("panel-warning").removeClass("panel-default").addClass("panel-warning"),c.inputs=jQuery(".item_row_header").removeClass("list-group-item-success").removeClass("list-group-item-warning").addClass("list-group-item-warning")})})}).insert({bottom:new Element(c.tag).update(a.name)}).insert({bottom:new Element(c.tag).update(a.email)}).insert({bottom:new Element(c.tag).update(a.address&&a.address.billing?a.address.billing.full:"")}),c.newDiv},_searchCustomer:function(a,b){var c={};return c.me=this,c.pageNo=b||1,c.searchPanel=$(a).up("#"+c.me.getHTMLID("searchPanel")),c.searchTxt=$F(c.searchPanel.down(".search-txt")).strip(),c.me.postAjax(c.me.getCallbackId("searchCustomer"),{searchTxt:c.searchTxt,pageNo:c.pageNo},{onCreate:function(){c.me._signRandID(a),jQuery("#"+a.id).button("loading"),1===c.pageNo&&($(c.searchPanel).down(".list-div")&&$(c.searchPanel).down(".list-div").remove(),$(c.searchPanel).insert({bottom:new Element("div",{class:"panel-body"}).update(c.me.getLoadingImg())}))},onSuccess:function(a,b){try{if(c.result=c.me.getResp(b,!1,!0),!c.result||!c.result.items)return;1===c.pageNo?($(c.searchPanel).down(".panel-body").remove(),$(c.searchPanel).insert({bottom:new Element("small",{class:"table-responsive list-div"}).insert({bottom:new Element("table",{class:"table table-hover table-condensed"}).insert({bottom:new Element("thead").insert({bottom:c.me._getCustomerRow({name:"Customer Name",email:"Email",address:{billing:{full:"Address"}}},!0)})}).insert({bottom:c.listDiv=new Element("tbody")})})})):c.listDiv=$(c.searchPanel).down("tbody"),$(c.searchPanel).down(".get-more-btn-wrapper")&&$(c.searchPanel).down(".get-more-btn-wrapper").remove(),c.result.items.each(function(a){c.listDiv.insert({bottom:c.me._getCustomerRow(a)})}),c.result.pagination.pageNumber<c.result.pagination.totalPages&&c.listDiv.insert({bottom:new Element("tr",{class:"get-more-btn-wrapper"}).insert({bottom:new Element("td").insert({bottom:new Element("span",{class:"btn btn-primary","data-loading-text":"Getting More ..."}).update("Get more").observe("click",function(){c.me._searchCustomer(this,1*c.pageNo+1)})})})})}catch(a){1===c.pageNo?$(c.searchPanel).insert({bottom:new Element("div",{class:"panel-body"}).update(c.me.getAlertBox("ERROR",a).addClassName("alert-danger"))}):c.me.showModalBox('<strong class="text-danger">Error:</strong>',a)}},onComplete:function(){jQuery("#"+a.id).button("reset")}}),c.me},_getCustomerListPanel:function(){var a={};return a.me=this,a.newDiv=new Element("div",{id:a.me.getHTMLID("searchPanel"),class:"panel panel-default search-panel"}).insert({bottom:new Element("div",{class:"panel-heading form-inline"}).insert({bottom:new Element("strong").update("Creating a new order for: ")}).insert({bottom:new Element("span",{class:"input-group col-sm-6"}).insert({bottom:new Element("input",{class:"form-control search-txt init-focus",placeholder:"customer name or email"}).observe("keyup",function(b){$(a.me.getHTMLID("searchPanel")).down(".search-btn").click()})}).insert({bottom:new Element("span",{class:"input-group-btn search-btn"}).insert({bottom:new Element("span",{class:" btn btn-primary","data-loading-text":"Searching ..."}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-search"})})}).observe("click",function(){a.btn=this,a.me._searchCustomer(a.btn,1)})})}).insert({bottom:new Element("span",{class:"btn btn-success pull-right btn-sm"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-plus-sign"})}).insert({bottom:" NEW"}).observe("click",function(){a.me._openNewCustomerPage()})})}),a.newDiv},_openNewCustomerPage:function(a){var b={};return b.me=this,jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/customer/new.html",beforeClose:function(){b.newCustomer=$$("iframe.fancybox-iframe").first().contentWindow.pageJs._item,b.newCustomer.id&&b.me.selectCustomer(b.newCustomer)}}),b.me},_openProductDetailPage:function(a){var b={};return b.me=this,b.newWindow=window.open("/product/"+a+".html","_BLANK"),b.newWindow.focus(),b.me},setOriginalOrder:function(a){var b={};return b.me=this,b.me._originalOrder=a,b.me},_populateOrderItems:function(a,b){var c={};return c.me=this,c.keepSerialNos=b||!1,a.size()>0&&(c.productListDiv=$(c.me.getHTMLID("itemDiv")).down(".order_item_list_table"),a.each(function(a){!0!==c.keepSerialNos&&(a.sellingitems=[]),c.unitPriceValue=c.me.getValueFromCurrency(a.unitPrice),c.totalPriceValue=c.me.getValueFromCurrency(a.totalPrice),c.shouldTotalPriceValue=c.me.getValueFromCurrency(c.unitPriceValue*a.qtyOrdered),c.data={id:a.id,product:a.product,itemDescription:a.itemDescription,unitPrice:c.me.getCurrency(c.unitPriceValue),tierPrice:c.me.getCurrency(c.unitPriceValue),retailPrice:c.me.getCurrency(c.me._getRetailPrice(a.product)),qtyOrdered:a.qtyOrdered,discount:0===Math.ceil(c.shouldTotalPriceValue)?0:Math.round(100*(c.shouldTotalPriceValue-c.totalPriceValue)/c.shouldTotalPriceValue),margin:c.me.getCurrency(c.me.getValueFromCurrency(a.margin)),totalPrice:c.me.getCurrency(c.totalPriceValue),scanTable:c.me._getScanTable(a),orderItem:c.me._order&&c.me._order.id?a:{}},c.productListDiv.insert({bottom:c.me._getProductRow(c.data)})}),c.me._recalculateSummary()),c.me},init:function(a){var b={};return b.me=this,b.className="warning",b.me._order&&b.me._order.id?(b.me.selectCustomer(b.me._order.customer)._populateOrderItems(b.me._order.items,!0),b.className="QUOTE"===b.me._order.type?"warning":"ORDER"===b.me._order.type?"success":"default",b.taskListPanel=$(b.me.getHTMLID("itemDiv")).down(".taskListPanel"),b.taskListPanel&&(b.taskListPanel.store("taskListPanelJs",b.taskStatusListPanelJs=new TaskStatusListPanelJs(b.me)).update(b.taskStatusListPanelJs.getDiv("Order",b.me._order)),b.taskStatusListPanelJs.setOpenInFancyBox("1"!==b.me.getUrlParam("blanklayout")).render())):a?b.me.selectCustomer(a):b.me._originalOrder?(b.me.selectCustomer(b.me._originalOrder.customer)._populateOrderItems(b.me._originalOrder.items,!1),b.className="QUOTE"===b.me._originalOrder.type?"warning":"ORDER"===b.me._originalOrder.type?"success":"default"):$(b.me.getHTMLID("itemDiv")).update(b.me._getCustomerListPanel()),b.panels=jQuery(".panel").removeClass("panel-success").removeClass("panel-warning").removeClass("panel-default").addClass("panel-"+b.className),b.inputs=jQuery(".item_row_header").removeClass("list-group-item-success").removeClass("list-group-item-warning").addClass("list-group-item-"+b.className),$$(".init-focus").size()>0&&$$(".init-focus").first().focus(),b.me},disableEverything:function(a){var b={};return b.me=this,b.canEditPayment=a||!1,jQuery(".btn").not(".new_comments_wrapper #add_new_comments_btn").attr("disabled",!0),jQuery("input").attr("disabled",!0),jQuery("select").attr("disabled",!0),jQuery(".form-control").attr("disabled",!0),jQuery(".new-order-item-input").remove(),jQuery(".customer-edit-link").replaceWith(jQuery(".customer-edit-link").html()),jQuery(".new_comments_wrapper input").attr("disabled",!1),!0===b.canEditPayment&&(jQuery('[save-order="paymentMethodId"]').attr("disabled",!1),jQuery(".save-btn").attr("disabled",!1)),b.me}});