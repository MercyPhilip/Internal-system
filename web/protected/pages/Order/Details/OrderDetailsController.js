var PageJs=new Class.create();PageJs.prototype=Object.extend(new BPCPageJs(),{_order:null,_orderStatuses:[],_orderItems:[],_resultDivId:"",_editMode:{purchasing:false,warehouse:false,accounting:false,status:false},_commentsDiv:{pagination:{pageSize:10,pageNo:1},resultDivId:"",type:""},infoType_custName:1,infoType_custEmail:2,setEditMode:function(b,d,a,c){this._editMode.purchasing=(b||false);this._editMode.warehouse=(d||false);this._editMode.accounting=(a||false);this._editMode.status=(c||false);return this},setOrder:function(a,b,c){this._order=a;this._orderItems=b;this._orderStatuses=c;return this},_getAddressDiv:function(a,b){return new Element("div",{"class":"addr"}).insert({bottom:new Element("div",{"class":"title"}).update(a)}).insert({bottom:new Element("div",{"class":"addr_content"}).insert({bottom:new Element("div",{"class":"contactName"}).update(b.contactName)}).insert({bottom:new Element("div",{"class":"street"}).update(b.street)}).insert({bottom:new Element("div").insert({bottom:new Element("span",{"class":"city inlineblock"}).update(b.city)}).insert({bottom:new Element("span",{"class":"region inlineblock"}).update(b.region)}).insert({bottom:new Element("span",{"class":"postcode inlineblock"}).update(b.postCode)})})})},_getfieldDiv:function(b,a){return new Element("span",{"class":"fieldDiv"}).insert({bottom:new Element("span",{"class":"fieldDiv_title"}).update(b)}).insert({bottom:new Element("span",{"class":"fieldDiv_content"}).update(a)})},_getHasStockSel:function(d,c,a){var b={};b.selBox=new Element("select",{"class":"hasStock"}).insert({bottom:new Element("option",{value:""}).update(d)}).insert({bottom:new Element("option",{value:"Y"}).update("YES")}).insert({bottom:new Element("option",{value:"N"}).update("NO")}).observe("change",a);if(!c.blank()){b.options=b.selBox.getElementsBySelector("option");for(b.i=0;b.i<b.options.size();b.i++){if(b.options[b.i].value===c){b.options[b.i].selected=true}}}return b.selBox},_showLastestComments:function(b){var a={};return new Element("div",{"class":"comments"}).insert({bottom:new Element("div",{"class":"lastest"}).update(!b?"N/A":b[0])})},_getPurchasingCell:function(a){var b={};b.me=this;b.hasStock=(a.eta===""?"":(a.eta==="0001-01-01 00:00:00"?"Y":"N"));if(b.me._editMode.purchasing===false){b.newDiv=new Element("div",{"class":"order_item_details"});if(b.hasStock===""){return b.newDiv.update("N/A")}return b.newDiv.insert({bottom:b.me._getfieldDiv("hasStock?: ",b.hasStock)}).insert({bottom:b.me._getfieldDiv("ETA: ",a.eta)}).insert({bottom:b.me._getfieldDiv("Comments: ",b.me._showLastestComments())})}b.getEditDiv=function(d,c){b.etaBox=new Element("input",{type:"text",placeholder:"ETA:",update_order_item:"eta",id:"order_item_"+a.id,readonly:true,value:c?c:""});return new Element("div").insert({bottom:b.me._getfieldDiv("ETA:",b.etaBox)}).insert({bottom:b.me._getfieldDiv("Comments: ",new Element("input",{update_order_item:"comments",placeholder:"The reason"}))}).insert({bottom:new Element("a",{href:"javascript: void(0);"}).update("cancel").observe("click",function(){$(this).up(".operationDiv").update(b.me._getHasStockSel("Has Stock?",d,b.func))})})};b.func=function(){$(this).up(".cell").getElementsBySelector(".msgDiv").each(function(c){c.remove()});if($F(this)==="N"){$(this).up(".operationDiv").update(b.getEditDiv(b.hasStock));new Prado.WebUI.TDatePicker({ID:"order_item_"+a.id,InputMode:"TextBox",Format:"yyyy-MM-dd 17:00:00",FirstDayOfWeek:1,CalendarStyle:"default",FromYear:2009,UpToYear:2024,PositionMode:"Bottom"})}else{$(this).up(".operationDiv").insert({bottom:new Element("input",{type:"hidden",update_order_item:"eta",value:"0001-01-01 00:00:00"})})}};if(b.hasStock==="N"){return new Element("div",{"class":"operationDiv"}).update(b.getEditDiv("",a.eta))}return b.me._getHasStockSel("Has Stock?",b.hasStock,b.func).wrap(new Element("div",{"class":"operationDiv"}))},_getWarehouseCell:function(a){var b={};b.me=this;if(b.me._editMode.warehouse===false){return new Element("div",{"class":"order_item_details"}).insert({bottom:b.me._getfieldDiv("Picked?: ",a.isPicked?"Y":"N")}).insert({bottom:b.me._getfieldDiv("Comments: ",b.me._showLastestComments())})}b.func=function(){$(this).up(".cell").getElementsBySelector(".msgDiv").each(function(c){c.remove()});if($F(this)==="N"){$(this).up(".operationDiv").update(new Element("div").insert({bottom:b.me._getfieldDiv("Comments: ",new Element("input",{pick_order_item:"comments",placeholder:"The reason"}))}).insert({bottom:new Element("a",{href:"javascript: void(0);"}).update("cancel").observe("click",function(){$(this).up(".operationDiv").update(b.me._getHasStockSel("Is Picked?","",b.func))})}).insert({bottom:new Element("input",{type:"hidden",pick_order_item:"isPicked",value:$F(this)})}))}else{$(this).up(".operationDiv").insert({bottom:new Element("input",{type:"hidden",pick_order_item:"isPicked",value:$F(this)})})}};return b.me._getHasStockSel("Is Picked?","",b.func).wrap(new Element("div",{"class":"operationDiv"}))},_getProductRow:function(b,a){var c={};c.me=this;c.isTitle=(a||false);c.newDiv=new Element("div",{"class":"row "+(c.isTitle===true?"":"productRow")}).store("data",b).insert({bottom:new Element("span",{"class":"inlineblock cell sku"}).update(b.product.sku)}).insert({bottom:new Element("span",{"class":"inlineblock cell productName"}).update(b.product.name)}).insert({bottom:new Element("span",{"class":"inlineblock cell uprice"}).update(c.isTitle===true?b.unitPrice:c.me.getCurrency(b.unitPrice))}).insert({bottom:new Element("span",{"class":"inlineblock cell qty"}).update(b.qtyOrdered)}).insert({bottom:new Element("span",{"class":"inlineblock cell tprice"}).update(c.isTitle===true?b.totalPrice:c.me.getCurrency(b.totalPrice))}).insert({bottom:new Element("span",{"class":"inlineblock cell purchasing"}).update(c.isTitle===true?"Purchasing":c.me._getPurchasingCell(b))}).insert({bottom:new Element("span",{"class":"inlineblock cell warehouse"}).update(c.isTitle===true?"Warehouse":c.me._getWarehouseCell(b))});return c.newDiv},_changeOrderStatus:function(b){var a={};a.me=this;a.msg="About to change the status of this order?\n Continue?";if(confirm(a.msg)){a.comments="";while(a.comments!==null&&a.comments.blank()){a.comments=window.prompt("Please Type in the reason for changing:")}if(a.comments===null){$(b).replace(a.me._getOrderStatus());return this}a.me.postAjax(a.me.getCallbackId("changeOrderStatus"),{order:a.me._order,orderStatusId:$F(b),comments:a.comments},{onLoading:function(c,d){$(b).disabled=true},onComplete:function(c,f){try{a.result=a.me.getResp(f,false,true);alert("Saved Successfully!");location.reload()}catch(d){alert(d);$(b).disabled=false;$(b).replace(a.me._getOrderStatus())}}});return this}$(b).replace(a.me._getOrderStatus());return this},_submitPaymentConfirmation:function(b){var a={};a.me=this;a.paidAmount=$F($(b).up(".wrapper").down("#paidAmount"));a.confDiv=$(b).up("#extraConfDiv");a.extraComment="";$(b).up(".wrapper").getElementsBySelector(".msgDiv").each(function(c){c.remove()});if(a.paidAmount===null||a.paidAmount.blank()||isNaN(a.paidAmount)){alert("Paid Amount is NOT valid");return this}a.amtDiff=Math.abs(a.confDiv.down("#paidAmtDiff").value);a.hasErr=false;if(a.amtDiff!==0){a.confDiv.getElementsBySelector(".extraConf").each(function(c){if(c.readAttribute("type")==="text"){a.extraComment=$F(c).strip();if(a.extraComment.blank()||a.extraComment===null){c.insert({before:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update("Additional Comment is Mandatory!"))});a.hasErr=true}}if(c.readAttribute("type")==="checkbox"){if(!c.checked||c.checked===false||c.checked===null){c.insert({before:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update("Pls Select The Payment Check Box"))});a.hasErr=true}}})}if(a.hasErr===true){return this}a.me.postAjax(a.me.getCallbackId("confirmPayment"),{paidAmt:a.paidAmount,amtDiff:a.amtDiff,extraComment:a.extraComment,order:a.me._order},{onLoading:function(c,d){},onComplete:function(c,f){try{a.result=a.me.getResp(f,false,true);alert("Saved Successfully!");location.reload()}catch(d){alert(d);return}}})},_checkPaidAmount:function(b){var a={};a.me=this;a.paidAmount=$F(b).strip();a.paidAmount=a.paidAmount.replace(new RegExp("(\\$|\\s|,)","g"),"");$(b).value=a.paidAmount;$(b).up(".wrapper").getElementsBySelector(".msgDiv").each(function(c){c.remove()});a.extraInfoDiv=$(b).up(".wrapper").down("#extraConfDiv");if(a.extraInfoDiv.getElementsBySelector(".fieldDiv").length>0){a.extraInfoDiv.getElementsBySelector(".fieldDiv").each(function(c){c.remove()})}if(a.paidAmount===null||a.paidAmount.blank()||isNaN(a.paidAmount)){$(b).insert({before:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update("Paid Amount is NOT valid"))});return}a.diff=Math.abs(Math.abs(parseFloat(a.paidAmount).toFixed(2))-Math.abs(parseFloat(a.me._order.totalAmount).toFixed(2)));a.extraInfoDiv.down("#paidAmtDiff").value=a.diff;if(a.diff!==0){a.extraInfoDiv.insert({bottom:a.me._getfieldDiv("Additional Comment",new Element("input",{type:"text","class":"extraConf",id:"extraComment"}))}).insert({bottom:a.me._getfieldDiv("Payment Check",new Element("input",{type:"checkbox","class":"extraConf",id:"extraPaymentCheck"}))})}a.extraInfoDiv.insert({bottom:a.me._getfieldDiv("",new Element("span",{"class":"button"}).update("Confirm Payment").observe("click",function(){a.me._submitPaymentConfirmation(this)}))})},_getFinanceBtns:function(){var a={};a.me=this;if(a.me._editMode.accounting!==true){return""}return new Element("div",{"class":"wrapper"}).insert({bottom:a.me._getfieldDiv("Paid:",new Element("input",{type:"text",id:"paidAmount"}).observe("change",function(){a.me._checkPaidAmount(this)}))}).insert({bottom:new Element("div",{id:"extraConfDiv"}).insert({bottom:new Element("input",{type:"hidden",id:"paidAmtDiff"})})})},_collectData:function(c,b){var a={};a.me=this;a.data=[];a.hasError=false;$(a.me._resultDivId).getElementsBySelector(".productRow ."+c).each(function(d){d.getElementsBySelector(".msgDiv").each(function(e){e.remove()});a.fields=d.getElementsBySelector("["+b+"]");if(a.fields.size()===0){d.insert({top:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update("Pls Select One!"))});a.hasError=true}else{a.orderItem=d.up(".row").retrieve("data");a.attrData={orderItem:a.orderItem};a.fields.each(function(e){a.fieldName=e.readAttribute(b);a.value=$F(e);if(a.value.blank()){e.insert({before:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update(a.fieldName+" Required!"))});a.hasError=true}else{if(!a.attrData[c]){a.attrData[c]={}}a.attrData[c][a.fieldName]=a.value}});a.data.push(a.attrData)}});return(a.hasError===true?null:a.data)},_getPurchasingBtns:function(){var a={};a.me=this;if(a.me._editMode.purchasing===false){return""}return new Element("div").insert({bottom:new Element("span",{"class":"button"}).update("submit").observe("click",function(){a.btn=this;a.data=a.me._collectData("purchasing","update_order_item");if(a.data===null){alert("Error Occurred, pls scroll up to see details!");return}a.me.postAjax(a.me.getCallbackId("updateOrder"),{items:a.data,order:a.me._order,"for":"purchasing"},{onLoading:function(b,c){a.btn.addClassName("disabled").update("Saving ...")},onComplete:function(b,d){try{a.result=a.me.getResp(d,false,true);alert("Saved Successfully!");location.reload()}catch(c){alert(c)}a.btn.removeClassName("disabled").update("submit")}})})})},_getWHBtns:function(){var a={};a.me=this;if(a.me._editMode.warehouse===false){return""}a.hasError=false;return new Element("div").insert({bottom:new Element("span",{"class":"button"}).update("submit").observe("click",function(){a.data=a.me._collectData("warehouse","pick_order_item");if(a.data===null){alert("Error Occurred, pls scroll up to see details!");a.hasError=true;return}else{a.finalOrderItemArray=[];a.data.each(function(b){if(b.warehouse.isPicked==="N"&&(!b.warehouse.comments||b.warehouse.comments===null||b.warehouse.comments.strip()==="")){alert("Error Occurred, pls scroll up to see details!");a.hasError=true;return}a.finalOrderItemArray.push(b)});if(a.hasError===true){return}console.debug(a.finalOrderItemArray);a.me.postAjax(a.me.getCallbackId("updateOIForWH"),{orderItems:a.finalOrderItemArray,order:a.me._order},{onLoading:function(b,c){},onComplete:function(b,d){try{a.result=a.me.getResp(d,false,true);alert("Saved Successfully!");location.reload()}catch(c){alert(c);return}}})}})})},_getCommentsRow:function(a){return new Element("div",{"class":"row comments"}).insert({bottom:new Element("span",{"class":"inlineblock cell created"}).update(a.created)}).insert({bottom:new Element("span",{"class":"inlineblock cell creator"}).update(a.creator)}).insert({bottom:new Element("span",{"class":"inlineblock cell type"}).update(a.type)}).insert({bottom:new Element("span",{"class":"inlineblock cell comments"}).update(a.comments)})},_getComments:function(c,b){var a={};a.me=this;a.reset=(c||false);a.me.postAjax(a.me.getCallbackId("getComments"),{pagination:a.me._commentsDiv.pagination,order:a.me._order,type:a.me._commentsDiv.type},{onLoading:function(d,e){if(a.reset===true){$(a.me._commentsDiv.resultDivId).update(new Element("img",{src:"/themes/default/images/loading_big.gif"}))}if(b){$(b).store("originValue",$F(b)).addClassName("disabled").setValue("Getting ...").disabled=true}},onComplete:function(d,g){try{a.result=a.me.getResp(g,false,true);if(a.reset===true){$(a.me._commentsDiv.resultDivId).update(a.me._getCommentsRow({type:"Type",creator:"WHO",created:"WHEN",comments:"COMMENTS"}).addClassName("header"))}a.result.items.each(function(e){$(a.me._commentsDiv.resultDivId).insert({bottom:a.me._getCommentsRow(e)})});if(b){$(b).remove()}if(a.result.pagination.pageNumber<a.result.pagination.totalPages){$(a.me._commentsDiv.resultDivId).insert({bottom:new Element("input",{type:"button","class":"button",value:"Get More Comments"}).observe("click",function(){a.me._commentsDiv.pagination.pageNo=a.me._commentsDiv.pagination.pageNo*1+1;a.me._getComments(false,this)})})}}catch(f){alert(f);if(b){a.orginalValue=$(b).retrieve("originValue");$(b).removeClassName("disabled").setValue(a.orginalValue).disabled=false}}}});return this},_addComments:function(c,a){var b={};b.me=this;b.commentsBox=$(c).up(".new_comments_wrapper").down("[new_comments=comments]");b.comments=$F(b.commentsBox);if(b.comments.blank()){return this}b.me.postAjax(b.me.getCallbackId("addComments"),{comments:b.comments,order:b.me._order},{onLoading:function(d,e){$(c).store("originValue",$F(c)).addClassName("disabled").setValue("saving ...").disabled=true},onComplete:function(d,g){try{b.result=b.me.getResp(g,false,true);$(a).down(".header").insert({after:b.me._getCommentsRow(b.result)});b.commentsBox.setValue("")}catch(f){console.error(f)}b.originValue=$(c).retrieve("originValue");$(c).removeClassName("disabled").setValue(b.originValue).disabled=false}});return this},_getOrderStatus:function(){var a={};a.me=this;if(a.me._editMode.status!==true){return a.me._order.status.name}a.selBox=new Element("select").observe("change",function(){a.me._changeOrderStatus(this)});a.me._orderStatuses.each(function(b){a.opt=new Element("option",{value:b.id}).update(b.name);if(b.id===a.me._order.status.id){a.opt.writeAttribute("selected",true)}a.selBox.insert({bottom:a.opt})});return a.selBox},_getShippingRow:function(){var a={};a.me=this;return new Element("div",{"class":"shippingWrapper"}).insert({bottom:new Element("div",{"class":"row"}).insert({bottom:a.me._getfieldDiv("Courier:","")})})},load:function(b){var a={};a.me=this;a.me._resultDivId=b;a.newDiv=new Element("div");a.custName=a.custEmail="n/a";if(a.me._order.infos&&a.me._order.infos!==null){if(a.me._order.infos[a.me.infoType_custName]&&a.me._order.infos[a.me.infoType_custName].length>0){a.custName=a.me._order.infos[a.me.infoType_custName][0].value}if(a.me._order.infos[a.me.infoType_custEmail]&&a.me._order.infos[a.me.infoType_custEmail].length>0){a.custEmail=a.me._order.infos[a.me.infoType_custEmail][0].value}}a.newDiv.insert({bottom:new Element("fieldset",{"class":"row orderInfo"}).insert({bottom:new Element("legend").update("info")}).insert({bottom:new Element("span",{"class":"orderNo inlineblock"}).update(a.me._getfieldDiv("Order No.",a.me._order.orderNo))}).insert({bottom:new Element("span",{"class":"orderDate inlineblock"}).update(a.me._getfieldDiv("Order Date:",a.me._order.orderDate))}).insert({bottom:new Element("span",{"class":"orderStatus inlineblock"}).update(a.me._getfieldDiv("Order Status:",a.me._getOrderStatus()))})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"row addressRow"}).insert({bottom:new Element("legend").update("Customer")}).insert({bottom:new Element("div",{"class":"customer"}).insert({bottom:new Element("div").update("Customer: ")}).insert({bottom:new Element("span",{"class":"custName inlineblock"}).update(a.me._getfieldDiv("",a.custName))}).insert({bottom:new Element("span",{"class":"custEmail inlineblock"}).update(a.me._getfieldDiv("",a.custEmail))})}).insert({bottom:new Element("div").insert({bottom:a.me._getAddressDiv("Shipping Address: ",a.me._order.address.shipping).addClassName("inlineblock")}).insert({bottom:a.me._getAddressDiv("Billing Address: ",a.me._order.address.billing).addClassName("inlineblock")})})});a.productListDiv=new Element("div",{"class":"productlist dataTable"}).insert({bottom:a.me._getProductRow({product:{sku:"SKU",name:"Product Name"},unitPrice:"Unit Price",qtyOrdered:"Qty",totalPrice:"Total Price"},true).addClassName("header")});a.me._orderItems.each(function(c){a.productListDiv.insert({bottom:a.me._getProductRow(c)})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"row productsRow dataTableWrapper"}).insert({bottom:new Element("legend").update("Products")}).insert({bottom:a.productListDiv})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"row summary"}).insert({bottom:new Element("legend").update("Summary")}).insert({bottom:new Element("div").insert({bottom:a.me._getfieldDiv("Shipping",a.me._order.infos[9][0].value)}).insert({bottom:a.me._getfieldDiv("Payment Method",a.me._order.infos[6][0].value)}).insert({bottom:a.me._getfieldDiv("Total Amount",a.me.getCurrency(a.me._order.totalAmount)).addClassName("totalAmount")}).insert({bottom:a.me._getfieldDiv("Total Paid",a.me.getCurrency(a.me._order.totalPaid)).addClassName("totalPaid")}).insert({bottom:a.me._getfieldDiv("Total Due",a.me.getCurrency(a.me._order.totalDue)).addClassName("totalDue")})})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"submitbtns"}).insert({bottom:new Element("span",{"class":"financeBtns inlineblock"}).update(a.me._getFinanceBtns())}).insert({bottom:new Element("span",{"class":"purchasingBtns inlineblock"}).update(a.me._getPurchasingBtns())}).insert({bottom:new Element("span",{"class":"warehouseBtns inlineblock"}).update(a.me._getWHBtns())})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"shipping"}).insert({bottom:a.me._getShippingRow()})});a.newDiv.insert({bottom:new Element("fieldset",{"class":"row commentsWrapper dataTableWrapper"}).insert({bottom:new Element("legend").update("Comments")}).insert({bottom:new Element("div",{id:"comments_list","class":"dataTable"})}).insert({bottom:new Element("div",{"class":"comments_input_row"}).insert({bottom:a.me._getfieldDiv("New Comments:",new Element("div",{"class":"new_comments_wrapper"}).insert({bottom:new Element("input",{type:"text",new_comments:"comments",placeholder:"add more comments to this order"}).observe("keydown",function(c){a.me.keydown(c,function(){$(c.currentTarget).up(".new_comments_wrapper").down("[new_comments=btn]").click()})})}).insert({bottom:new Element("input",{type:"button",new_comments:"btn",value:"Add","class":"button"}).observe("click",function(){a.me._addComments(this,"comments_list")})}))})})});$(a.me._resultDivId).update(a.newDiv);a.me._commentsDiv.resultDivId="comments_list";a.me._getComments(true);return this}});