var PageJs=new Class.create();PageJs.prototype=Object.extend(new BPCPageJs(),{id_wrapper:"",_acceptableTypes:["csv"],csvFileLineFormat:["sku","myobItemNo","assetAccNo","revenueAccNo","costAccNo"],_fileReader:null,_uploadedData:{},_htmlIds:{},_productCodeTypes:{},_rowNo:null,setHTMLIDs:function(b,a){var c={};c.me=this;c.me._htmlIds.skuMatchDiv=b;c.me._htmlIds.productCodeTypeDropdown=a;c.me.id_wrapper=c.me._htmlIds.skuMatchDiv;return this},load:function(a){var b={};b.me=this;b.me._rowNo=1;b.me._productCodeTypes=a;$(b.me._htmlIds.skuMatchDiv).update("test");if(window.File&&window.FileReader&&window.FileList&&window.Blob){b.me._fileReader=new FileReader();$(b.me._htmlIds.skuMatchDiv).update(b.me._getFileUploadDiv());b.me._loadChosen()}else{$(b.me.id_wrapper).update(b.me.getAlertBox("Warning:","Your browser does NOT support this feature. pls change and try again").addClassName("alert-warning"))}return b.me},_genTemplate:function(){var a={};a.me=this;a.data=[];a.data.push(a.me.csvFileLineFormat.join(", ")+"\n");a.now=new Date();a.fileName="skumatch_template_"+a.now.getFullYear()+"_"+a.now.getMonth()+"_"+a.now.getDate()+"_"+a.now.getHours()+"_"+a.now.getMinutes()+"_"+a.now.getSeconds()+".csv";a.blob=new Blob(a.data,{type:"text/csv;charset=utf-8"});saveAs(a.blob,a.fileName);return a.me},_loadChosen:function(){jQuery(".chosen").chosen({search_contains:true,inherit_select_classes:true,no_results_text:"No code type found!",width:"150px"});return this},_getFileUploadDiv:function(){var a={};a.me=this;a.newDiv=new Element("div",{"class":"panel panel-default drop_file_div",title:"You can drag multiple files here!"}).insert({bottom:new Element("div",{"class":"panel-body"}).insert({bottom:new Element("div",{"class":"pull-right"}).insert({bottom:a.dropdown=new Element("select",{"class":"chosen","data-placeholder":"Code Type: ",id:a.me._htmlIds.productCodeTypeDropdown})}).insert({bottom:new Element("span",{"class":"btn btn-default btn-xs",title:"Download Template"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-download-alt"})}).observe("click",function(){a.me._genTemplate()})})}).insert({bottom:new Element("div",{"class":"form-group center-block text-left",style:"width: 50%"}).insert({bottom:new Element("label").update("Drop you files here or select your file below:")}).insert({bottom:a.inputFile=new Element("input",{type:"file",style:"display: none;",multiple:true}).observe("change",function(b){a.me._readFiles(b.target.files)})}).insert({bottom:new Element("div",{"class":"clearfix"})}).insert({bottom:new Element("span",{"class":"btn btn-success clearfix"}).update("Click to select your file").observe("click",function(b){a.me._getProductCodeType();a.inputFile.click()})}).insert({bottom:new Element("div",{"class":"clearfix"})}).insert({bottom:new Element("small").update("ONLY ACCEPT file formats: "+a.me._acceptableTypes.join(", "))})})}).observe("dragover",function(b){b.stopPropagation();b.preventDefault();b.dataTransfer.dropEffect="copy"}).observe("drop",function(b){a.me._getProductCodeType();b.stopPropagation();b.preventDefault();a.me._readFiles(b.dataTransfer.files)});a.me._productCodeTypes.each(function(b){a.dropdown.insert({bottom:new Element("option",{value:b.name}).update(b.name).store("data",b)})});return a.newDiv},_getProductCodeType:function(){var a={};a.me=this;a.me._productCodeTypes=$(a.me._htmlIds.productCodeTypeDropdown)?$F($(a.me._htmlIds.productCodeTypeDropdown)):"EAN";return a.me},_readFiles:function(b){var a={};a.me=this;a.me._uploadedData={};a.fileLists=new Element("div",{"class":"list-group"});for(a.i=0,a.file;a.file=b[a.i];a.i++){a.fileRow=new Element("div",{"class":"row"}).update(new Element("div",{"class":"col-lg-6 col-md-6"}).update(a.file.name));if((a.extension=a.file.name.split(".").pop())!==""&&a.me._acceptableTypes.indexOf(a.extension.toLowerCase())>-1){a.me._fileReader=new FileReader();a.me._fileReader.onload=function(c){a.me._rowNo=1;c.target.result.split(/\r\n|\n|\r/).each(function(d){if(d!==null&&!d.blank()){a.cols=[];d.split(",").each(function(e){if(e!==null){a.cols.push(e.strip())}});a.key=a.cols.join(",");if(a.key!==a.me.csvFileLineFormat.join(",")){a.colArray={};for(a.j=0;a.j<a.me.csvFileLineFormat.size();a.j++){a.colArray[a.me.csvFileLineFormat[a.j]]=a.cols[a.j]}a.colArray.index=a.me._rowNo++;a.me._uploadedData[a.key]=a.colArray}}})};a.me._fileReader.readAsText(a.file);a.supported=true}else{a.fileRow.insert({bottom:new Element("div",{"class":"col-lg-6 col-md-6"}).update(new Element("small").update("Not supported file extension: "+a.extension))});a.supported=false}a.fileLists.insert({bottom:new Element("div",{"class":"list-group-item "+(a.supported===true?"list-group-item-success":"list-group-item-danger")}).insert({bottom:a.fileRow})})}$(a.me.id_wrapper).update(new Element("div",{"class":"panel panel-default"}).insert({bottom:new Element("div",{"class":"panel-heading"}).update("Files Selected:").insert({bottom:new Element("small",{"class":"pull-right"}).update("ONLY ACCEPT file formats: "+a.me._acceptableTypes.join(", "))})}).insert({bottom:a.fileLists}).insert({bottom:new Element("div",{"class":"panel-footer"}).insert({bottom:new Element("span",{"class":"btn btn-success"}).update("Start").observe("click",function(){a.me._loadProductLineItems()})}).insert({bottom:new Element("span",{"class":"btn btn-warning pull-right"}).update("Cancel").observe("click",function(){jQuery(".btn").attr("disabled","disabled");window.location=document.URL})})}));return a.me},genCSV:function(b){var a={};a.me=this;a.data=[];a.headerRow="sku, myobItemNo, barcode, assetAccNo, revenueAccNo, costAccNo";$H(a.me._companyAliases).each(function(c){a.headerRow=a.headerRow+", "+c.key});a.data.push(a.headerRow+"\n");$(b).up(".panel").getElementsBySelector(".result_row.result-done").each(function(c){a.originalData=c.retrieve("data");a.csvRow=a.originalData.product.sku+", "+a.originalData.MYOBcode+", "+a.originalData.code;$H(a.me._companyAliases).each(function(d){a.csvRow=a.csvRow+", "+a.me.getCurrency(a.originalData.companyPrices[d.key].price,"$",2,".","")});a.csvRow=a.csvRow+"\n";a.data.push(a.csvRow);a.i=a.i*1+1});a.now=new Date();a.fileName="pricematch_"+a.now.getFullYear()+"_"+a.now.getMonth()+"_"+a.now.getDate()+"_"+a.now.getHours()+"_"+a.now.getMinutes()+"_"+a.now.getSeconds()+".csv";a.blob=new Blob(a.data,{type:"text/csv;charset=utf-8"});saveAs(a.blob,a.fileName);return a.me},_getProductLineItem:function(b,d,a){var c={};c.me=this;c.data=c.me._uploadedData[a[d]];c.data.productCodeType=c.me._productCodeTypes;c.newRow=new Element("tr",{"class":"result_row info"}).insert({bottom:new Element("td").update(c.data.sku?c.data.sku:"Blank SKU!")}).insert({bottom:new Element("td").update(c.data.code?c.data.code:"Blank code!")});c.me.postAjax(c.me.getCallbackId("getAllCodeForProduct"),c.data,{onLoading:function(e,f){b.insert({bottom:c.newRow})},onSuccess:function(f,h){try{c.result=c.me.getResp(h,false,true);if(!c.result||!c.result.item||!c.result.item.product){c.newRow.update("");return}c.newRow.update("").removeClassName("info").addClassName("result-done").store("data",c.result.item).insert({bottom:new Element("td").insert({bottom:new Element("a",{href:("/product/"+c.result.item.product.id+".html"),target:"_blank"}).update(c.result.item.product.sku)})}).insert({bottom:new Element("td",{"class":c.result.item.MYOBcode?"":"warning"}).update(c.result.item.MYOBcode?c.result.item.MYOBcode:"Blank")}).insert({bottom:new Element("td",{"class":c.result.item.code?"":"warning"}).update(c.result.item.code?c.result.item.code:"No barcode updated")}).insert({bottom:new Element("td",{"class":c.result.item.assetAccNo?"":"warning"}).update(c.result.item.assetAccNo?c.result.item.assetAccNo:"No assetAccNo updated")}).insert({bottom:new Element("td",{"class":c.result.item.revenueAccNo?"":"warning"}).update(c.result.item.revenueAccNo?c.result.item.revenueAccNo:"No revenueAccNo updated")}).insert({bottom:new Element("td",{"class":c.result.item.costAccNo?"":"warning"}).update(c.result.item.costAccNo?c.result.item.costAccNo:"No costAccNo updated")})}catch(g){c.newRow.update("").removeClassName("info").addClassName("danger").store("data",c.data).insert({bottom:new Element("td").update(c.data.sku?c.data.sku:"Blank SKU!")}).insert({bottom:new Element("td").update(c.data.code?c.data.code:"Blank code!")}).insert({bottom:new Element("td",{colspan:2}).update("<strong>ERROR:</strong>"+g)});b.insert({top:c.newRow})}},onComplete:function(f,h){try{c.nextDataKeyIndex=d*1+1;if(c.nextDataKeyIndex>=a.size()){c.errRows=$(c.me.id_wrapper).getElementsBySelector(".result_row.danger");b.up(".panel").removeClassName("panel-danger").addClassName(c.errRows.size()>0?"panel-warning":"panel-success").down(".panel-heading").update("").insert({bottom:new Element("panel-title").update((c.errRows.size()>0?"All provided rows have been proccessed, but with "+c.errRows.size()+" error(s)":"All provided rows have been proccessed successfully"))}).insert({bottom:new Element("span",{"class":"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{"class":"btn"}).writeAttribute("title",c.errRows.size()>0?"Export Success Rows":"Export To Excel").update(new Element("span",{"class":"glyphicon glyphicon-save"})).addClassName(c.errRows.size()>0?"btn-warning":"btn-success").observe("click",function(){c.me.genCSV(this)})}).insert({bottom:new Element("span",{"class":"btn btn-default"}).writeAttribute("title","Start Again").update(new Element("span",{"class":"glyphicon glyphicon-repeat"})).observe("click",function(){window.location=document.URL})})})}else{c.me._getProductLineItem(b,c.nextDataKeyIndex,a)}}catch(g){alert(g)}}});return c.me},_loadProductLineItems:function(){var a={};a.me=this;a.keys=[];$H(a.me._uploadedData).each(function(b){a.keys.push(b.key)});a.theadRow=new Element("tr").insert({bottom:new Element("th").update("SKU")}).insert({bottom:new Element("th").update("MYOB Item #")}).insert({bottom:new Element("th").update("Barcode")}).insert({bottom:new Element("th").update("Asset Acc #")}).insert({bottom:new Element("th").update("Revenue Acc #")}).insert({bottom:new Element("th").update("Cost Acc #")});$(a.me.id_wrapper).update(new Element("div",{"class":"price_search_result panel panel-danger table-responsive"}).insert({bottom:new Element("div",{"class":"panel-heading"}).update("Total of <strong>"+a.keys.size()+"</strong> unique row(s) received:").insert({bottom:new Element("strong",{"class":"pull-right"}).update("please waiting for it to finish")})}).insert({bottom:new Element("table",{"class":"table table-striped"}).insert({bottom:new Element("thead").update(a.theadRow)}).insert({bottom:a.resultList=new Element("tbody")})}));a.me._getProductLineItem(a.resultList,0,a.keys);return a.me}});