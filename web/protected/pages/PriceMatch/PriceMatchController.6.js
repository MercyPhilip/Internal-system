var PageJs=new Class.create();PageJs.prototype=Object.extend(new BPCPageJs(),{id_wrapper:"",_acceptableTypes:["csv"],csvFileLineFormat:["sku","price"],_fileReader:null,_uploadedData:{},_html_ids:{uploadedFileList:"uploaded_file_list",uploadInputDiv:"upload_input_div",resultListDiv:"result_list_div"},_companyAliases:{},load:function(b,c){var a={};a.me=this;a.me.id_wrapper=b;a.me._companyAliases=c;if(window.File&&window.FileReader&&window.FileList&&window.Blob){a.me._fileReader=new FileReader();$(a.me.id_wrapper).update(a.me._getFileUploadDiv())}else{$(a.me.id_wrapper).update(a.me.getAlertBox("Warning:","Your browser does NOT support this feature. pls change and try again").addClassName("alert-warning"))}return a.me},_genTemplate:function(){var a={};a.me=this;a.data=[];a.data.push(a.me.csvFileLineFormat.join(", ")+"\n");a.now=new Date();a.fileName="pricematch_template_"+a.now.getFullYear()+"_"+a.now.getMonth()+"_"+a.now.getDate()+"_"+a.now.getHours()+"_"+a.now.getMinutes()+"_"+a.now.getSeconds()+".csv";a.blob=new Blob(a.data,{type:"text/csv;charset=utf-8"});saveAs(a.blob,a.fileName);return a.me},_getFileUploadDiv:function(){var a={};a.me=this;return new Element("div",{"class":"panel panel-default drop_file_div",title:"You can drag multiple files here!"}).insert({bottom:new Element("div",{"class":"panel-body"}).insert({bottom:new Element("div",{"class":"btn-group pull-right"}).insert({bottom:new Element("span",{"class":"btn btn-default",title:"Edit Companies"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-cog"})}).observe("click",function(){jQuery.fancybox({width:"90%",height:"90%",autoScale:false,autoDimensions:false,fitToView:false,autoSize:false,type:"iframe",href:"/pricematchcompanies.html",beforeClose:function(){window.location=document.URL}})})}).insert({bottom:new Element("span",{"class":"btn btn-default",title:"Download Template"}).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-download-alt"})}).observe("click",function(){a.me._genTemplate()})})}).insert({bottom:new Element("div",{"class":"form-group center-block text-left",style:"width: 50%"}).insert({bottom:new Element("label").update("Drop you files here or select your file below:")}).insert({bottom:a.inputFile=new Element("input",{type:"file",style:"display: none;",multiple:true}).observe("change",function(b){a.me._readFiles(b.target.files)})}).insert({bottom:new Element("div",{"class":"clearfix"})}).insert({bottom:new Element("span",{"class":"btn btn-success clearfix"}).update("Click to select your file").observe("click",function(b){a.inputFile.click()})}).insert({bottom:new Element("div",{"class":"clearfix"})}).insert({bottom:new Element("small").update("ONLY ACCEPT file formats: "+a.me._acceptableTypes.join(", "))})})}).observe("dragover",function(b){b.stopPropagation();b.preventDefault();b.dataTransfer.dropEffect="copy"}).observe("drop",function(b){b.stopPropagation();b.preventDefault();a.me._readFiles(b.dataTransfer.files)})},_readFiles:function(b){var a={};a.me=this;a.me._uploadedData={};a.fileLists=new Element("div",{"class":"list-group"});for(a.i=0,a.file;a.file=b[a.i];a.i++){a.fileRow=new Element("div",{"class":"row"}).update(new Element("div",{"class":"col-lg-6 col-md-6"}).update(a.file.name));if((a.extension=a.file.name.split(".").pop())!==""&&a.me._acceptableTypes.indexOf(a.extension.toLowerCase())>-1){a.me._fileReader=new FileReader();a.me._fileReader.onload=function(c){c.target.result.split(/\r\n|\n|\r/).each(function(d){if(d!==null&&!d.blank()){a.cols=[];d.split(",").each(function(e){if(e!==null&&!e.blank()){a.cols.push(e.strip())}});a.key=a.cols.join(",");if(a.key!==a.me.csvFileLineFormat.join(",")){a.colArray={};for(a.j=0;a.j<a.me.csvFileLineFormat.size();a.j++){a.colArray[a.me.csvFileLineFormat[a.j]]=a.cols[a.j]}a.me._uploadedData[a.key]=a.colArray}}})};a.me._fileReader.readAsText(a.file);a.supported=true}else{a.fileRow.insert({bottom:new Element("div",{"class":"col-lg-6 col-md-6"}).update(new Element("small").update("Not supported file extension: "+a.extension))});a.supported=false}a.fileLists.insert({bottom:new Element("div",{"class":"list-group-item "+(a.supported===true?"list-group-item-success":"list-group-item-danger")}).insert({bottom:a.fileRow})})}$(a.me.id_wrapper).update(new Element("div",{"class":"panel panel-default"}).insert({bottom:new Element("div",{"class":"panel-heading"}).update("Files Selected:").insert({bottom:new Element("small",{"class":"pull-right"}).update("ONLY ACCEPT file formats: "+a.me._acceptableTypes.join(", "))})}).insert({bottom:a.fileLists}).insert({bottom:new Element("div",{"class":"panel-footer"}).insert({bottom:new Element("span",{"class":"btn btn-success"}).update("Start").observe("click",function(){a.me._loadProductLineItems()})}).insert({bottom:new Element("span",{"class":"btn btn-warning pull-right"}).update("Cancel").observe("click",function(){$(a.me.id_wrapper).update(a.me._getFileUploadDiv())})})}));return a.me},genCSV:function(b){var a={};a.me=this;a.data=[];a.headerRow="SKU, My Price, Price Diff., Min. Price";$H(a.me._companyAliases).each(function(c){a.headerRow=a.headerRow+", "+c.key});a.data.push(a.headerRow+"\n");$(b).up(".panel").getElementsBySelector(".result_row.result-done").each(function(c){a.originalData=c.retrieve("data");a.csvRow=a.originalData.sku+", "+a.originalData.myPrice+", "+a.originalData.minPrice+", "+a.originalData.priceDiff;$H(a.me._companyAliases).each(function(d){a.csvRow=a.csvRow+", "+a.me.getCurrency(a.originalData.companyPrices[d.key].price)});a.csvRow=a.csvRow+"\n";a.data.push(a.csvRow);a.i=a.i*1+1});a.now=new Date();a.fileName="pricematch_"+a.now.getFullYear()+"_"+a.now.getMonth()+"_"+a.now.getDate()+"_"+a.now.getHours()+"_"+a.now.getMinutes()+"_"+a.now.getSeconds()+".csv";a.blob=new Blob(a.data,{type:"text/csv;charset=utf-8"});saveAs(a.blob,a.fileName);return a.me},_getProductLineItem:function(b,d,a){var c={};c.me=this;c.data=c.me._uploadedData[a[d]];c.newRow=new Element("tr",{"class":"result_row info"}).insert({bottom:new Element("td").update(c.data.sku)}).insert({bottom:new Element("td").update(c.me.getCurrency(c.data.price))}).insert({bottom:new Element("td",{colspan:2}).update("<strong>Loading...</strong>")});c.me.postAjax(c.me.getCallbackId("getAllPricesForProduct"),{sku:c.data.sku,price:c.data.price,companyAliases:c.me._companyAliases},{onLoading:function(e,f){b.insert({bottom:c.newRow})},onSuccess:function(f,h){try{c.result=c.me.getResp(h,false,true);if(!c.result||!c.result.item){return}c.newRow.update("").removeClassName("info").addClassName("result-done").store("data",c.result.item).insert({bottom:new Element("td").update(c.result.item.sku)}).insert({bottom:new Element("td").update(c.me.getCurrency(c.result.item.myPrice))}).insert({bottom:new Element("td",{"class":"price_diff"+(c.result.item.priceDiff>0?" over_priced":"")}).update(c.me.getCurrency(c.result.item.priceDiff))}).insert({bottom:new Element("td",{"class":"price_min",title:"Min. Price among all Companies"}).update(c.me.getCurrency(c.result.item.minPrice))});$H(c.me._companyAliases).each(function(e){c.newRow.insert({bottom:new Element("td").update(c.result.item.companyPrices[e.key].priceURL.blank()?new Element("span",{title:'No value has been found for "'+e.key+'" based on sku: '+c.data.sku}).update(c.me.getCurrency(c.result.item.companyPrices[e.key].price)):new Element("a",{href:c.result.item.companyPrices[e.key].priceURL}).update(c.me.getCurrency(c.result.item.companyPrices[e.key].price)))})})}catch(g){c.newRow.update("").removeClassName("info").addClassName("danger").store("data",c.data).insert({bottom:new Element("td").update(c.data.sku)}).insert({bottom:new Element("td").update(c.me.getCurrency(c.data.price))}).insert({bottom:new Element("td",{colspan:2}).update("<strong>ERROR:</strong>"+g)})}},onComplete:function(f,h){try{c.nextDataKeyIndex=d*1+1;if(c.nextDataKeyIndex>=a.size()){c.errRows=$(c.me.id_wrapper).getElementsBySelector(".result_row.danger");b.up(".panel").removeClassName("panel-danger").addClassName(c.errRows.size()>0?"panel-warning":"panel-success").down(".panel-heading").update("").insert({bottom:new Element("panel-title").update((c.errRows.size()>0?"All provided rows have been proccessed, but with "+c.errRows.size()+" error(s)":"All provided rows have been proccessed successfully"))}).insert({bottom:new Element("span",{"class":"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{"class":"btn"}).writeAttribute("title",c.errRows.size()>0?"Export Success Rows":"Export To Excel").update(new Element("span",{"class":"glyphicon glyphicon-save"})).addClassName(c.errRows.size()>0?"btn-warning":"btn-success").observe("click",function(){c.me.genCSV(this)})}).insert({bottom:new Element("span",{"class":"btn btn-default"}).writeAttribute("title","Start Again").update(new Element("span",{"class":"glyphicon glyphicon-repeat"})).observe("click",function(){window.location=document.URL})})})}else{c.me._getProductLineItem(b,c.nextDataKeyIndex,a)}}catch(g){alert(g)}}});return c.me},_loadProductLineItems:function(){var a={};a.me=this;a.keys=[];$H(a.me._uploadedData).each(function(b){a.keys.push(b.key)});a.theadRow=new Element("tr").insert({bottom:new Element("th").update("SKU")}).insert({bottom:new Element("th").update("My Price")}).insert({bottom:new Element("th",{"class":"price_diff"}).update("Price Diff.")}).insert({bottom:new Element("th",{"class":"price_min"}).update("Min Price")});$H(a.me._companyAliases).each(function(b){a.theadRow.insert({bottom:new Element("th").update(b.key)})});$(a.me.id_wrapper).update(new Element("div",{"class":"price_search_result panel panel-danger table-responsive"}).insert({bottom:new Element("div",{"class":"panel-heading"}).update("Total of <strong>"+a.keys.size()+"</strong> unique row(s) received:").insert({bottom:new Element("strong",{"class":"pull-right"}).update("please waiting for it to finish")})}).insert({bottom:new Element("table",{"class":"table table-striped"}).insert({bottom:new Element("thead").update(a.theadRow)}).insert({bottom:a.resultList=new Element("tbody")})}));a.me._getProductLineItem(a.resultList,0,a.keys);return a.me}});