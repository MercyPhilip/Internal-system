var PageJs=new Class.create;
PageJs.prototype=Object.extend(new CRUDPageJs,{_getTitleRowData:function(){return{applyDate:"Apply Date",applyTo:"Apply To",creditNoteNo:"Credit Note No",description:"Description",totalValue:"Total Value",active:"Active",customer:{name:"Name"},order:{orderNo:"Order No"}}},_bindSearchKey:function(){var a,c,b;a=this;$$("#searchBtn").first().observe("click",function(b){$$("#showSearch").first().checked?a.getSearchCriteria().getResults(!0,a._pagination.pageSize):$$("#showSearch").first().click()});$("searchDiv").getElementsBySelector("[search_field]").each(function(b){b.observe("keydown",
function(b){a.keydown(b,function(){$(a.searchDivId).down("#searchBtn").click()})})});c=(new Element("input",{"class":"select2 form-control","data-placeholder":"search for a Customers",search_field:"cust.id"})).insert({bottom:(new Element("option")).update("")});$("searchDiv").down('[search_field="cust.id"]').replace(c);jQuery('.select2[search_field="cust.id"]').select2({allowClear:!0,hidden:!0,multiple:!0,ajax:{url:"/ajax/getCustomers",dataType:"json",delay:10,data:function(a){return{searchTxt:a,
storeId:jQuery("#storeId").attr("value"),userId:jQuery("#userId").attr("value")}},results:function(a){b=[];a.resultData.items.each(function(a){b.push({id:a.id,text:a.name,data:a})});return{results:b}},cache:!0},formatResult:function(a){return a?"<div value="+a.data.id+">"+a.data.name+"</div >":""},escapeMarkup:function(a){return a},minimumInputLength:1});c=(new Element("input",{"class":"select2 form-control","data-placeholder":"search for a Products",search_field:"pro.ids"})).insert({bottom:(new Element("option")).update("")});
$("searchDiv").down('[search_field="pro.ids"]').replace(c);jQuery('.select2[search_field="pro.ids"]').select2({allowClear:!0,hidden:!0,multiple:!0,ajax:{url:"/ajax/getProducts",dataType:"json",delay:10,data:function(a){return{searchTxt:a,pageNo:1,pageSize:10,userId:jQuery("#userId").attr("value")}},results:function(a){b=[];a.resultData.items.each(function(a){b.push({id:a.id,text:a.name,data:a})});return{results:b}},cache:!0},formatResult:function(a){return a?"<div value="+a.data.id+">"+a.data.name+
"</div >":""},escapeMarkup:function(a){return a},minimumInputLength:3});c=(new Element("select",{"class":"select2 form-control","data-placeholder":"search for a Apply To",search_field:"cn.applyTo",multiple:!0})).insert({bottom:(new Element("option")).update("")});a._applyToOptions.each(function(a){c.insert({bottom:(new Element("option",{value:a})).update(a)})});$("searchDiv").down('[search_field="cn.applyTo"]').replace(c);jQuery('.select2[search_field="cn.applyTo"]').select2({allowClear:!0});return this},
_openEditPage:function(a){var c,b,e;c=this;jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",frameborder:"0",border:"0",seamless:"seamless",href:"/creditnote/"+(a&&a.id?a.id:"new")+".html",beforeClose:function(){if((b=$$("iframe.fancybox-iframe").first().contentWindow.pageJs)&&b._creditNote&&b._creditNote.id)if(a&&a.id)a.creditNote=b._creditNote,a.customer=b._customer,a.creditNoteStatus=b._creditNoteStatus,e=c._getResultRow(a);else{var d;
d=b._creditNote;d.creditNoteItems=b._creditNote.items;d.customer=b._customer;d.creditNoteStatus=b._creditNoteStatus;d.order={};d.order.id="";d.order.orderNo="";e=c._getResultRow(d)}null!==e&&(a&&a.id?$(c.resultDivId).down(".item_row[item_id="+a.id+"]")&&$(c.resultDivId).down(".item_row[item_id="+a.id+"]").replace(e):$(c.resultDivId).down("tbody").insert({top:e}))}});return c},_highlightSelectedRow:function(a){a=a.down(".glyphicon-plus")?"":$(a).up("[item_id]").retrieve("data");jQuery(".item_row.success").removeClass("success");
jQuery("[item_id="+a.id+"]").addClass("success")},_displaySelectedAddress:function(a){var c,b;c=$(a).up("[item_id]").retrieve("data");b=$(a).down("span").classList.contains("address-shipping");jQuery(".popover-loaded").popover("hide");jQuery(".item_row.success").removeClass("success");jQuery("[item_id="+c.id+"]").addClass("success");this._signRandID(a);jQuery("#"+a.id).hasClass("popover-loaded")||jQuery("#"+a.id).popover({title:'<div class="row"><div class="col-xs-10">Details for: '+c.name+'</div><div class="col-xs-2" style="cursor: pointer" href="javascript:void(0);" onclick="jQuery(\'#'+
a.id+"').popover('hide');\"><span class=\"pull-right glyphicon glyphicon-remove\" ></span></div></div>",html:!0,placement:function(){return b?"left":"right"},container:"body",trigger:"manual",viewport:{selector:".list-panel",padding:0},content:function(){return b?"<p>"+c.address.shipping.full+"</p>":"<p>"+c.address.billing.full+"</p>"},template:'<div class="popover" role="tooltip" style="max-width: none; z-index: 0;"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}).addClass("popover-loaded");
jQuery("#"+a.id).popover("toggle");return this},_getResultRow:function(a,c){var b,e,d;b=this;e=c||!1;d=!0===e?"th":"td";return(new Element("tr",{"class":(!0===e?"item_top_row":"btn-hide-row item_row")+(0==a.active?" danger":""),item_id:!0===e?"":a.id})).store("data",a).insert({bottom:(new Element(d,{"class":"col-xs-1"})).insert({bottom:!0===e?a.creditNoteNo:(new Element("a",{href:"javascript: void(0);"})).update(a.creditNoteNo).observe("click",function(){b._openEditPage(a)})})}).insert({bottom:(new Element(d,
{"class":"col-xs-1"})).update(!0===e?"Customer":a.customer.name)}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(!0===e?a.order.orderNo:(new Element("a",{href:"/orderdetails/"+a.order.id+".html",target:"_BLANK"})).update(a.order.orderNo))}).insert({bottom:(new Element(d)).update(a.description)}).insert({bottom:(new Element(d,{"class":"col-xs-1 text-right"})).update(!0===e?"Total Value":b.getCurrency(a.totalValue))}).insert({bottom:(new Element(d,{"class":"col-xs-1 text-right"})).update(!0===
e?"Total Paid":b.getCurrency(a.totalPaid))}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(a.applyTo)}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(!0===e?a.applyDate:moment(b.loadUTCTime(a.applyDate)).format("ll"))}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(e?"Credit NoteItems":a.creditNoteItems?a.creditNoteItems.length:"")}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(e?"Credit Available":a.creditNoteStatus?b.getCurrency(a.creditNoteStatus.creditAmountAvailable):
b.getCurrency(0))}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).update(e?"Status":a.creditNoteStatus?a.creditNoteStatus.status:"")}).insert({bottom:(new Element(d,{"class":"col-xs-1"})).setStyle("display: none;").insert({bottom:!0===e?a.active:new Element("input",{type:"checkbox",disabled:!0,checked:a.active})})}).insert({bottom:(new Element(d,{"class":"text-right col-xs-1"})).update(!0===e?"":(new Element("span",{"class":"btn-group btn-group-xs"})).insert({bottom:(new Element("span",{"class":"btn btn-default",
title:"Edit"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-pencil"})}).observe("click",function(){b._openEditPage(a)})}).insert({bottom:(new Element("span",{"class":"btn btn-danger",title:"Delete"})).insert({bottom:new Element("span",{"class":"glyphicon glyphicon-trash"})}).observe("click",function(){if(!confirm("Are you sure you want to deactivate this item?"))return!1;a.active&&b._deactivateItem(this)})}))})},_getNextPageBtn:function(){var a;a=this;return(new Element("tfoot")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("td",
{colspan:"8","class":"text-center"})).insert({bottom:(new Element("span",{"class":"btn btn-primary","data-loading-text":"Fetching more results ..."})).update("Show More").observe("click",function(){a._pagination.pageNo=1*a._pagination.pageNo+1;jQuery(this).button("loading");a.getResults()})})})})},_deactivateItem:function(a){var c,b,e;c=this;b=$(a).up("[item_id]");a=b.retrieve("data");c.postAjax(c.getCallbackId("deactivateItems"),{item_id:a.id},{onLoading:function(){b&&(b.toggleClassName("danger"),
b.hide())},onSuccess:function(a,f){try{b.toggleClassName("danger");e=c.getResp(f,!1,!0);if(!e.item)throw"errror";$$('[item_id="'+e.item.id+'"]').first().replace(c._getResultRow(e.item,!1));c._highlightSelectedRow($$('[item_id="'+e.item.id+'"]').first().down(".glyphicon.glyphicon-trash"))}catch(g){c.showModalBox('<span class="text-danger">ERROR</span>',g,!0)}}})},getResults:function(a,c){var b,e,d,f,g;b=this;e=a||!1;d=$(b.resultDivId);!0===e&&(b._pagination.pageNo=1);b._pagination.pageSize=c||b._pagination.pageSize;
b.postAjax(b.getCallbackId("getItems"),{pagination:b._pagination,searchCriteria:b._searchCriteria},{onLoading:function(){jQuery("#"+b.searchDivId+" #searchBtn").button("loading");!0===e&&d.update((new Element("tr")).update((new Element("td")).update(b.getLoadingImg())))},onSuccess:function(a,c){try{if(f=b.getResp(c,!1,!0))$(b.totalNoOfItemsId).update(f.pageStats.totalRows),!0===e&&(d.update(b._getResultRow(b._getTitleRowData(),!0).wrap(new Element("thead"))),f.items&&0!==f.items.size()||d.insert({bottom:b.getAlertBox("Nothing found.",
"").addClassName("alert-warning")})),d.getElementsBySelector(".paginWrapper").each(function(a){a.remove()}),(g=$(d).down("tbody"))||$(d).insert({bottom:g=new Element("tbody")}),f.items.each(function(a){g.insert({bottom:b._getResultRow(a).addClassName("item_row").writeAttribute("item_id",a.id)})}),f.pageStats.pageNumber<f.pageStats.totalPages&&d.insert({bottom:b._getNextPageBtn().addClassName("paginWrapper")}),jQuery(".total-value").html(b.getCurrency(f.totalValue)),jQuery(".total-paid").html(b.getCurrency(f.totalPaid))}catch(h){d.insert({bottom:b.getAlertBox("Error",
h).addClassName("alert-danger")})}},onComplete:function(){jQuery("#"+b.searchDivId+" #searchBtn").button("reset")}})},init:function(a,c){this._order&&jQuery.isNumeric(this._order.id)&&$F($$('[search_field="ord.orderNo"]').first()).empty()?(jQuery("#"+this.searchDivId).find("#searchDiv").hide().end().find(".new-btn").hide(),$$('[search_field="ord.orderNo"]').first().value=this._order.orderNo,$("searchBtn").click()):this.getResults(a,c);return this}});