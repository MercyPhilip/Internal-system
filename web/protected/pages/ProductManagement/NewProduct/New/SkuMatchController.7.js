var PageJs=new Class.create;PageJs.prototype=Object.extend(new BPCPageJs,{id_wrapper:"",_acceptableTypes:["csv"],csvFileLineFormat:[],_fileReader:null,_uploadedData:{},_importDataTypes:{},_rowNo:null,_selectTypeTxt:"Select a Import Type",load:function(e){var t={};return t.me=this,t.me._rowNo=1,t.me._importDataTypes=e,$(t.me.getHTMLID("importerDiv")).update("test"),window.File&&window.FileReader&&window.FileList&&window.Blob?(t.me._fileReader=new FileReader,$(t.me.getHTMLID("importerDiv")).update(t.me._getFileUploadDiv()),t.me._loadChosen()):$(t.me.getHTMLID("importerDiv")).update(t.me.getAlertBox("Warning:","Your browser does NOT support this feature. pls change and try again").addClassName("alert-warning")),t.me},_loadTierLevels:function(e){return this.tierLevels=e,{}.me=this,this},_genTemplate:function(){var e={};return e.me=this,(e.me.type=e.me._getUploadType())&&(e.data=[],e.data.push(e.me.csvFileLineFormat.join(", ")+"\n"),e.now=new Date,e.fileName=e.me.type+"_"+e.now.getFullYear()+"_"+e.now.getMonth()+"_"+e.now.getDate()+"_"+e.now.getHours()+"_"+e.now.getMinutes()+"_"+e.now.getSeconds()+".csv",e.blob=new Blob(e.data,{type:"text/csv;charset=utf-8"}),saveAs(e.blob,e.fileName)),e.me},_loadChosen:function(){return jQuery(".chosen").chosen({search_contains:!0,inherit_select_classes:!0,no_results_text:"No code type found!",width:"250px"}),this},_getFileUploadDiv:function(){var e={};return e.me=this,e.newDiv=new Element("div",{class:"panel panel-default drop_file_div",title:"You can drag files here!"}).insert({bottom:new Element("div",{class:"panel-body"}).insert({bottom:new Element("div",{class:"pull-right"}).insert({bottom:e.dropdown=new Element("select",{class:"chosen","data-placeholder":"Code Type: ",id:e.me.getHTMLID("importDataTypesDropdownId")}).insert({bottom:new Element("option",{value:e.me._selectTypeTxt}).update(e.me._selectTypeTxt)})}).insert({bottom:new Element("span",{class:"btn btn-default btn-xs",title:"Download Template"}).insert({bottom:new Element("span",{class:"glyphicon glyphicon-download-alt"})}).observe("click",function(){e.me._genTemplate()})})}).insert({bottom:new Element("div",{class:"form-group center-block text-left",style:"width: 50%"}).insert({bottom:new Element("label").update("Drop you files here or select your file below:")}).insert({bottom:e.inputFile=new Element("input",{type:"file",accept:".csv",style:"display: none;"}).observe("change",function(t){e.me._readFiles(t.target.files)})}).insert({bottom:new Element("div",{class:"clearfix"})}).insert({bottom:new Element("span",{class:"btn btn-success clearfix"}).update("Click to select your file").observe("click",function(t){e.me._getUploadType()&&e.inputFile.click()})}).insert({bottom:new Element("div",{class:"clearfix"})}).insert({bottom:new Element("small").update("ONLY ACCEPT file formats: "+e.me._acceptableTypes.join(", "))})})}).observe("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}).observe("drop",function(t){e.me._getUploadType()&&(t.stopPropagation(),t.preventDefault(),e.me._readFiles(t.dataTransfer.files))}),$H(e.me._importDataTypes).each(function(t){e.dropdown.insert({bottom:new Element("option",{value:t.key}).store("data",t.key).update(t.value)})}),e.newDiv},_getUploadType:function(){var e={};if(e.me=this,e.me.dropdown=$(e.me.getHTMLID("importDataTypesDropdownId")),e.me._importDataTypes=$F(e.me.dropdown),e.me._importDataTypes===e.me._selectTypeTxt)return e.me.showModalBox("Please select a import type first","Invalid inport type"),!1;switch(e.me._importDataTypes){case"new_product":case"update_product":e.me.csvFileLineFormat=["sku","name","feature","description","short_description","price","category","stock","brand","supplier","weight","attributeset","image"],e.me.tierLevels.each(function(t){e.me.csvFileLineFormat.push(t)});break;case"update_srp":e.me.csvFileLineFormat=["sku","srp"];break;case"update_buyinprice":e.me.csvFileLineFormat=["sku","buyinprice"];break;default:e.me.csvFileLineFormat=[]}return e.me._importDataTypes},_parseCSV:function(e){for(var t=[],n=!1,o=col=c=0;c<e.length;c++){var a=e[c],s=e[c+1];t[o]=t[o]||[],t[o][col]=t[o][col]||"",'"'==a&&n&&'"'==s?(t[o][col]+=a,++c):'"'!=a?","!=a||n?"\n"!=a||n?t[o][col]+=a:(++o,col=0):++col:n=!n}return t},_readFiles:function(e){var t={};for(t.me=this,t.me._uploadedData={},t.header=[],t.fileLists=new Element("div",{class:"list-group"}),t.i=0,t.file;t.file=e[t.i];t.i++)t.fileRow=new Element("div",{class:"row"}).update(new Element("div",{class:"col-lg-6 col-md-6"}).update(t.file.name)),""!==(t.extension=t.file.name.split(".").pop())&&t.me._acceptableTypes.indexOf(t.extension.toLowerCase())>-1?(t.me._fileReader=new FileReader,t.me._fileReader.onload=function(e){var n=t.me._parseCSV(e.target.result);t.me._rowNo=1,n.each(function(e){if(null!==e&&e.length>0&&(t.cols=[],e.each(function(e){null!==(e=e.trim())&&t.cols.push(e)}),t.key=t.cols.join(","),""!=t.key.trim()&&t.key!==t.me.csvFileLineFormat.join(","))){for(t.colArray={},t.me.csvFileLineFormat.each(function(e){t.header.push(e)}),t.me.csvFileLineFormat=t.header,t.j=0;t.j<t.me.csvFileLineFormat.size();t.j++)t.colArray[t.me.csvFileLineFormat[t.j]]=t.cols[t.j];t.colArray.index=t.me._rowNo++,t.me._uploadedData[t.key]=t.colArray}})},t.me._fileReader.readAsText(t.file),t.supported=!0):(t.fileRow.insert({bottom:new Element("div",{class:"col-lg-6 col-md-6"}).update(new Element("small").update("Not supported file extension: "+t.extension))}),t.supported=!1),t.fileLists.insert({bottom:new Element("div",{class:"list-group-item "+(!0===t.supported?"list-group-item-success":"list-group-item-danger")}).insert({bottom:t.fileRow})});return $(t.me.getHTMLID("importerDiv")).update(new Element("div",{class:"panel panel-default"}).insert({bottom:new Element("div",{class:"panel-heading"}).update("Files Selected:").insert({bottom:new Element("small",{class:"pull-right"}).update("ONLY ACCEPT file formats: "+t.me._acceptableTypes.join(", "))})}).insert({bottom:t.fileLists}).insert({bottom:new Element("div",{class:"panel-footer"}).insert({bottom:new Element("span",{class:"btn btn-success"}).update("Start").observe("click",function(){t.me._loadProductLineItems()})}).insert({bottom:new Element("span",{class:"btn btn-warning pull-right"}).update("Cancel").observe("click",function(){jQuery(".btn").attr("disabled","disabled"),window.location=document.URL})})})),t.me},_openDetailPage:function(e,t){var n={};return n.me=this,n.newWindow=window.open(e,e+" details","width=1300, location=no, scrollbars=yes, menubar=no, status=no, titlebar=no, fullscreen=no, toolbar=no"),n.newWindow.focus(),n.me},_getProductLineItem:function(e,t,n){var o={};return o.me=this,o.data=o.me._uploadedData[n[t]],o.newRow=new Element("tr",{class:"result_row info"}),o.me.csvFileLineFormat.each(function(e){$H(o.data).each(function(t){t.key===e&&"description"!=t.key&&"feature"!=t.key&&o.newRow.insert({bottom:new Element("th",{style:t.value?"":"color:red;"}).insert({bottom:new Element("div",{style:"max-width:100px;display:inline-block;word-break: break-all; word-wrap: break-word;"}).update(t.value?t.value:"Blank "+e)})})})}),o.data.importDataTypes=o.me._importDataTypes,o.me.postAjax(o.me.getCallbackId("getAllCodeForProduct"),o.data,{onLoading:function(t,n){e.insert({bottom:o.newRow})},onSuccess:function(t,n){try{if(o.result=o.me.getResp(n,!1,!0),!o.result||!o.result.item||!o.result.item.id)return void o.newRow.update("");o.newRow.removeClassName("info").addClassName("result-done").store("data",o.result.item).insert({bottom:new Element("td",{colspan:2}).insert({bottom:new Element("div",{style:"max-width:100px;display:inline-block;word-break: break-all; word-wrap: break-word;"}).update("<strong>"+(o.result.item.product?"CREATED":"UPDATED")+"</strong>")})}),o.result.path&&o.newRow.down("div").setStyle({cursor:"pointer","text-decoration":"underline"}).observe("click",function(){o.me._openDetailPage(o.result.path,o.result.item.id)})}catch(t){o.newRow.removeClassName("info").addClassName("danger").store("data",o.data).insert({bottom:new Element("td",{colspan:2}).insert({bottom:new Element("div",{style:"max-width:100px;display:inline-block;word-break: break-all; word-wrap: break-word;"}).update("<strong>ERROR:</strong>"+t)})}),e.insert({top:o.newRow})}},onComplete:function(a,s){try{o.nextDataKeyIndex=1*t+1,o.nextDataKeyIndex>=n.size()?(o.errRows=$(o.me.getHTMLID("importerDiv")).getElementsBySelector(".result_row.danger"),e.up(".panel").removeClassName("panel-danger").addClassName(o.errRows.size()>0?"panel-warning":"panel-success").down(".panel-heading").update("").insert({bottom:new Element("panel-title").update(o.errRows.size()>0?"All provided rows have been proccessed, but with "+o.errRows.size()+" error(s)":"All provided rows have been proccessed successfully")}).insert({bottom:new Element("span",{class:"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{class:"btn btn-default"}).writeAttribute("title","Start Again").update(new Element("span",{class:"glyphicon glyphicon-repeat"})).observe("click",function(){window.location=document.URL})})})):o.me._getProductLineItem(e,o.nextDataKeyIndex,n)}catch(e){alert(e)}}}),o.me},_loadProductLineItems:function(){var e={};return e.me=this,e.keys=[],$H(e.me._uploadedData).each(function(t){e.keys.push(t.key)}),e.theadRow=new Element("tr"),e.me.csvFileLineFormat.each(function(t){"description"!=t&&"feature"!=t&&e.theadRow.insert({bottom:new Element("th").update(t)})}),$(e.me.getHTMLID("importerDiv")).update(new Element("div",{class:"price_search_result panel panel-danger table-responsive"}).insert({bottom:new Element("div",{class:"panel-heading"}).update("Total of <strong>"+e.keys.size()+"</strong> unique row(s) received:").insert({bottom:new Element("strong",{class:"pull-right"}).update("please waiting for it to finish")})}).insert({bottom:new Element("table",{class:"table table-striped","table-layout":"fixed"}).insert({bottom:new Element("thead").update(e.theadRow)}).insert({bottom:e.resultList=new Element("tbody")})})),0==e.keys.size()?(e.resultList.up(".panel").removeClassName("panel-danger").addClassName("panel-success").down(".panel-heading").update("Total of <strong>"+e.keys.size()+"</strong> unique row(s) received:").insert({bottom:new Element("span",{class:"btn-group btn-group-sm pull-right"}).insert({bottom:new Element("span",{class:"btn btn-default"}).writeAttribute("title","Start Again").update(new Element("span",{class:"glyphicon glyphicon-repeat"})).observe("click",function(){window.location=document.URL})})}),e.me):(e.me._getProductLineItem(e.resultList,0,e.keys),e.me)}});