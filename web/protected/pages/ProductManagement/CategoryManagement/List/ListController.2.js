var PageJs=new Class.create;
PageJs.prototype=Object.extend(new CRUDPageJs,{manufactures:[],suppliers:[],productCategories:[],productStatuses:[],_nextPageColSpan:9,_autoLoading:!1,_getTitleRowData:function(){return{sku:"SKU",name:"Product Name",shortDesc:"Short Description",manufacturer:{name:"Brand"},supplierCodes:[{supplier:{name:"Supplier"},code:""}],stockOnHand:"SOH"}},_loadManufactures:function(a){this.manufactures=a;var b;b=$(this.searchDivId).down('[search_field="pro.manufacturerIds"]');this.manufactures.each(function(a){b.insert({bottom:(new Element("option",{value:a.id})).update(a.name)})});
return this},_loadProductStatuses:function(a){this.productStatuses=a;var b;b=$(this.searchDivId).down('[search_field="pro.productStatusIds"]');this.productStatuses.each(function(a){b.insert({bottom:(new Element("option",{value:a.id})).update(a.name)})});return this},_loadSuppliers:function(a){this.suppliers=a;var b;b=$(this.searchDivId).down('[search_field="pro.supplierIds"]');this.suppliers.each(function(a){b.insert({bottom:(new Element("option",{value:a.id})).update(a.name)})});return this},_loadCategories:function(a){this.categories=
a;var b;b=$(this.searchDivId).down('[search_field="pro.productCategoryIds"]');this.categories.sort(function(a,b){return a.namePath>b.namePath}).each(function(a){b.insert({bottom:(new Element("option",{value:a.id})).update(a.namePath)})});return this},_loadChosen:function(){jQuery(".chosen").select2({minimumResultsForSearch:Infinity});return this},_bindSearchKey:function(){var a;a=this;$$("#searchBtn").first().observe("click",function(b){a.deSelectProduct();a.getSearchCriteria().getResults(!0,a._pagination.pageSize)});
$("searchDiv").getElementsBySelector("[search_field]").each(function(b){b.observe("keydown",function(b){a.keydown(b,function(){$(a.searchDivId).down("#searchBtn").click()})})});return this},_bindExcelKey:function(){var a;a=this;$$("#excelBtn").first().observe("click",function(b){a.getSearchCriteria().genReport(!0)});return this},_getSupplierCodes:function(a,b){var c;c=[];a.each(function(a){c.push(!0===b?"Supplier":'<abbr title="Code: '+a.code+'">'+(a.supplier&&a.supplier.name?a.supplier.name:"")+
"</abbr>")});return c.join(", ")},getResults:function(a,b,c,e){var d,f,g,h,k,l;d=this;f=a||!1;g=c||!1;h=$(d.resultDivId);!0===f&&(d._pagination.pageNo=1);!0===g&&0<$$(".btn-show-more").length&&(d._autoLoading=!0,d._pagination.pageNo=1*d._pagination.pageNo+1);d._pagination.pageSize=b||d._pagination.pageSize;d.postAjax(d.getCallbackId("getItems"),{pagination:d._pagination,searchCriteria:d._searchCriteria},{onLoading:function(){jQuery("#"+d.searchDivId+" .btn").button("loading");jQuery("#"+d.searchDivId+
" input").prop("disabled",!0);jQuery("#"+d.searchDivId+" select").prop("disabled",!0);!0===f&&h.update((new Element("tr")).update((new Element("td")).update(d.getLoadingImg())))},onSuccess:function(a,b){try{if(k=d.getResp(b,!1,!0))$(d.totalNoOfItemsId).update(k.pageStats.totalRows),!0===f&&h.update(d._getResultRow(d._getTitleRowData(),!0).wrap(new Element("thead"))),h.getElementsBySelector(".paginWrapper").each(function(a){a.remove()}),(l=$(h).down("tbody"))||$(h).insert({bottom:l=new Element("tbody")}),
k.items.each(function(a){l.insert({bottom:d._getResultRow(a).addClassName("item_row").writeAttribute("item_id",a.id)})}),!0!==d._singleProduct&&k.pageStats.pageNumber<k.pageStats.totalPages&&h.insert({bottom:d._getNextPageBtn().addClassName("paginWrapper")}),d._bindPriceInput(),!0===g&&0<$$(".btn-show-more").length?d.getResults(!1,d._pagination.pageSize,!0):(d._autoLoading=!1,d.hideModalBox(),jQuery("#"+d.searchDivId+" .btn").button("reset"),jQuery("#"+d.searchDivId+" input").prop("disabled",!1),
jQuery("#"+d.searchDivId+" select").prop("disabled",!1))}catch(c){h.insert({bottom:d.getAlertBox("Error",c).addClassName("alert-danger")})}},onComplete:function(){!0!==g&&(jQuery("#"+d.searchDivId+" .btn").button("reset"),jQuery("#"+d.searchDivId+" input").prop("disabled",!1),jQuery("#"+d.searchDivId+" select").prop("disabled",!1))}})},_updateStockLevel:function(a,b,c,e){var d,f,g;d=this;"stockMinLevel"!==e&&"stockReorderLevel"!==e&&d.showModalBox("Error","Invalid type passin to updateStockLevel");
d.postAjax(d.getCallbackId("updateStockLevel"),{productId:a,newValue:b,type:e},{onLoading:function(){},onSuccess:function(h,k){try{(f=d.getResp(k,!1,!0))&&f.item&&f.item.id&&(jQuery("."+e+"-input[product-id="+f.item.id+"]").attr("original-"+e,b),g=$(d.resultDivId).down(".product_item[product_id="+f.item.id+"]"))&&(d.deSelectProduct(),g.replace(d._getResultRow(f.item,!1)),d._bindPriceInput())}catch(l){d.showModalBox('<strong class="text-danger">Error When Update '+e+":</strong>","<strong>"+l+"</strong>"),
jQuery("."+e+"-input[product-id="+a+"]").val(c)}}});return d},_updatePrice:function(a,b,c){var e,d,f;e=this;e.postAjax(e.getCallbackId("updateSellingPrice"),{productId:a,newPrice:e.getValueFromCurrency(b)},{onLoading:function(){},onSuccess:function(g,h){try{(d=e.getResp(h,!1,!0))&&d.item&&d.item.id&&(jQuery(".price-input[product-id="+d.item.id+"]").attr("original-price",e.getValueFromCurrency(b)),f=$(e.resultDivId).down(".product_item[product_id="+d.item.id+"]"))&&(e.deSelectProduct(),f.replace(e._getResultRow(d.item,
!1)),e._bindPriceInput())}catch(k){e.showModalBox('<strong class="text-danger">Error When Update Price:</strong>',"<strong>"+k+"</strong>"),jQuery(".price-input[product-id="+a+"]").val(e.getCurrency(c))}}});return e},_bindPriceInput:function(){var a,b,c;a=this;jQuery(".stockMinLevel-input[product-id]").not(".stockMinLevel-input-binded").click(function(){jQuery(this).attr("original-stockMinLevel",jQuery(this).val()).select()}).keydown(function(c){b=jQuery(this);a.keydown(c,function(){b.blur()})}).focusout(function(){c=
jQuery(this).val();jQuery(this).val(c)}).change(function(){a._updateStockLevel(jQuery(this).attr("product-id"),jQuery(this).val(),jQuery(this).attr("original-stockMinLevel"),"stockMinLevel")}).addClass("stockMinLevel-input-binded");jQuery('.price-input[product-id]:not(".price-input-binded")').click(function(){jQuery(this).attr("original-price",a.getValueFromCurrency(jQuery(this).val())).select()}).keydown(function(c){b=jQuery(this);a.keydown(c,function(){b.blur()})}).focusout(function(){c=a.getValueFromCurrency(jQuery(this).val());
jQuery(this).val(a.getCurrency(c))}).change(function(){a._updatePrice(jQuery(this).attr("product-id"),jQuery(this).val(),a.getValueFromCurrency(jQuery(this).attr("original-price")))}).addClass("price-input-binded");return a},_getNextPageBtn:function(){var a,b;a=this;b=$("total-found-count").innerHTML;return(new Element("tfoot")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("td",{colspan:a._nextPageColSpan,"class":"text-center"})).insert({bottom:(new Element("span",{"class":"btn btn-primary btn-show-more",
"data-loading-text":"Fetching more results ..."})).update("Next Page").observe("click",function(){a._pagination.pageNo=1*a._pagination.pageNo+1;jQuery(this).button("loading");a.deSelectProduct();a.getResults(!1,a._pagination.pageSize,!1,!0)})}).insert({bottom:(new Element("span",{"class":"btn btn-warning btn-show-more","data-loading-text":"Fetching more results ..."})).update("<b>Show ALL Pages</b>").setStyle("margin-left: 10px; color: black;").observe("click",function(){1E3<b?a.showModalBox("Warning",
"<h3>There are "+b+" products for current search conditions. <br/>Please narrow down the search"):(a.deSelectProduct(),a.getResults(!1,a._pagination.pageSize,!0))})})})})},_getResultRow:function(a,b){var c={me:this};c.tag=!0===c.isTitle?"th":"td";c.isTitle=b||!1;c.price=0;a.prices&&a.prices.each(function(a){a.type&&1===parseInt(a.type.id)&&(c.price=a.price,c.updatedDate=a.updated)});0!=a.totalOnHandValue&&0!=a.stockOnHand&&0!=c.price?(c.avgcost=a.totalOnHandValue/a.stockOnHand,c.margin=((c.price-
c.avgcost)/c.price*100).toFixed(2)+"%",c.avgcost=c.me.getCurrency(c.avgcost)):(c.avgcost="N/A",c.margin="");c.row=(new Element("tr",{"class":"visible-xs visible-md visible-lg visible-sm "+(!0===c.isTitle?"":"product_item "),product_id:a.id})).store("data",a).insert({bottom:(new Element(c.tag,{"class":"sku",title:a.name})).addClassName("col-xs-1").insert({bottom:!0===c.isTitle?a.sku:(new Element("a",{href:"javascript: void(0);","class":"sku-link truncate"})).observe("click",function(b){Event.stop(b);
c.me._displaySelectedProduct(a)}).update(a.sku)})}).insert({bottom:(new Element(c.tag,{"class":"product_name hidden-xs hide-when-info hidden-sm"})).addClassName("col-xs-2").insert({bottom:a.name})}).insert({bottom:(new Element(c.tag,{"class":"manufacturer ",style:"width:5%"})).addClassName("col-xs-1").update(a.manufacturer?a.manufacturer.name:"")}).insert({bottom:(new Element(c.tag,{"class":"supplier  hidden-sm",style:"width:5%"})).addClassName("col-xs-1").update(a.supplierCodes?c.me._getSupplierCodes(a.supplierCodes,
b):"")}).insert({bottom:(new Element(c.tag,{"class":"hidden-xs  hidden-sm row"})).addClassName("col-xs-3").insert({bottom:(new Element("div",{"class":"col-sm-4"})).update(!0===c.isTitle?"Last Buy Price":c.me.getCurrency(a.lastbuyprice))}).insert({bottom:(new Element("div",{"class":"col-sm-4"})).update(!0===c.isTitle?"Last Reveived Date":a.lastrecdate)}).insert({bottom:(new Element("div",{"class":"col-sm-4"})).update(!0===c.isTitle?"Mini Stock Level":(new Element("input",{"class":"click-to-edit stockMinLevel-input",
value:a.stockMinLevel,"product-id":a.id})).setStyle("width: 80%"))})}).insert({bottom:(new Element(c.tag,{"class":"qty hidden-sm"})).addClassName("col-xs-3").update(!0===c.isTitle?(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-3",title:"Stock on Hand"})).update("SH")}).insert({bottom:(new Element("div",{"class":"col-xs-3 ",title:"Average Cost"})).update("Average Cost")}).insert({bottom:(new Element("div",{"class":"col-xs-3 ",title:"Price"})).update("Selling Price")}).insert({bottom:(new Element("div",
{"class":"col-xs-3 ",title:"Margin"})).update("Margin")}):(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-3",title:"Stock on Hand"})).update(a.stockOnHand)}).insert({bottom:(new Element("div",{"class":"col-xs-3 ",title:"totalOnHandValue is "+a.totalOnHandValue})).update(c.avgcost)}).insert({bottom:(new Element("div",{"class":"col-xs-3 "})).update((new Element("input",{"class":"click-to-edit price-input","product-id":a.id,value:c.me.getCurrency(c.price)})).setStyle("width: 80%"))}).insert({bottom:(new Element("div",
{"class":"col-xs-3 ",title:"Margin"})).update((new Element("div",{"class":"margin"})).update(c.margin))}))}).insert({bottom:(new Element(c.tag,{"class":"runrate hidden-sm"})).addClassName("col-xs-1").update(!0===c.isTitle?(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-4 hide-when-info",title:"Run rate of 7 days"})).update("1W")}).insert({bottom:(new Element("div",{"class":"col-xs-4 hide-when-info",title:"Run rate of 14 days"})).update("2W")}).insert({bottom:(new Element("div",
{"class":"col-xs-4 hide-when-info",title:"Run rate of 1 month"})).update("1M")}):(new Element("div",{"class":"row"})).insert({bottom:(new Element("div",{"class":"col-xs-4 hide-when-info",title:"Run rate of 7 days"})).update(a.ow)}).insert({bottom:(new Element("div",{"class":"col-xs-4 hide-when-info",title:"Run rate of 14 days"})).update(a.tw)}).insert({bottom:(new Element("div",{"class":"col-xs-4 hide-when-info",title:"Run rate of 1 month"})).update(a.om)}))});return c.row},deSelectProduct:function(){jQuery(".product_item.success",
jQuery("#"+this.resultDivId)).removeClass("success").popover("hide");$(this.resultDivId).up(".list-panel").removeClassName("col-xs-9").addClassName("col-xs-12");jQuery(".hide-when-info",jQuery("#"+this.resultDivId)).show();this._showRightPanel=!1;return this},_displaySelectedProduct:function(a){var b,c;b=this;$(b.resultDivId).up(".list-panel").removeClassName("col-xs-12").addClassName("col-xs-9");jQuery(".hide-when-info",jQuery("#"+b.resultDivId)).hide();b._showRightPanel=!0;jQuery(".product_item.success",
jQuery("#"+b.resultDivId)).removeClass("success").popover("hide");c=jQuery('[product_id="'+a.id+'"]',jQuery("#"+b.resultDivId)).addClass("success");c.hasClass("popover-loaded")||c.on("shown.bs.popover",function(c){b._getPriceMatchCompanySelect2(jQuery('.rightPanel[match_rule="company_id"]'),null,a)}).popover({title:'<div class="row"><div class="col-xs-10">Details for: '+a.sku+'</div><div class="col-xs-2"><div class="btn-group pull-right"><span class="btn btn-danger btn-sm" onclick="pageJs.deSelectProduct();"><span class="glyphicon glyphicon-remove"></span></span></div></div></div>',
html:!0,placement:"right",container:"body",trigger:"manual",viewport:{selector:".list-panel",padding:0},content:function(){return b._showProductInfoOnRightPanel(a).wrap(new Element("div")).innerHTML},template:'<div class="popover" role="tooltip" style="max-width: none; z-index: 0;"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}).addClass("popover-loaded");c.popover("show");return b},_getPriceMatchCompanySelect2:function(a,b){var c,e,d,f;c=this;
e=b||null;d=jQuery(a).select2({ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(a){return{searchTxt:"companyName like ?",searchParams:["%"+a+"%"],entityName:"PriceMatchCompany"}},results:function(a,b,d){f=[];a.resultData&&a.resultData.items&&a.resultData.items.each(function(a){!1===c._checkUniquePriceMatchCompanies(f,a)&&f.push({id:a.id,text:a.companyName,data:a})});return{results:f}}},cache:!0,escapeMarkup:function(a){return a}});null!==e&&e.priceMatchRule&&e.priceMatchRule.id&&e.priceMatchRule.priceMatchCompany&&
e.priceMatchRule.priceMatchCompany.id&&d.select2("data",{id:e.priceMatchRule.priceMatchCompany.id,text:e.priceMatchRule.priceMatchCompany.companyName,data:e.priceMatchRule.priceMatchCompany});return d},_showProductInfoOnRightPanel:function(a){var b,c,e;b=this;c=b._getInfoPanel(a);b.postAjax(b.getCallbackId("priceMatching"),{id:a.id},{onLoading:function(){c.down(".price-match-div .price-match-listing").replace((new Element("div",{"class":"panel-body price-match-listing"})).update(b.getLoadingImg()))},
onSuccess:function(c,f){try{(e=b.getResp(f,!1,!0))&&$("info_panel_"+a.id)&&$("info_panel_"+a.id).down(".price-match-div .price-match-listing").replace(b._displayPriceMatchResult(e,a))}catch(g){b.showModalBox("Error",g,!0)}}});return c},_displayPriceMatchResult:function(a,b){var c,e,d,f,g;c=this;e=0;d=new Element("tbody");$H(a.companyPrices).each(function(a){0!==parseInt(a.value.price)&&(0===parseInt(e)&&0<parseFloat(a.value.price)||parseFloat(a.value.price)<parseFloat(e))&&(e=a.value.price);d.insert({bottom:(new Element("tr")).insert({bottom:(new Element("td",
{colspan:3})).update(a.key).addClassName(b.priceMatchRule&&a.key===b.priceMatchRule.priceMatchCompany.companyName?"success":"")}).insert({bottom:(new Element("td")).update(a.value.priceURL&&!a.value.priceURL.blank()?(new Element("a",{href:a.value.priceURL,target:"__blank"})).update(c.getCurrency(a.value.price)):c.getCurrency(a.value.price))})})});f=parseFloat(a.myPrice)-parseFloat(e);g="";0!==parseInt(e)&&(0<parseInt(f)?g="label label-danger":0>parseInt(f)&&(g="label label-success"));return(new Element("table",
{"class":"table table-striped table-hover price-match-listing"})).insert({bottom:(new Element("thead")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("th")).update("SKU")}).insert({bottom:(new Element("th")).update("My Price")}).insert({bottom:(new Element("th",{"class":"price_diff"})).update("Price Diff.")}).insert({bottom:(new Element("th")).update("Min Price")})})}).insert({bottom:(new Element("tbody")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("td")).update(a.sku)}).insert({bottom:(new Element("td")).update(c.getCurrency(a.myPrice))}).insert({bottom:(new Element("td",
{"class":"price_diff"})).update((new Element("span",{"class":""+g})).update(c.getCurrency(f)))}).insert({bottom:(new Element("td",{"class":"price_min"})).update(c.getCurrency(e))})})}).insert({bottom:(new Element("thead")).insert({bottom:(new Element("tr")).insert({bottom:(new Element("th",{colspan:3})).update("Company")}).insert({bottom:(new Element("th")).update("Price")})})}).insert({bottom:d})},_getInfoPanel:function(a){return(new Element("div",{id:"info_panel_"+a.id})).insert({bottom:(new Element("div",
{"class":"col-xs-12"})).insert({bottom:(new Element("div",{"class":"panel panel-default price-match-div"})).insert({bottom:(new Element("div",{"class":"panel-heading"})).update("<strong>Price Match</strong>")}).insert({bottom:(new Element("div",{"class":"panel-body price-match-listing"})).update(this.getLoadingImg())})})})},_bindDatePicker:function(a){var b;b=this;etaCtl=a.down(".datepicker");b._signRandID(etaCtl);jQuery("#"+etaCtl.id).datetimepicker({format:"YYYY-MM-DD",useCurrent:!1});(a=jQuery("#"+
etaCtl.id).attr("value"))&&jQuery("#"+etaCtl.id).data("DateTimePicker").date(new Date(a));jQuery("#"+etaCtl.id).on("dp.change",function(a){var e=a.date?a.date.format("YYYY-MM-DD"):"";a=a.oldDate?a.oldDate.format("YYYY-MM-DD"):"";var d=jQuery(this).attr("poId");d?b._updateETA(jQuery(this).attr("product-id"),d,e,a):jQuery(this).val("").datetimepicker("update")});return b},genReport:function(a){var b={me:this};b.resultDiv=$(b.me.resultDivId);b.me.postAjax(b.me.getCallbackId("genReport"),{searchCriteria:b.me._searchCriteria},
{onLoading:function(){jQuery("#"+b.me.searchDivId+" .btn").button("loading");jQuery("#"+b.me.searchDivId+" input").prop("disabled",!0);jQuery("#"+b.me.searchDivId+" select").prop("disabled",!0);!0===b.reset&&b.resultDiv.update((new Element("tr")).update((new Element("td")).update(b.me.getLoadingImg())))},onSuccess:function(a,e){try{if(b.result=b.me.getResp(e,!1,!0),b.result&&b.result.url&&(b.newWind=window.open(b.result.url),!b.newWind))throw'You browser is blocking the popup window, please click <a class="btn btn-xs btn-primary" href="'+
b.result.url+'" target="__BLANK">here</a> to open it manually.';}catch(d){b.resultDiv.insert({bottom:b.me.getAlertBox("Error",d).addClassName("alert-danger")})}},onComplete:function(){!0!==b.auto&&(jQuery("#"+b.me.searchDivId+" .btn").button("reset"),jQuery("#"+b.me.searchDivId+" input").prop("disabled",!1),jQuery("#"+b.me.searchDivId+" select").prop("disabled",!1))}});return b.me}});